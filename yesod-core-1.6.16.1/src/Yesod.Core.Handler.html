<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts           #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ConstraintKinds            #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances          #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE FunctionalDependencies     #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings          #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE QuasiQuotes                #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards            #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE TupleSections              #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies               #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes                 #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE DeriveDataTypeable         #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables        #-}</span><span>
</span><a name="line-13"></a><span class="hs-comment">---------------------------------------------------------</span><span>
</span><a name="line-14"></a><span class="hs-comment">--</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- Module        : Yesod.Handler</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- Copyright     : Michael Snoyman</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- License       : BSD3</span><span>
</span><a name="line-18"></a><span class="hs-comment">--</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- Maintainer    : Michael Snoyman &lt;michael@snoyman.com&gt;</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- Stability     : stable</span><span>
</span><a name="line-21"></a><span class="hs-comment">-- Portability   : portable</span><span>
</span><a name="line-22"></a><span class="hs-comment">--</span><span>
</span><a name="line-23"></a><span class="hs-comment">-- Define Handler stuff.</span><span>
</span><a name="line-24"></a><span class="hs-comment">--</span><span>
</span><a name="line-25"></a><span class="hs-comment">---------------------------------------------------------</span><span>
</span><a name="line-26"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Yesod.Core.Handler</span><span>
</span><a name="line-27"></a><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-comment">-- * Handler monad</span><span>
</span><a name="line-28"></a><span>      </span><a href="Yesod.Core.Handler.html#HandlerT"><span class="hs-identifier hs-type">HandlerT</span></a><span>
</span><a name="line-29"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-type">HandlerFor</span></a><span>
</span><a name="line-30"></a><span>      </span><span class="hs-comment">-- ** Read information from handler</span><span>
</span><a name="line-31"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getYesod"><span class="hs-identifier hs-var">getYesod</span></a><span>
</span><a name="line-32"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getsYesod"><span class="hs-identifier hs-var">getsYesod</span></a><span>
</span><a name="line-33"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getUrlRender"><span class="hs-identifier hs-var">getUrlRender</span></a><span>
</span><a name="line-34"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getUrlRenderParams"><span class="hs-identifier hs-var">getUrlRenderParams</span></a><span>
</span><a name="line-35"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getPostParams"><span class="hs-identifier hs-var">getPostParams</span></a><span>
</span><a name="line-36"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getCurrentRoute"><span class="hs-identifier hs-var">getCurrentRoute</span></a><span>
</span><a name="line-37"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getRequest"><span class="hs-identifier hs-var">getRequest</span></a><span>
</span><a name="line-38"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#waiRequest"><span class="hs-identifier hs-var">waiRequest</span></a><span>
</span><a name="line-39"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#runRequestBody"><span class="hs-identifier hs-var">runRequestBody</span></a><span>
</span><a name="line-40"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#rawRequestBody"><span class="hs-identifier hs-var">rawRequestBody</span></a><span>
</span><a name="line-41"></a><span>      </span><span class="hs-comment">-- ** Request information</span><span>
</span><a name="line-42"></a><span>      </span><span class="hs-comment">-- *** Request datatype</span><span>
</span><a name="line-43"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Types.html#RequestBodyContents"><span class="hs-identifier hs-type">RequestBodyContents</span></a><span>
</span><a name="line-44"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Types.html#YesodRequest"><span class="hs-identifier hs-type">YesodRequest</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Types.html#FileInfo"><span class="hs-identifier hs-type">FileInfo</span></a><span>
</span><a name="line-46"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Types.html#fileName"><span class="hs-identifier hs-var">fileName</span></a><span>
</span><a name="line-47"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Types.html#fileContentType"><span class="hs-identifier hs-var">fileContentType</span></a><span>
</span><a name="line-48"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#fileSource"><span class="hs-identifier hs-var">fileSource</span></a><span>
</span><a name="line-49"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#fileSourceByteString"><span class="hs-identifier hs-var">fileSourceByteString</span></a><span>
</span><a name="line-50"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Types.html#fileMove"><span class="hs-identifier hs-var">fileMove</span></a><span>
</span><a name="line-51"></a><span>      </span><span class="hs-comment">-- *** Convenience functions</span><span>
</span><a name="line-52"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#languages"><span class="hs-identifier hs-var">languages</span></a><span>
</span><a name="line-53"></a><span>      </span><span class="hs-comment">-- *** Lookup parameters</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupGetParam"><span class="hs-identifier hs-var">lookupGetParam</span></a><span>
</span><a name="line-55"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupPostParam"><span class="hs-identifier hs-var">lookupPostParam</span></a><span>
</span><a name="line-56"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupCookie"><span class="hs-identifier hs-var">lookupCookie</span></a><span>
</span><a name="line-57"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupFile"><span class="hs-identifier hs-var">lookupFile</span></a><span>
</span><a name="line-58"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupHeader"><span class="hs-identifier hs-var">lookupHeader</span></a><span>
</span><a name="line-59"></a><span>      </span><span class="hs-comment">-- **** Lookup authentication data</span><span>
</span><a name="line-60"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupBasicAuth"><span class="hs-identifier hs-var">lookupBasicAuth</span></a><span>
</span><a name="line-61"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupBearerAuth"><span class="hs-identifier hs-var">lookupBearerAuth</span></a><span>
</span><a name="line-62"></a><span>      </span><span class="hs-comment">-- **** Multi-lookup</span><span>
</span><a name="line-63"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupGetParams"><span class="hs-identifier hs-var">lookupGetParams</span></a><span>
</span><a name="line-64"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupPostParams"><span class="hs-identifier hs-var">lookupPostParams</span></a><span>
</span><a name="line-65"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupCookies"><span class="hs-identifier hs-var">lookupCookies</span></a><span>
</span><a name="line-66"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupFiles"><span class="hs-identifier hs-var">lookupFiles</span></a><span>
</span><a name="line-67"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupHeaders"><span class="hs-identifier hs-var">lookupHeaders</span></a><span>
</span><a name="line-68"></a><span>      </span><span class="hs-comment">-- * Responses</span><span>
</span><a name="line-69"></a><span>      </span><span class="hs-comment">-- ** Pure</span><span>
</span><a name="line-70"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#respond"><span class="hs-identifier hs-var">respond</span></a><span>
</span><a name="line-71"></a><span>      </span><span class="hs-comment">-- ** Streaming</span><span>
</span><a name="line-72"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#respondSource"><span class="hs-identifier hs-var">respondSource</span></a><span>
</span><a name="line-73"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendChunk"><span class="hs-identifier hs-var">sendChunk</span></a><span>
</span><a name="line-74"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendFlush"><span class="hs-identifier hs-var">sendFlush</span></a><span>
</span><a name="line-75"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendChunkBS"><span class="hs-identifier hs-var">sendChunkBS</span></a><span>
</span><a name="line-76"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendChunkLBS"><span class="hs-identifier hs-var">sendChunkLBS</span></a><span>
</span><a name="line-77"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendChunkText"><span class="hs-identifier hs-var">sendChunkText</span></a><span>
</span><a name="line-78"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendChunkLazyText"><span class="hs-identifier hs-var">sendChunkLazyText</span></a><span>
</span><a name="line-79"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendChunkHtml"><span class="hs-identifier hs-var">sendChunkHtml</span></a><span>
</span><a name="line-80"></a><span>      </span><span class="hs-comment">-- ** Redirecting</span><span>
</span><a name="line-81"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#redirect"><span class="hs-identifier hs-var">redirect</span></a><span>
</span><a name="line-83"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#redirectWith"><span class="hs-identifier hs-var">redirectWith</span></a><span>
</span><a name="line-84"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#redirectToPost"><span class="hs-identifier hs-var">redirectToPost</span></a><span>
</span><a name="line-85"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#Fragment"><span class="hs-identifier hs-type">Fragment</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>      </span><span class="hs-comment">-- ** Errors</span><span>
</span><a name="line-87"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#notFound"><span class="hs-identifier hs-var">notFound</span></a><span>
</span><a name="line-88"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#badMethod"><span class="hs-identifier hs-var">badMethod</span></a><span>
</span><a name="line-89"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#notAuthenticated"><span class="hs-identifier hs-var">notAuthenticated</span></a><span>
</span><a name="line-90"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#permissionDenied"><span class="hs-identifier hs-var">permissionDenied</span></a><span>
</span><a name="line-91"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#permissionDeniedI"><span class="hs-identifier hs-var">permissionDeniedI</span></a><span>
</span><a name="line-92"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#invalidArgs"><span class="hs-identifier hs-var">invalidArgs</span></a><span>
</span><a name="line-93"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#invalidArgsI"><span class="hs-identifier hs-var">invalidArgsI</span></a><span>
</span><a name="line-94"></a><span>      </span><span class="hs-comment">-- ** Short-circuit responses.</span><span>
</span><a name="line-95"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendFile"><span class="hs-identifier hs-var">sendFile</span></a><span>
</span><a name="line-96"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendFilePart"><span class="hs-identifier hs-var">sendFilePart</span></a><span>
</span><a name="line-97"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendResponse"><span class="hs-identifier hs-var">sendResponse</span></a><span>
</span><a name="line-98"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendResponseStatus"><span class="hs-identifier hs-var">sendResponseStatus</span></a><span>
</span><a name="line-99"></a><span>      </span><span class="hs-comment">-- ** Type specific response with custom status</span><span>
</span><a name="line-100"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendStatusJSON"><span class="hs-identifier hs-var">sendStatusJSON</span></a><span>
</span><a name="line-101"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendResponseCreated"><span class="hs-identifier hs-var">sendResponseCreated</span></a><span>
</span><a name="line-102"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendResponseNoContent"><span class="hs-identifier hs-var">sendResponseNoContent</span></a><span>
</span><a name="line-103"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendWaiResponse"><span class="hs-identifier hs-var">sendWaiResponse</span></a><span>
</span><a name="line-104"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendWaiApplication"><span class="hs-identifier hs-var">sendWaiApplication</span></a><span>
</span><a name="line-105"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendRawResponse"><span class="hs-identifier hs-var">sendRawResponse</span></a><span>
</span><a name="line-106"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#sendRawResponseNoConduit"><span class="hs-identifier hs-var">sendRawResponseNoConduit</span></a><span>
</span><a name="line-107"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#notModified"><span class="hs-identifier hs-var">notModified</span></a><span>
</span><a name="line-108"></a><span>      </span><span class="hs-comment">-- * Different representations</span><span>
</span><a name="line-109"></a><span>      </span><span class="hs-comment">-- $representations</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#selectRep"><span class="hs-identifier hs-var">selectRep</span></a><span>
</span><a name="line-111"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#provideRep"><span class="hs-identifier hs-var">provideRep</span></a><span>
</span><a name="line-112"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#provideRepType"><span class="hs-identifier hs-var">provideRepType</span></a><span>
</span><a name="line-113"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#ProvidedRep"><span class="hs-identifier hs-type">ProvidedRep</span></a><span>
</span><a name="line-114"></a><span>      </span><span class="hs-comment">-- * Setting headers</span><span>
</span><a name="line-115"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setCookie"><span class="hs-identifier hs-var">setCookie</span></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getExpires"><span class="hs-identifier hs-var">getExpires</span></a><span>
</span><a name="line-117"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#deleteCookie"><span class="hs-identifier hs-var">deleteCookie</span></a><span>
</span><a name="line-118"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#addHeader"><span class="hs-identifier hs-var">addHeader</span></a><span>
</span><a name="line-119"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setHeader"><span class="hs-identifier hs-var">setHeader</span></a><span>
</span><a name="line-120"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#replaceOrAddHeader"><span class="hs-identifier hs-var">replaceOrAddHeader</span></a><span>
</span><a name="line-121"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setLanguage"><span class="hs-identifier hs-var">setLanguage</span></a><span>
</span><a name="line-122"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#addContentDispositionFileName"><span class="hs-identifier hs-var">addContentDispositionFileName</span></a><span>
</span><a name="line-123"></a><span>      </span><span class="hs-comment">-- ** Content caching and expiration</span><span>
</span><a name="line-124"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#cacheSeconds"><span class="hs-identifier hs-var">cacheSeconds</span></a><span>
</span><a name="line-125"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#neverExpires"><span class="hs-identifier hs-var">neverExpires</span></a><span>
</span><a name="line-126"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#alreadyExpired"><span class="hs-identifier hs-var">alreadyExpired</span></a><span>
</span><a name="line-127"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#expiresAt"><span class="hs-identifier hs-var">expiresAt</span></a><span>
</span><a name="line-128"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setEtag"><span class="hs-identifier hs-var">setEtag</span></a><span>
</span><a name="line-129"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setWeakEtag"><span class="hs-identifier hs-var">setWeakEtag</span></a><span>
</span><a name="line-130"></a><span>      </span><span class="hs-comment">-- * Session</span><span>
</span><a name="line-131"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Types.html#SessionMap"><span class="hs-identifier hs-type">SessionMap</span></a><span>
</span><a name="line-132"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupSession"><span class="hs-identifier hs-var">lookupSession</span></a><span>
</span><a name="line-133"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#lookupSessionBS"><span class="hs-identifier hs-var">lookupSessionBS</span></a><span>
</span><a name="line-134"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getSession"><span class="hs-identifier hs-var">getSession</span></a><span>
</span><a name="line-135"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setSession"><span class="hs-identifier hs-var">setSession</span></a><span>
</span><a name="line-136"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setSessionBS"><span class="hs-identifier hs-var">setSessionBS</span></a><span>
</span><a name="line-137"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#deleteSession"><span class="hs-identifier hs-var">deleteSession</span></a><span>
</span><a name="line-138"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#clearSession"><span class="hs-identifier hs-var">clearSession</span></a><span>
</span><a name="line-139"></a><span>      </span><span class="hs-comment">-- ** Ultimate destination</span><span>
</span><a name="line-140"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setUltDest"><span class="hs-identifier hs-var">setUltDest</span></a><span>
</span><a name="line-141"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setUltDestCurrent"><span class="hs-identifier hs-var">setUltDestCurrent</span></a><span>
</span><a name="line-142"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setUltDestReferer"><span class="hs-identifier hs-var">setUltDestReferer</span></a><span>
</span><a name="line-143"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#redirectUltDest"><span class="hs-identifier hs-var">redirectUltDest</span></a><span>
</span><a name="line-144"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#clearUltDest"><span class="hs-identifier hs-var">clearUltDest</span></a><span>
</span><a name="line-145"></a><span>      </span><span class="hs-comment">-- ** Messages</span><span>
</span><a name="line-146"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#addMessage"><span class="hs-identifier hs-var">addMessage</span></a><span>
</span><a name="line-147"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#addMessageI"><span class="hs-identifier hs-var">addMessageI</span></a><span>
</span><a name="line-148"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getMessages"><span class="hs-identifier hs-var">getMessages</span></a><span>
</span><a name="line-149"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setMessage"><span class="hs-identifier hs-var">setMessage</span></a><span>
</span><a name="line-150"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setMessageI"><span class="hs-identifier hs-var">setMessageI</span></a><span>
</span><a name="line-151"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getMessage"><span class="hs-identifier hs-var">getMessage</span></a><span>
</span><a name="line-152"></a><span>      </span><span class="hs-comment">-- * Subsites</span><span>
</span><a name="line-153"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Types.html#SubHandlerFor"><span class="hs-identifier hs-type">SubHandlerFor</span></a><span>
</span><a name="line-154"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getSubYesod"><span class="hs-identifier hs-var">getSubYesod</span></a><span>
</span><a name="line-155"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getRouteToParent"><span class="hs-identifier hs-var">getRouteToParent</span></a><span>
</span><a name="line-156"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getSubCurrentRoute"><span class="hs-identifier hs-var">getSubCurrentRoute</span></a><span>
</span><a name="line-157"></a><span>      </span><span class="hs-comment">-- * Helpers for specific content</span><span>
</span><a name="line-158"></a><span>      </span><span class="hs-comment">-- ** Hamlet</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#hamletToRepHtml"><span class="hs-identifier hs-var">hamletToRepHtml</span></a><span>
</span><a name="line-160"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#giveUrlRenderer"><span class="hs-identifier hs-var">giveUrlRenderer</span></a><span>
</span><a name="line-161"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#withUrlRenderer"><span class="hs-identifier hs-var">withUrlRenderer</span></a><span>
</span><a name="line-162"></a><span>      </span><span class="hs-comment">-- ** Misc</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#newIdent"><span class="hs-identifier hs-var">newIdent</span></a><span>
</span><a name="line-164"></a><span>      </span><span class="hs-comment">-- * Lifting</span><span>
</span><a name="line-165"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#handlerToIO"><span class="hs-identifier hs-var">handlerToIO</span></a><span>
</span><a name="line-166"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#forkHandler"><span class="hs-identifier hs-var">forkHandler</span></a><span>
</span><a name="line-167"></a><span>      </span><span class="hs-comment">-- * i18n</span><span>
</span><a name="line-168"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#getMessageRender"><span class="hs-identifier hs-var">getMessageRender</span></a><span>
</span><a name="line-169"></a><span>      </span><span class="hs-comment">-- * Per-request caching</span><span>
</span><a name="line-170"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#cached"><span class="hs-identifier hs-var">cached</span></a><span>
</span><a name="line-171"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#cacheGet"><span class="hs-identifier hs-var">cacheGet</span></a><span>
</span><a name="line-172"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#cacheSet"><span class="hs-identifier hs-var">cacheSet</span></a><span>
</span><a name="line-173"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#cachedBy"><span class="hs-identifier hs-var">cachedBy</span></a><span>
</span><a name="line-174"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#cacheByGet"><span class="hs-identifier hs-var">cacheByGet</span></a><span>
</span><a name="line-175"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#cacheBySet"><span class="hs-identifier hs-var">cacheBySet</span></a><span>
</span><a name="line-176"></a><span>      </span><span class="hs-comment">-- * AJAX CSRF protection</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>      </span><span class="hs-comment">-- $ajaxCSRFOverview</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span>      </span><span class="hs-comment">-- ** Setting CSRF Cookies</span><span>
</span><a name="line-181"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setCsrfCookie"><span class="hs-identifier hs-var">setCsrfCookie</span></a><span>
</span><a name="line-182"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#setCsrfCookieWithCookie"><span class="hs-identifier hs-var">setCsrfCookieWithCookie</span></a><span>
</span><a name="line-183"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#defaultCsrfCookieName"><span class="hs-identifier hs-var">defaultCsrfCookieName</span></a><span>
</span><a name="line-184"></a><span>      </span><span class="hs-comment">-- ** Looking up CSRF Headers</span><span>
</span><a name="line-185"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#checkCsrfHeaderNamed"><span class="hs-identifier hs-var">checkCsrfHeaderNamed</span></a><span>
</span><a name="line-186"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#hasValidCsrfHeaderNamed"><span class="hs-identifier hs-var">hasValidCsrfHeaderNamed</span></a><span>
</span><a name="line-187"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#defaultCsrfHeaderName"><span class="hs-identifier hs-var">defaultCsrfHeaderName</span></a><span>
</span><a name="line-188"></a><span>      </span><span class="hs-comment">-- ** Looking up CSRF POST Parameters</span><span>
</span><a name="line-189"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#hasValidCsrfParamNamed"><span class="hs-identifier hs-var">hasValidCsrfParamNamed</span></a><span>
</span><a name="line-190"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#checkCsrfParamNamed"><span class="hs-identifier hs-var">checkCsrfParamNamed</span></a><span>
</span><a name="line-191"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#defaultCsrfParamName"><span class="hs-identifier hs-var">defaultCsrfParamName</span></a><span>
</span><a name="line-192"></a><span>      </span><span class="hs-comment">-- ** Checking CSRF Headers or POST Parameters</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#checkCsrfHeaderOrParam"><span class="hs-identifier hs-var">checkCsrfHeaderOrParam</span></a><span>
</span><a name="line-194"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Time</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">UTCTime</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">addUTCTime</span><span class="hs-special">,</span><span>
</span><a name="line-197"></a><span>                                                </span><span class="hs-identifier hs-var">getCurrentTime</span><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span class="hs-keyword">import</span><span>           </span><a href="Yesod.Core.Internal.Request.html"><span class="hs-identifier">Yesod.Core.Internal.Request</span></a><span>   </span><span class="hs-special">(</span><a href="Yesod.Core.Internal.Request.html#langKey"><span class="hs-identifier hs-var">langKey</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Internal.Request.html#mkFileInfoFile"><span class="hs-identifier hs-var">mkFileInfoFile</span></a><span class="hs-special">,</span><span>
</span><a name="line-199"></a><span>                                                </span><a href="Yesod.Core.Internal.Request.html#mkFileInfoLBS"><span class="hs-identifier hs-var">mkFileInfoLBS</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Internal.Request.html#mkFileInfoSource"><span class="hs-identifier hs-var">mkFileInfoSource</span></a><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Applicative</span><span>           </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;|&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.CaseInsensitive</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">CI</span><span>
</span><a name="line-204"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">evaluate</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">handle</span><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">void</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unless</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Monad.Trans.Writer</span><span>    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Writer</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">UnliftIO</span><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network.HTTP.Types</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">H</span><span>
</span><a name="line-213"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network.Wai</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">W</span><span>
</span><a name="line-214"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Network.Wai.Middleware.HttpAuth</span><span>
</span><a name="line-215"></a><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">extractBasicAuth</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">extractBearerAuth</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans.Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lift</span><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Aeson</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ToJSON</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text</span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-220"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Text.Encoding</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decodeUtf8With</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">encodeUtf8</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">decodeUtf8</span><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Text.Encoding.Error</span><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lenientDecode</span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text.Lazy</span><span>                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TL</span><span>
</span><a name="line-223"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text.Blaze.Html.Renderer.Utf8</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">renderHtml</span><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text.Hamlet</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Html</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HtmlUrl</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hamlet</span><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-227"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">L</span><span>
</span><a name="line-228"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-229"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.HashMap.Strict</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HM</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.ByteArray</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">constEq</span><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Arrow</span><span>                 </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">***</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Char8</span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S8</span><span>
</span><a name="line-235"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Monoid</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Endo</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Text</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network.Wai.Parse</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NWP</span><span>
</span><a name="line-238"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text.Shakespeare.I18N</span><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RenderMessage</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Web.Cookie</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SetCookie</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">defaultSetCookie</span><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span class="hs-keyword">import</span><span>           </span><a href="Yesod.Core.Content.html"><span class="hs-identifier">Yesod.Core.Content</span></a><span>            </span><span class="hs-special">(</span><a href="Yesod.Core.Content.html#ToTypedContent"><span class="hs-identifier hs-type">ToTypedContent</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Content.html#simpleContentType"><span class="hs-identifier hs-var">simpleContentType</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Content.html#contentTypeTypes"><span class="hs-identifier hs-var">contentTypeTypes</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Content.html#HasContentType"><span class="hs-identifier hs-type">HasContentType</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Content.html#ToContent"><span class="hs-identifier hs-type">ToContent</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Content.html#ToFlushBuilder"><span class="hs-identifier hs-type">ToFlushBuilder</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span class="hs-keyword">import</span><span>           </span><a href="Yesod.Core.Internal.Util.html"><span class="hs-identifier">Yesod.Core.Internal.Util</span></a><span>      </span><span class="hs-special">(</span><a href="Yesod.Core.Internal.Util.html#formatRFC1123"><span class="hs-identifier hs-var">formatRFC1123</span></a><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text.Blaze.Html</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">preEscapedToHtml</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toHtml</span><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>
</span><a name="line-244"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IORef</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">I</span><span>
</span><a name="line-245"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listToMaybe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Typeable</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Web.PathPieces</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-type">PathPiece</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span class="hs-keyword">import</span><span>           </span><a href="Yesod.Core.Class.Handler.html"><span class="hs-identifier">Yesod.Core.Class.Handler</span></a><span>
</span><a name="line-249"></a><span class="hs-keyword">import</span><span>           </span><a href="Yesod.Core.Types.html"><span class="hs-identifier">Yesod.Core.Types</span></a><span>
</span><a name="line-250"></a><span class="hs-keyword">import</span><span>           </span><a href="Yesod.Routes.Class.html"><span class="hs-identifier">Yesod.Routes.Class</span></a><span>            </span><span class="hs-special">(</span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span class="hs-special">)</span><span>
</span><a name="line-251"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.ByteString.Builder</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Builder</span><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.CaseInsensitive</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CI</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">original</span><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Conduit.List</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">CL</span><span>
</span><a name="line-254"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Trans.Resource</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadResource</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">InternalState</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runResourceT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">withInternalState</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getInternalState</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">liftResourceT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">resourceForkIO</span><span class="hs-special">)</span><span>
</span><a name="line-255"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System.PosixCompat.Files</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PC</span><span>
</span><a name="line-256"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Conduit</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">.|</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runConduit</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sinkLazy</span><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Conduit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ConduitT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">transPipe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Flush</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Flush</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">yield</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Void</span><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Yesod.Core.TypeCache.html"><span class="hs-identifier">Yesod.Core.TypeCache</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Cache</span><span>
</span><a name="line-259"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Word8</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">W8</span><span>
</span><a name="line-260"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Foldable</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Fold</span><span>
</span><a name="line-261"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Logger</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadLogger</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logWarnS</span><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-keyword">type</span><span> </span><a name="HandlerT"><a href="Yesod.Core.Handler.html#HandlerT"><span class="hs-identifier">HandlerT</span></a></a><span> </span><a name="local-6989586621679219431"><a href="#local-6989586621679219431"><span class="hs-identifier">site</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679219432"><a href="#local-6989586621679219432"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-operator">*</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-operator">*</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-type">HandlerFor</span></a><span> </span><a href="#local-6989586621679219431"><span class="hs-identifier hs-type">site</span></a><span>
</span><a name="line-264"></a><span class="hs-pragma">{-# DEPRECATED</span><span> </span><span class="hs-pragma">HandlerT</span><span> </span><span class="hs-pragma">&quot;Use HandlerFor directly&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-265"></a><span>
</span><a name="line-266"></a><span class="hs-identifier">get</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219642"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219642"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Yesod.Core.Types.html#GHState"><span class="hs-identifier hs-type">GHState</span></a><span>
</span><a name="line-267"></a><a name="get"><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier">get</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Class.Handler.html#liftHandler"><span class="hs-identifier hs-var">liftHandler</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-var">HandlerFor</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">I.readIORef</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">handlerState</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-identifier">put</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219641"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Types.html#GHState"><span class="hs-identifier hs-type">GHState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219641"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-270"></a><a name="put"><a href="Yesod.Core.Handler.html#put"><span class="hs-identifier">put</span></a></a><span> </span><a name="local-6989586621679219643"><a href="#local-6989586621679219643"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Class.Handler.html#liftHandler"><span class="hs-identifier hs-var">liftHandler</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-var">HandlerFor</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">I.writeIORef</span><span> </span><a href="#local-6989586621679219643"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">handlerState</span><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span class="hs-identifier">modify</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219640"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Types.html#GHState"><span class="hs-identifier hs-type">GHState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Types.html#GHState"><span class="hs-identifier hs-type">GHState</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219640"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-273"></a><a name="modify"><a href="Yesod.Core.Handler.html#modify"><span class="hs-identifier">modify</span></a></a><span> </span><a name="local-6989586621679219644"><a href="#local-6989586621679219644"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Class.Handler.html#liftHandler"><span class="hs-identifier hs-var">liftHandler</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-var">HandlerFor</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">I.modifyIORef</span><span> </span><a href="#local-6989586621679219644"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">handlerState</span><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span class="hs-identifier">tell</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219639"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Endo</span><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-type">Header</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219639"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-276"></a><a name="tell"><a href="Yesod.Core.Handler.html#tell"><span class="hs-identifier">tell</span></a></a><span> </span><a name="local-6989586621679219645"><a href="#local-6989586621679219645"><span class="hs-identifier">hs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#modify"><span class="hs-identifier hs-var">modify</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679219646"><a href="#local-6989586621679219646"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219646"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ghsHeaders</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ghsHeaders</span><span> </span><a href="#local-6989586621679219646"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679219645"><span class="hs-identifier hs-var">hs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span class="hs-identifier">handlerError</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219637"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Types.html#HandlerContents"><span class="hs-identifier hs-type">HandlerContents</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219637"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219638"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-279"></a><a name="handlerError"><a href="Yesod.Core.Handler.html#handlerError"><span class="hs-identifier">handlerError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span class="hs-identifier">hcError</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219635"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Types.html#ErrorResponse"><span class="hs-identifier hs-type">ErrorResponse</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219635"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219636"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-282"></a><a name="hcError"><a href="Yesod.Core.Handler.html#hcError"><span class="hs-identifier">hcError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#handlerError"><span class="hs-identifier hs-var">handlerError</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Types.html#HCError"><span class="hs-identifier hs-var">HCError</span></a><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-identifier">getRequest</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219634"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219634"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Yesod.Core.Types.html#YesodRequest"><span class="hs-identifier hs-type">YesodRequest</span></a><span>
</span><a name="line-285"></a><a name="getRequest"><a href="Yesod.Core.Handler.html#getRequest"><span class="hs-identifier">getRequest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Class.Handler.html#liftHandler"><span class="hs-identifier hs-var">liftHandler</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-var">HandlerFor</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">handlerRequest</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-identifier">runRequestBody</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219633"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219633"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Yesod.Core.Types.html#RequestBodyContents"><span class="hs-identifier hs-type">RequestBodyContents</span></a><span>
</span><a name="line-288"></a><a name="runRequestBody"><a href="Yesod.Core.Handler.html#runRequestBody"><span class="hs-identifier">runRequestBody</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-289"></a><span>    </span><a href="Yesod.Core.Types.html#HandlerData"><span class="hs-identifier hs-var">HandlerData</span></a><span>
</span><a name="line-290"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">handlerEnv</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Types.html#RunHandlerEnv"><span class="hs-identifier hs-var">RunHandlerEnv</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-291"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">handlerRequest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679219656"><a href="#local-6989586621679219656"><span class="hs-identifier">req</span></a></a><span>
</span><a name="line-292"></a><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Class.Handler.html#liftHandler"><span class="hs-identifier hs-var">liftHandler</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-var">HandlerFor</span></a><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-293"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679219657"><a href="#local-6989586621679219657"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">W.requestBodyLength</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">reqWaiRequest</span><span> </span><a href="#local-6989586621679219656"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-294"></a><span>        </span><a name="local-6989586621679219658"><a href="#local-6989586621679219658"><span class="hs-identifier">upload</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219652"><span class="hs-identifier hs-var">rheUpload</span></a><span> </span><a href="#local-6989586621679219657"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-295"></a><span>    </span><a name="local-6989586621679219659"><a href="#local-6989586621679219659"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-296"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ghsRBC</span><span> </span><a href="#local-6989586621679219659"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-297"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679219660"><a href="#local-6989586621679219660"><span class="hs-identifier">rbc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679219660"><span class="hs-identifier hs-var">rbc</span></a><span>
</span><a name="line-298"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-299"></a><span>            </span><a name="local-6989586621679219661"><a href="#local-6989586621679219661"><span class="hs-identifier">rr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#waiRequest"><span class="hs-identifier hs-var">waiRequest</span></a><span>
</span><a name="line-300"></a><span>            </span><a name="local-6989586621679219662"><a href="#local-6989586621679219662"><span class="hs-identifier">internalState</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftResourceT</span><span> </span><span class="hs-identifier hs-var">getInternalState</span><span>
</span><a name="line-301"></a><span>            </span><a name="local-6989586621679219663"><a href="#local-6989586621679219663"><span class="hs-identifier">rbc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Handler.html#rbHelper"><span class="hs-identifier hs-var">rbHelper</span></a><span> </span><a href="#local-6989586621679219658"><span class="hs-identifier hs-var">upload</span></a><span> </span><a href="#local-6989586621679219661"><span class="hs-identifier hs-var">rr</span></a><span> </span><a href="#local-6989586621679219662"><span class="hs-identifier hs-var">internalState</span></a><span>
</span><a name="line-302"></a><span>            </span><a href="Yesod.Core.Handler.html#put"><span class="hs-identifier hs-var">put</span></a><span> </span><a href="#local-6989586621679219659"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ghsRBC</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679219663"><span class="hs-identifier hs-var">rbc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-303"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679219663"><span class="hs-identifier hs-var">rbc</span></a><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-identifier">rbHelper</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Types.html#FileUpload"><span class="hs-identifier hs-type">FileUpload</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">W.Request</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InternalState</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Yesod.Core.Types.html#RequestBodyContents"><span class="hs-identifier hs-type">RequestBodyContents</span></a><span>
</span><a name="line-306"></a><a name="rbHelper"><a href="Yesod.Core.Handler.html#rbHelper"><span class="hs-identifier">rbHelper</span></a></a><span> </span><a name="local-6989586621679219664"><a href="#local-6989586621679219664"><span class="hs-identifier">upload</span></a></a><span> </span><a name="local-6989586621679219665"><a href="#local-6989586621679219665"><span class="hs-identifier">req</span></a></a><span> </span><a name="local-6989586621679219666"><a href="#local-6989586621679219666"><span class="hs-identifier">internalState</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-307"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679219664"><span class="hs-identifier hs-var">upload</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-308"></a><span>        </span><a href="Yesod.Core.Types.html#FileUploadMemory"><span class="hs-identifier hs-var">FileUploadMemory</span></a><span> </span><a name="local-6989586621679219667"><a href="#local-6989586621679219667"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Handler.html#rbHelper%27"><span class="hs-identifier hs-var">rbHelper'</span></a><span> </span><a href="#local-6989586621679219667"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="Yesod.Core.Internal.Request.html#mkFileInfoLBS"><span class="hs-identifier hs-var">mkFileInfoLBS</span></a><span> </span><a href="#local-6989586621679219665"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-309"></a><span>        </span><a href="Yesod.Core.Types.html#FileUploadDisk"><span class="hs-identifier hs-var">FileUploadDisk</span></a><span> </span><a name="local-6989586621679219668"><a href="#local-6989586621679219668"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Handler.html#rbHelper%27"><span class="hs-identifier hs-var">rbHelper'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219668"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621679219666"><span class="hs-identifier hs-var">internalState</span></a><span class="hs-special">)</span><span> </span><a href="Yesod.Core.Internal.Request.html#mkFileInfoFile"><span class="hs-identifier hs-var">mkFileInfoFile</span></a><span> </span><a href="#local-6989586621679219665"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-310"></a><span>        </span><a href="Yesod.Core.Types.html#FileUploadSource"><span class="hs-identifier hs-var">FileUploadSource</span></a><span> </span><a name="local-6989586621679219669"><a href="#local-6989586621679219669"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Handler.html#rbHelper%27"><span class="hs-identifier hs-var">rbHelper'</span></a><span> </span><a href="#local-6989586621679219669"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="Yesod.Core.Internal.Request.html#mkFileInfoSource"><span class="hs-identifier hs-var">mkFileInfoSource</span></a><span> </span><a href="#local-6989586621679219665"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-identifier">rbHelper'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NWP.BackEnd</span><span> </span><a href="#local-6989586621679219632"><span class="hs-identifier hs-type">x</span></a><span>
</span><a name="line-313"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219632"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Types.html#FileInfo"><span class="hs-identifier hs-type">FileInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">W.Request</span><span>
</span><a name="line-315"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Types.html#FileInfo"><span class="hs-identifier hs-type">FileInfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-316"></a><a name="rbHelper%27"><a href="Yesod.Core.Handler.html#rbHelper%27"><span class="hs-identifier">rbHelper'</span></a></a><span> </span><a name="local-6989586621679219670"><a href="#local-6989586621679219670"><span class="hs-identifier">backend</span></a></a><span> </span><a name="local-6989586621679219671"><a href="#local-6989586621679219671"><span class="hs-identifier">mkFI</span></a></a><span> </span><a name="local-6989586621679219672"><a href="#local-6989586621679219672"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-317"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679219673"><span class="hs-identifier hs-var">fix1</span></a><span> </span><span class="hs-operator hs-var">***</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="#local-6989586621679219674"><span class="hs-identifier hs-var">fix2</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">NWP.parseRequestBody</span><span> </span><a href="#local-6989586621679219670"><span class="hs-identifier hs-var">backend</span></a><span> </span><a href="#local-6989586621679219672"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-318"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-319"></a><span>    </span><a name="local-6989586621679219673"><a href="#local-6989586621679219673"><span class="hs-identifier">fix1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219675"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">***</span><span> </span><a href="#local-6989586621679219675"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-320"></a><span>    </span><a name="local-6989586621679219674"><a href="#local-6989586621679219674"><span class="hs-identifier">fix2</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679219676"><a href="#local-6989586621679219676"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">NWP.FileInfo</span><span> </span><a name="local-6989586621679219677"><a href="#local-6989586621679219677"><span class="hs-identifier">a'</span></a></a><span> </span><a name="local-6989586621679219678"><a href="#local-6989586621679219678"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679219679"><a href="#local-6989586621679219679"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">S.null</span><span> </span><a href="#local-6989586621679219680"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-322"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219675"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679219676"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679219671"><span class="hs-identifier hs-var">mkFI</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219675"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679219680"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219675"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679219678"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219679"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-323"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-324"></a><span>        </span><a name="local-6989586621679219680"><a href="#local-6989586621679219680"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-325"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">S.length</span><span> </span><a href="#local-6989586621679219677"><span class="hs-identifier hs-var">a'</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219677"><span class="hs-identifier hs-var">a'</span></a><span>
</span><a name="line-326"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">S8.head</span><span> </span><a href="#local-6989586621679219677"><span class="hs-identifier hs-var">a'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-char">'&quot;'</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">S8.last</span><span> </span><a href="#local-6989586621679219677"><span class="hs-identifier hs-var">a'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-char">'&quot;'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.tail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">S.init</span><span> </span><a href="#local-6989586621679219677"><span class="hs-identifier hs-var">a'</span></a><span>
</span><a name="line-327"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">S8.head</span><span> </span><a href="#local-6989586621679219677"><span class="hs-identifier hs-var">a'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-char">'\''</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">S8.last</span><span> </span><a href="#local-6989586621679219677"><span class="hs-identifier hs-var">a'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-char">'\''</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.tail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">S.init</span><span> </span><a href="#local-6989586621679219677"><span class="hs-identifier hs-var">a'</span></a><span>
</span><a name="line-328"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219677"><span class="hs-identifier hs-var">a'</span></a><span>
</span><a name="line-329"></a><span>    </span><a name="local-6989586621679219675"><a href="#local-6989586621679219675"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">decodeUtf8With</span><span> </span><span class="hs-identifier hs-var">lenientDecode</span><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span class="hs-identifier">askHandlerEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219631"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219631"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Types.html#RunHandlerEnv"><span class="hs-identifier hs-type">RunHandlerEnv</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219631"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219631"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-332"></a><a name="askHandlerEnv"><a href="Yesod.Core.Handler.html#askHandlerEnv"><span class="hs-identifier">askHandlerEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Class.Handler.html#liftHandler"><span class="hs-identifier hs-var">liftHandler</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-var">HandlerFor</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">handlerEnv</span><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span class="hs-comment">-- | Get the master site application argument.</span><span>
</span><a name="line-335"></a><span class="hs-identifier">getYesod</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219630"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219630"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219630"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-336"></a><a name="getYesod"><a href="Yesod.Core.Handler.html#getYesod"><span class="hs-identifier">getYesod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rheSite</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#askHandlerEnv"><span class="hs-identifier hs-var">askHandlerEnv</span></a><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span class="hs-comment">-- | Get a specific component of the master site application argument.</span><span>
</span><a name="line-339"></a><span class="hs-comment">--   Analogous to the 'gets' function for operating on 'StateT'.</span><span>
</span><a name="line-340"></a><span class="hs-identifier">getsYesod</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219628"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219628"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219629"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219628"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219629"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-341"></a><a name="getsYesod"><a href="Yesod.Core.Handler.html#getsYesod"><span class="hs-identifier">getsYesod</span></a></a><span> </span><a name="local-6989586621679219681"><a href="#local-6989586621679219681"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219681"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">rheSite</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#askHandlerEnv"><span class="hs-identifier hs-var">askHandlerEnv</span></a><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span class="hs-comment">-- | Get the URL rendering function.</span><span>
</span><a name="line-344"></a><span class="hs-identifier">getUrlRender</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219627"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219627"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219627"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-345"></a><a name="getUrlRender"><a href="Yesod.Core.Handler.html#getUrlRender"><span class="hs-identifier">getUrlRender</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-346"></a><span>    </span><a name="local-6989586621679219682"><a href="#local-6989586621679219682"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">rheRender</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#askHandlerEnv"><span class="hs-identifier hs-var">askHandlerEnv</span></a><span>
</span><a name="line-347"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="#local-6989586621679219682"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span class="hs-comment">-- | The URL rendering function with query-string parameters.</span><span>
</span><a name="line-350"></a><span class="hs-identifier">getUrlRenderParams</span><span>
</span><a name="line-351"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219626"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-352"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219626"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219626"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-353"></a><a name="getUrlRenderParams"><a href="Yesod.Core.Handler.html#getUrlRenderParams"><span class="hs-identifier">getUrlRenderParams</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rheRender</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#askHandlerEnv"><span class="hs-identifier hs-var">askHandlerEnv</span></a><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span class="hs-comment">-- | Get all the post parameters passed to the handler. To also get</span><span>
</span><a name="line-356"></a><span class="hs-comment">-- the submitted files (if any), you have to use 'runRequestBody'</span><span>
</span><a name="line-357"></a><span class="hs-comment">-- instead of this function.</span><span>
</span><a name="line-358"></a><span class="hs-comment">--</span><span>
</span><a name="line-359"></a><span class="hs-comment">-- @since 1.4.33</span><span>
</span><a name="line-360"></a><span class="hs-identifier">getPostParams</span><span>
</span><a name="line-361"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219625"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-362"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219625"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-363"></a><a name="getPostParams"><a href="Yesod.Core.Handler.html#getPostParams"><span class="hs-identifier">getPostParams</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-364"></a><span>  </span><a name="local-6989586621679219683"><a href="#local-6989586621679219683"><span class="hs-identifier">reqBodyContent</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#runRequestBody"><span class="hs-identifier hs-var">runRequestBody</span></a><span>
</span><a name="line-365"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679219683"><span class="hs-identifier hs-var">reqBodyContent</span></a><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span class="hs-comment">-- | Get the route requested by the user. If this is a 404 response- where the</span><span>
</span><a name="line-368"></a><span class="hs-comment">-- user requested an invalid route- this function will return 'Nothing'.</span><span>
</span><a name="line-369"></a><span class="hs-identifier">getCurrentRoute</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219624"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219624"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219624"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-370"></a><a name="getCurrentRoute"><a href="Yesod.Core.Handler.html#getCurrentRoute"><span class="hs-identifier">getCurrentRoute</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rheRoute</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#askHandlerEnv"><span class="hs-identifier hs-var">askHandlerEnv</span></a><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span class="hs-comment">-- | Returns a function that runs 'HandlerT' actions inside @IO@.</span><span>
</span><a name="line-373"></a><span class="hs-comment">--</span><span>
</span><a name="line-374"></a><span class="hs-comment">-- Sometimes you want to run an inner 'HandlerT' action outside</span><span>
</span><a name="line-375"></a><span class="hs-comment">-- the control flow of an HTTP request (on the outer 'HandlerT'</span><span>
</span><a name="line-376"></a><span class="hs-comment">-- action).  For example, you may want to spawn a new thread:</span><span>
</span><a name="line-377"></a><span class="hs-comment">--</span><span>
</span><a name="line-378"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-379"></a><span class="hs-comment">-- getFooR :: Handler RepHtml</span><span>
</span><a name="line-380"></a><span class="hs-comment">-- getFooR = do</span><span>
</span><a name="line-381"></a><span class="hs-comment">--   runInnerHandler &lt;- handlerToIO</span><span>
</span><a name="line-382"></a><span class="hs-comment">--   liftIO $ forkIO $ runInnerHandler $ do</span><span>
</span><a name="line-383"></a><span class="hs-comment">--     /Code here runs inside GHandler but on a new thread./</span><span>
</span><a name="line-384"></a><span class="hs-comment">--     /This is the inner GHandler./</span><span>
</span><a name="line-385"></a><span class="hs-comment">--     ...</span><span>
</span><a name="line-386"></a><span class="hs-comment">--   /Code here runs inside the request's control flow./</span><span>
</span><a name="line-387"></a><span class="hs-comment">--   /This is the outer GHandler./</span><span>
</span><a name="line-388"></a><span class="hs-comment">--   ...</span><span>
</span><a name="line-389"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-390"></a><span class="hs-comment">--</span><span>
</span><a name="line-391"></a><span class="hs-comment">-- Another use case for this function is creating a stream of</span><span>
</span><a name="line-392"></a><span class="hs-comment">-- server-sent events using 'GHandler' actions (see</span><span>
</span><a name="line-393"></a><span class="hs-comment">-- @yesod-eventsource@).</span><span>
</span><a name="line-394"></a><span class="hs-comment">--</span><span>
</span><a name="line-395"></a><span class="hs-comment">-- Most of the environment from the outer 'GHandler' is preserved</span><span>
</span><a name="line-396"></a><span class="hs-comment">-- on the inner 'GHandler', however:</span><span>
</span><a name="line-397"></a><span class="hs-comment">--</span><span>
</span><a name="line-398"></a><span class="hs-comment">--  * The request body is cleared (otherwise it would be very</span><span>
</span><a name="line-399"></a><span class="hs-comment">--  difficult to prevent huge memory leaks).</span><span>
</span><a name="line-400"></a><span class="hs-comment">--</span><span>
</span><a name="line-401"></a><span class="hs-comment">--  * The cache is cleared (see 'CacheKey').</span><span>
</span><a name="line-402"></a><span class="hs-comment">--</span><span>
</span><a name="line-403"></a><span class="hs-comment">-- Changes to the response made inside the inner 'GHandler' are</span><span>
</span><a name="line-404"></a><span class="hs-comment">-- ignored (e.g., session variables, cookies, response headers).</span><span>
</span><a name="line-405"></a><span class="hs-comment">-- This allows the inner 'GHandler' to outlive the outer</span><span>
</span><a name="line-406"></a><span class="hs-comment">-- 'GHandler' (e.g., on the @forkIO@ example above, a response</span><span>
</span><a name="line-407"></a><span class="hs-comment">-- may be sent to the client without killing the new thread).</span><span>
</span><a name="line-408"></a><span class="hs-identifier">handlerToIO</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679219621"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-type">HandlerFor</span></a><span> </span><a href="#local-6989586621679219622"><span class="hs-identifier hs-type">site</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-type">HandlerFor</span></a><span> </span><a href="#local-6989586621679219622"><span class="hs-identifier hs-type">site</span></a><span> </span><a href="#local-6989586621679219623"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219621"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219623"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><a name="handlerToIO"><a href="Yesod.Core.Handler.html#handlerToIO"><span class="hs-identifier">handlerToIO</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-410"></a><span>  </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-var">HandlerFor</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679219684"><a href="#local-6989586621679219684"><span class="hs-identifier">oldHandlerData</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-411"></a><span>    </span><span class="hs-comment">-- Take just the bits we need from oldHandlerData.</span><span>
</span><a name="line-412"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679219685"><a href="#local-6989586621679219685"><span class="hs-identifier">newReq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219687"><span class="hs-identifier hs-var">oldReq</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">reqWaiRequest</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219689"><span class="hs-identifier hs-var">newWaiReq</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-413"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-414"></a><span>            </span><a name="local-6989586621679219687"><a href="#local-6989586621679219687"><span class="hs-identifier">oldReq</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">handlerRequest</span><span> </span><a href="#local-6989586621679219684"><span class="hs-identifier hs-var">oldHandlerData</span></a><span>
</span><a name="line-415"></a><span>            </span><a name="local-6989586621679219688"><a href="#local-6989586621679219688"><span class="hs-identifier">oldWaiReq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">reqWaiRequest</span><span> </span><a href="#local-6989586621679219687"><span class="hs-identifier hs-var">oldReq</span></a><span>
</span><a name="line-416"></a><span>            </span><a name="local-6989586621679219689"><a href="#local-6989586621679219689"><span class="hs-identifier">newWaiReq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219688"><span class="hs-identifier hs-var">oldWaiReq</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">W.requestBody</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-417"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">W.requestBodyLength</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">W.KnownLength</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-418"></a><span>                                  </span><span class="hs-special">}</span><span>
</span><a name="line-419"></a><span>        </span><a name="local-6989586621679219686"><a href="#local-6989586621679219686"><span class="hs-identifier">oldEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">handlerEnv</span><span> </span><a href="#local-6989586621679219684"><span class="hs-identifier hs-var">oldHandlerData</span></a><span>
</span><a name="line-420"></a><span>    </span><a name="local-6989586621679219691"><a href="#local-6989586621679219691"><span class="hs-identifier">newState</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-421"></a><span>      </span><a name="local-6989586621679219690"><a href="#local-6989586621679219690"><span class="hs-identifier">oldState</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">I.readIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">handlerState</span><span> </span><a href="#local-6989586621679219684"><span class="hs-identifier hs-var">oldHandlerData</span></a><span class="hs-special">)</span><span>
</span><a name="line-422"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679219690"><span class="hs-identifier hs-var">oldState</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ghsRBC</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-423"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ghsIdent</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-424"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ghsCache</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-425"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ghsCacheBy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-426"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ghsHeaders</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><span>    </span><span class="hs-comment">-- xx From this point onwards, no references to oldHandlerData xx</span><span>
</span><a name="line-429"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">evaluate</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219685"><span class="hs-identifier hs-var">newReq</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679219686"><span class="hs-identifier hs-var">oldEnv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679219691"><span class="hs-identifier hs-var">newState</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span>    </span><span class="hs-comment">-- Return GHandler running function.</span><span>
</span><a name="line-432"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-var">HandlerFor</span></a><span> </span><a name="local-6989586621679219692"><a href="#local-6989586621679219692"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-433"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-434"></a><span>      </span><span class="hs-identifier hs-var">runResourceT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">withInternalState</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679219693"><a href="#local-6989586621679219693"><span class="hs-identifier">resState</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-435"></a><span>        </span><span class="hs-comment">-- The state IORef needs to be created here, otherwise it</span><span>
</span><a name="line-436"></a><span>        </span><span class="hs-comment">-- will be shared by different invocations of this function.</span><span>
</span><a name="line-437"></a><span>        </span><a name="local-6989586621679219694"><a href="#local-6989586621679219694"><span class="hs-identifier">newStateIORef</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I.newIORef</span><span> </span><a href="#local-6989586621679219691"><span class="hs-identifier hs-var">newState</span></a><span class="hs-special">)</span><span>
</span><a name="line-438"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679219695"><a href="#local-6989586621679219695"><span class="hs-identifier">newHandlerData</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-439"></a><span>              </span><a href="Yesod.Core.Types.html#HandlerData"><span class="hs-identifier hs-var">HandlerData</span></a><span>
</span><a name="line-440"></a><span>                </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">handlerRequest</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219685"><span class="hs-identifier hs-var">newReq</span></a><span>
</span><a name="line-441"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">handlerEnv</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219686"><span class="hs-identifier hs-var">oldEnv</span></a><span>
</span><a name="line-442"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">handlerState</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219694"><span class="hs-identifier hs-var">newStateIORef</span></a><span>
</span><a name="line-443"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">handlerResource</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219693"><span class="hs-identifier hs-var">resState</span></a><span>
</span><a name="line-444"></a><span>                </span><span class="hs-special">}</span><span>
</span><a name="line-445"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219692"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679219695"><span class="hs-identifier hs-var">newHandlerData</span></a><span class="hs-special">)</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span class="hs-comment">-- | forkIO for a Handler (run an action in the background)</span><span>
</span><a name="line-448"></a><span class="hs-comment">--</span><span>
</span><a name="line-449"></a><span class="hs-comment">-- Uses 'handlerToIO', liftResourceT, and resourceForkIO</span><span>
</span><a name="line-450"></a><span class="hs-comment">-- for correctness and efficiency</span><span>
</span><a name="line-451"></a><span class="hs-comment">--</span><span>
</span><a name="line-452"></a><span class="hs-comment">-- @since 1.2.8</span><span>
</span><a name="line-453"></a><span class="hs-identifier">forkHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-type">HandlerFor</span></a><span> </span><a href="#local-6989586621679219620"><span class="hs-identifier hs-type">site</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ error handler</span><span>
</span><a name="line-454"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-type">HandlerFor</span></a><span> </span><a href="#local-6989586621679219620"><span class="hs-identifier hs-type">site</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-type">HandlerFor</span></a><span> </span><a href="#local-6989586621679219620"><span class="hs-identifier hs-type">site</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-456"></a><a name="forkHandler"><a href="Yesod.Core.Handler.html#forkHandler"><span class="hs-identifier">forkHandler</span></a></a><span> </span><a name="local-6989586621679219696"><a href="#local-6989586621679219696"><span class="hs-identifier">onErr</span></a></a><span> </span><a name="local-6989586621679219697"><a href="#local-6989586621679219697"><span class="hs-identifier">handler</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-457"></a><span>    </span><a name="local-6989586621679219698"><a href="#local-6989586621679219698"><span class="hs-identifier">yesRunner</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#handlerToIO"><span class="hs-identifier hs-var">handlerToIO</span></a><span>
</span><a name="line-458"></a><span>    </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftResourceT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">resourceForkIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-459"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">handle</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219698"><span class="hs-identifier hs-var">yesRunner</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679219696"><span class="hs-identifier hs-var">onErr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219698"><span class="hs-identifier hs-var">yesRunner</span></a><span> </span><a href="#local-6989586621679219697"><span class="hs-identifier hs-var">handler</span></a><span class="hs-special">)</span><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span class="hs-comment">-- | Redirect to the given route.</span><span>
</span><a name="line-462"></a><span class="hs-comment">-- HTTP status code 303 for HTTP 1.1 clients and 302 for HTTP 1.0</span><span>
</span><a name="line-463"></a><span class="hs-comment">-- This is the appropriate choice for a get-following-post</span><span>
</span><a name="line-464"></a><span class="hs-comment">-- technique, which should be the usual use case.</span><span>
</span><a name="line-465"></a><span class="hs-comment">--</span><span>
</span><a name="line-466"></a><span class="hs-comment">-- If you want direct control of the final status code, or need a different</span><span>
</span><a name="line-467"></a><span class="hs-comment">-- status code, please use 'redirectWith'.</span><span>
</span><a name="line-468"></a><span class="hs-identifier">redirect</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219617"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219617"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219618"><span class="hs-identifier hs-type">url</span></a><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span>         </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219618"><span class="hs-identifier hs-type">url</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219617"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219619"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-470"></a><a name="redirect"><a href="Yesod.Core.Handler.html#redirect"><span class="hs-identifier">redirect</span></a></a><span> </span><a name="local-6989586621679219699"><a href="#local-6989586621679219699"><span class="hs-identifier">url</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-471"></a><span>    </span><a name="local-6989586621679219700"><a href="#local-6989586621679219700"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#waiRequest"><span class="hs-identifier hs-var">waiRequest</span></a><span>
</span><a name="line-472"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679219701"><a href="#local-6989586621679219701"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-473"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">W.httpVersion</span><span> </span><a href="#local-6989586621679219700"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">H.http11</span><span>
</span><a name="line-474"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">H.status303</span><span>
</span><a name="line-475"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">H.status302</span><span>
</span><a name="line-476"></a><span>    </span><a href="Yesod.Core.Handler.html#redirectWith"><span class="hs-identifier hs-var">redirectWith</span></a><span> </span><a href="#local-6989586621679219701"><span class="hs-identifier hs-var">status</span></a><span> </span><a href="#local-6989586621679219699"><span class="hs-identifier hs-var">url</span></a><span>
</span><a name="line-477"></a><span>
</span><a name="line-478"></a><span class="hs-comment">-- | Redirect to the given URL with the specified status code.</span><span>
</span><a name="line-479"></a><span class="hs-identifier">redirectWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219614"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219614"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219615"><span class="hs-identifier hs-type">url</span></a><span class="hs-special">)</span><span>
</span><a name="line-480"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">H.Status</span><span>
</span><a name="line-481"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219615"><span class="hs-identifier hs-type">url</span></a><span>
</span><a name="line-482"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219614"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219616"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-483"></a><a name="redirectWith"><a href="Yesod.Core.Handler.html#redirectWith"><span class="hs-identifier">redirectWith</span></a></a><span> </span><a name="local-6989586621679219702"><a href="#local-6989586621679219702"><span class="hs-identifier">status</span></a></a><span> </span><a name="local-6989586621679219703"><a href="#local-6989586621679219703"><span class="hs-identifier">url</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-484"></a><span>    </span><a name="local-6989586621679219704"><a href="#local-6989586621679219704"><span class="hs-identifier">urlText</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier hs-var">toTextUrl</span></a><span> </span><a href="#local-6989586621679219703"><span class="hs-identifier hs-var">url</span></a><span>
</span><a name="line-485"></a><span>    </span><a href="Yesod.Core.Handler.html#handlerError"><span class="hs-identifier hs-var">handlerError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#HCRedirect"><span class="hs-identifier hs-var">HCRedirect</span></a><span> </span><a href="#local-6989586621679219702"><span class="hs-identifier hs-var">status</span></a><span> </span><a href="#local-6989586621679219704"><span class="hs-identifier hs-var">urlText</span></a><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span class="hs-identifier">ultDestKey</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-488"></a><a name="ultDestKey"><a href="Yesod.Core.Handler.html#ultDestKey"><span class="hs-identifier">ultDestKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;_ULT&quot;</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-comment">-- | Sets the ultimate destination variable to the given route.</span><span>
</span><a name="line-491"></a><span class="hs-comment">--</span><span>
</span><a name="line-492"></a><span class="hs-comment">-- An ultimate destination is stored in the user session and can be loaded</span><span>
</span><a name="line-493"></a><span class="hs-comment">-- later by 'redirectUltDest'.</span><span>
</span><a name="line-494"></a><span class="hs-identifier">setUltDest</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219612"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219612"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219613"><span class="hs-identifier hs-type">url</span></a><span class="hs-special">)</span><span>
</span><a name="line-495"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219613"><span class="hs-identifier hs-type">url</span></a><span>
</span><a name="line-496"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219612"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-497"></a><a name="setUltDest"><a href="Yesod.Core.Handler.html#setUltDest"><span class="hs-identifier">setUltDest</span></a></a><span> </span><a name="local-6989586621679219705"><a href="#local-6989586621679219705"><span class="hs-identifier">url</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-498"></a><span>    </span><a name="local-6989586621679219706"><a href="#local-6989586621679219706"><span class="hs-identifier">urlText</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier hs-var">toTextUrl</span></a><span> </span><a href="#local-6989586621679219705"><span class="hs-identifier hs-var">url</span></a><span>
</span><a name="line-499"></a><span>    </span><a href="Yesod.Core.Handler.html#setSession"><span class="hs-identifier hs-var">setSession</span></a><span> </span><a href="Yesod.Core.Handler.html#ultDestKey"><span class="hs-identifier hs-var">ultDestKey</span></a><span> </span><a href="#local-6989586621679219706"><span class="hs-identifier hs-var">urlText</span></a><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span class="hs-comment">-- | Same as 'setUltDest', but uses the current page.</span><span>
</span><a name="line-502"></a><span class="hs-comment">--</span><span>
</span><a name="line-503"></a><span class="hs-comment">-- If this is a 404 handler, there is no current page, and then this call does</span><span>
</span><a name="line-504"></a><span class="hs-comment">-- nothing.</span><span>
</span><a name="line-505"></a><span class="hs-identifier">setUltDestCurrent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219611"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219611"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-506"></a><a name="setUltDestCurrent"><a href="Yesod.Core.Handler.html#setUltDestCurrent"><span class="hs-identifier">setUltDestCurrent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-507"></a><span>    </span><a name="local-6989586621679219707"><a href="#local-6989586621679219707"><span class="hs-identifier">route</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#getCurrentRoute"><span class="hs-identifier hs-var">getCurrentRoute</span></a><span>
</span><a name="line-508"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679219707"><span class="hs-identifier hs-var">route</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-509"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679219708"><a href="#local-6989586621679219708"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-511"></a><span>            </span><a name="local-6989586621679219709"><a href="#local-6989586621679219709"><span class="hs-identifier">gets'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">reqGetParams</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#getRequest"><span class="hs-identifier hs-var">getRequest</span></a><span>
</span><a name="line-512"></a><span>            </span><a href="Yesod.Core.Handler.html#setUltDest"><span class="hs-identifier hs-var">setUltDest</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219708"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679219709"><span class="hs-identifier hs-var">gets'</span></a><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span class="hs-comment">-- | Sets the ultimate destination to the referer request header, if present.</span><span>
</span><a name="line-515"></a><span class="hs-comment">--</span><span>
</span><a name="line-516"></a><span class="hs-comment">-- This function will not overwrite an existing ultdest.</span><span>
</span><a name="line-517"></a><span class="hs-identifier">setUltDestReferer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219610"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219610"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-518"></a><a name="setUltDestReferer"><a href="Yesod.Core.Handler.html#setUltDestReferer"><span class="hs-identifier">setUltDestReferer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-519"></a><span>    </span><a name="local-6989586621679219711"><a href="#local-6989586621679219711"><span class="hs-identifier">mdest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#lookupSession"><span class="hs-identifier hs-var">lookupSession</span></a><span> </span><a href="Yesod.Core.Handler.html#ultDestKey"><span class="hs-identifier hs-var">ultDestKey</span></a><span>
</span><a name="line-520"></a><span>    </span><span class="hs-identifier hs-var">maybe</span><span>
</span><a name="line-521"></a><span>        </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#waiRequest"><span class="hs-identifier hs-var">waiRequest</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219710"><span class="hs-identifier hs-var">setUltDestBS</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-string">&quot;referer&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">W.requestHeaders</span><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-523"></a><span>        </span><a href="#local-6989586621679219711"><span class="hs-identifier hs-var">mdest</span></a><span>
</span><a name="line-524"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-525"></a><span>    </span><a name="local-6989586621679219710"><a href="#local-6989586621679219710"><span class="hs-identifier">setUltDestBS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#setUltDest"><span class="hs-identifier hs-var">setUltDest</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S8.unpack</span><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span class="hs-comment">-- | Redirect to the ultimate destination in the user's session. Clear the</span><span>
</span><a name="line-528"></a><span class="hs-comment">-- value from the session.</span><span>
</span><a name="line-529"></a><span class="hs-comment">--</span><span>
</span><a name="line-530"></a><span class="hs-comment">-- The ultimate destination is set with 'setUltDest'.</span><span>
</span><a name="line-531"></a><span class="hs-comment">--</span><span>
</span><a name="line-532"></a><span class="hs-comment">-- This function uses 'redirect', and thus will perform a temporary redirect to</span><span>
</span><a name="line-533"></a><span class="hs-comment">-- a GET request.</span><span>
</span><a name="line-534"></a><span class="hs-identifier">redirectUltDest</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219607"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219608"><span class="hs-identifier hs-type">url</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219607"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-535"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219608"><span class="hs-identifier hs-type">url</span></a><span> </span><span class="hs-comment">-- ^ default destination if nothing in session</span><span>
</span><a name="line-536"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219607"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219609"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-537"></a><a name="redirectUltDest"><a href="Yesod.Core.Handler.html#redirectUltDest"><span class="hs-identifier">redirectUltDest</span></a></a><span> </span><a name="local-6989586621679219712"><a href="#local-6989586621679219712"><span class="hs-identifier">defaultDestination</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-538"></a><span>    </span><a name="local-6989586621679219713"><a href="#local-6989586621679219713"><span class="hs-identifier">mdest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#lookupSession"><span class="hs-identifier hs-var">lookupSession</span></a><span> </span><a href="Yesod.Core.Handler.html#ultDestKey"><span class="hs-identifier hs-var">ultDestKey</span></a><span>
</span><a name="line-539"></a><span>    </span><a href="Yesod.Core.Handler.html#deleteSession"><span class="hs-identifier hs-var">deleteSession</span></a><span> </span><a href="Yesod.Core.Handler.html#ultDestKey"><span class="hs-identifier hs-var">ultDestKey</span></a><span>
</span><a name="line-540"></a><span>    </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#redirect"><span class="hs-identifier hs-var">redirect</span></a><span> </span><a href="#local-6989586621679219712"><span class="hs-identifier hs-var">defaultDestination</span></a><span class="hs-special">)</span><span> </span><a href="Yesod.Core.Handler.html#redirect"><span class="hs-identifier hs-var">redirect</span></a><span> </span><a href="#local-6989586621679219713"><span class="hs-identifier hs-var">mdest</span></a><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span class="hs-comment">-- | Remove a previously set ultimate destination. See 'setUltDest'.</span><span>
</span><a name="line-543"></a><span class="hs-identifier">clearUltDest</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219606"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219606"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-544"></a><a name="clearUltDest"><a href="Yesod.Core.Handler.html#clearUltDest"><span class="hs-identifier">clearUltDest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#deleteSession"><span class="hs-identifier hs-var">deleteSession</span></a><span> </span><a href="Yesod.Core.Handler.html#ultDestKey"><span class="hs-identifier hs-var">ultDestKey</span></a><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span class="hs-identifier">msgKey</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-547"></a><a name="msgKey"><a href="Yesod.Core.Handler.html#msgKey"><span class="hs-identifier">msgKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;_MSG&quot;</span><span>
</span><a name="line-548"></a><span>
</span><a name="line-549"></a><span class="hs-comment">-- | Adds a status and message in the user's session.</span><span>
</span><a name="line-550"></a><span class="hs-comment">--</span><span>
</span><a name="line-551"></a><span class="hs-comment">-- See 'getMessages'.</span><span>
</span><a name="line-552"></a><span class="hs-comment">--</span><span>
</span><a name="line-553"></a><span class="hs-comment">-- @since 1.4.20</span><span>
</span><a name="line-554"></a><span class="hs-identifier">addMessage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219605"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-555"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-comment">-- ^ status</span><span>
</span><a name="line-556"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Html</span><span> </span><span class="hs-comment">-- ^ message</span><span>
</span><a name="line-557"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219605"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-558"></a><a name="addMessage"><a href="Yesod.Core.Handler.html#addMessage"><span class="hs-identifier">addMessage</span></a></a><span> </span><a name="local-6989586621679219714"><a href="#local-6989586621679219714"><span class="hs-identifier">status</span></a></a><span> </span><a name="local-6989586621679219715"><a href="#local-6989586621679219715"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-559"></a><span>    </span><a name="local-6989586621679219718"><a href="#local-6989586621679219718"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#lookupSessionBS"><span class="hs-identifier hs-var">lookupSessionBS</span></a><span> </span><a href="Yesod.Core.Handler.html#msgKey"><span class="hs-identifier hs-var">msgKey</span></a><span>
</span><a name="line-560"></a><span>    </span><a href="Yesod.Core.Handler.html#setSessionBS"><span class="hs-identifier hs-var">setSessionBS</span></a><span> </span><a href="Yesod.Core.Handler.html#msgKey"><span class="hs-identifier hs-var">msgKey</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679219716"><span class="hs-identifier hs-var">addMsg</span></a><span> </span><a href="#local-6989586621679219718"><span class="hs-identifier hs-var">val</span></a><span>
</span><a name="line-561"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-562"></a><span>    </span><a name="local-6989586621679219716"><a href="#local-6989586621679219716"><span class="hs-identifier">addMsg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-6989586621679219717"><span class="hs-identifier hs-var">msg'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S.append</span><span> </span><a href="#local-6989586621679219717"><span class="hs-identifier hs-var">msg'</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S.cons</span><span> </span><span class="hs-identifier hs-var">W8._nul</span><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>    </span><a name="local-6989586621679219717"><a href="#local-6989586621679219717"><span class="hs-identifier">msg'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.append</span><span>
</span><a name="line-564"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><a href="#local-6989586621679219714"><span class="hs-identifier hs-var">status</span></a><span class="hs-special">)</span><span>
</span><a name="line-565"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">W8._nul</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">S.cons</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">L.toStrict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">renderHtml</span><span> </span><a href="#local-6989586621679219715"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span class="hs-comment">-- | Adds a message in the user's session but uses RenderMessage to allow for i18n</span><span>
</span><a name="line-568"></a><span class="hs-comment">--</span><span>
</span><a name="line-569"></a><span class="hs-comment">-- See 'getMessages'.</span><span>
</span><a name="line-570"></a><span class="hs-comment">--</span><span>
</span><a name="line-571"></a><span class="hs-comment">-- @since 1.4.20</span><span>
</span><a name="line-572"></a><span class="hs-identifier">addMessageI</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219603"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RenderMessage</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219603"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219604"><span class="hs-identifier hs-type">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219604"><span class="hs-identifier hs-type">msg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219603"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-574"></a><a name="addMessageI"><a href="Yesod.Core.Handler.html#addMessageI"><span class="hs-identifier">addMessageI</span></a></a><span> </span><a name="local-6989586621679219719"><a href="#local-6989586621679219719"><span class="hs-identifier">status</span></a></a><span> </span><a name="local-6989586621679219720"><a href="#local-6989586621679219720"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-575"></a><span>    </span><a name="local-6989586621679219721"><a href="#local-6989586621679219721"><span class="hs-identifier">mr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#getMessageRender"><span class="hs-identifier hs-var">getMessageRender</span></a><span>
</span><a name="line-576"></a><span>    </span><a href="Yesod.Core.Handler.html#addMessage"><span class="hs-identifier hs-var">addMessage</span></a><span> </span><a href="#local-6989586621679219719"><span class="hs-identifier hs-var">status</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toHtml</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679219721"><span class="hs-identifier hs-var">mr</span></a><span> </span><a href="#local-6989586621679219720"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span class="hs-comment">-- | Gets all messages in the user's session, and then clears the variable.</span><span>
</span><a name="line-579"></a><span class="hs-comment">--</span><span>
</span><a name="line-580"></a><span class="hs-comment">-- See 'addMessage'.</span><span>
</span><a name="line-581"></a><span class="hs-comment">--</span><span>
</span><a name="line-582"></a><span class="hs-comment">-- @since 1.4.20</span><span>
</span><a name="line-583"></a><span class="hs-identifier">getMessages</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219602"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219602"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Html</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-584"></a><a name="getMessages"><a href="Yesod.Core.Handler.html#getMessages"><span class="hs-identifier">getMessages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-585"></a><span>    </span><a name="local-6989586621679219728"><a href="#local-6989586621679219728"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#lookupSessionBS"><span class="hs-identifier hs-var">lookupSessionBS</span></a><span> </span><a href="Yesod.Core.Handler.html#msgKey"><span class="hs-identifier hs-var">msgKey</span></a><span>
</span><a name="line-586"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679219729"><a href="#local-6989586621679219729"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679219722"><span class="hs-identifier hs-var">enlist</span></a><span> </span><a href="#local-6989586621679219728"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-587"></a><span>    </span><a href="Yesod.Core.Handler.html#deleteSession"><span class="hs-identifier hs-var">deleteSession</span></a><span> </span><a href="Yesod.Core.Handler.html#msgKey"><span class="hs-identifier hs-var">msgKey</span></a><span>
</span><a name="line-588"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679219729"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-589"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-590"></a><span>    </span><a name="local-6989586621679219722"><a href="#local-6989586621679219722"><span class="hs-identifier">enlist</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219723"><span class="hs-identifier hs-var">pairup</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S.split</span><span> </span><span class="hs-identifier hs-var">W8._nul</span><span>
</span><a name="line-591"></a><span>    </span><a name="local-6989586621679219723"><a href="#local-6989586621679219723"><span class="hs-identifier">pairup</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-592"></a><span>    </span><span class="hs-identifier">pairup</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">_</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-593"></a><span>    </span><span class="hs-identifier">pairup</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679219725"><a href="#local-6989586621679219725"><span class="hs-identifier">s</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679219726"><a href="#local-6989586621679219726"><span class="hs-identifier">v</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679219727"><a href="#local-6989586621679219727"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219724"><span class="hs-identifier hs-var">decode</span></a><span> </span><a href="#local-6989586621679219725"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">preEscapedToHtml</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219724"><span class="hs-identifier hs-var">decode</span></a><span> </span><a href="#local-6989586621679219726"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679219723"><span class="hs-identifier hs-var">pairup</span></a><span> </span><a href="#local-6989586621679219727"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-594"></a><span>    </span><a name="local-6989586621679219724"><a href="#local-6989586621679219724"><span class="hs-identifier">decode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">decodeUtf8With</span><span> </span><span class="hs-identifier hs-var">lenientDecode</span><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span class="hs-comment">-- | Calls 'addMessage' with an empty status</span><span>
</span><a name="line-597"></a><span class="hs-identifier">setMessage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219601"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Html</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219601"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-598"></a><a name="setMessage"><a href="Yesod.Core.Handler.html#setMessage"><span class="hs-identifier">setMessage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#addMessage"><span class="hs-identifier hs-var">addMessage</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-599"></a><span>
</span><a name="line-600"></a><span class="hs-comment">-- | Calls 'addMessageI' with an empty status</span><span>
</span><a name="line-601"></a><span class="hs-identifier">setMessageI</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219599"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RenderMessage</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219599"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219600"><span class="hs-identifier hs-type">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219600"><span class="hs-identifier hs-type">msg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219599"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-603"></a><a name="setMessageI"><a href="Yesod.Core.Handler.html#setMessageI"><span class="hs-identifier">setMessageI</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#addMessageI"><span class="hs-identifier hs-var">addMessageI</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span class="hs-comment">-- | Gets just the last message in the user's session,</span><span>
</span><a name="line-606"></a><span class="hs-comment">-- discards the rest and the status</span><span>
</span><a name="line-607"></a><span class="hs-identifier">getMessage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219598"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219598"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Html</span><span class="hs-special">)</span><span>
</span><a name="line-608"></a><a name="getMessage"><a href="Yesod.Core.Handler.html#getMessage"><span class="hs-identifier">getMessage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">listToMaybe</span><span class="hs-special">)</span><span> </span><a href="Yesod.Core.Handler.html#getMessages"><span class="hs-identifier hs-var">getMessages</span></a><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><span class="hs-comment">-- | Bypass remaining handler code and output the given file.</span><span>
</span><a name="line-611"></a><span class="hs-comment">--</span><span>
</span><a name="line-612"></a><span class="hs-comment">-- For some backends, this is more efficient than reading in the file to</span><span>
</span><a name="line-613"></a><span class="hs-comment">-- memory, since they can optimize file sending via a system call to sendfile.</span><span>
</span><a name="line-614"></a><span class="hs-identifier">sendFile</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219596"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Types.html#ContentType"><span class="hs-identifier hs-type">ContentType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219596"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219597"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-615"></a><a name="sendFile"><a href="Yesod.Core.Handler.html#sendFile"><span class="hs-identifier">sendFile</span></a></a><span> </span><a name="local-6989586621679219730"><a href="#local-6989586621679219730"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621679219731"><a href="#local-6989586621679219731"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#handlerError"><span class="hs-identifier hs-var">handlerError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#HCSendFile"><span class="hs-identifier hs-var">HCSendFile</span></a><span> </span><a href="#local-6989586621679219730"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621679219731"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-616"></a><span>
</span><a name="line-617"></a><span class="hs-comment">-- | Same as 'sendFile', but only sends part of a file.</span><span>
</span><a name="line-618"></a><span class="hs-identifier">sendFilePart</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219594"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-619"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Types.html#ContentType"><span class="hs-identifier hs-type">ContentType</span></a><span>
</span><a name="line-620"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-621"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-comment">-- ^ offset</span><span>
</span><a name="line-622"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-comment">-- ^ count</span><span>
</span><a name="line-623"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219594"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219595"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-624"></a><a name="sendFilePart"><a href="Yesod.Core.Handler.html#sendFilePart"><span class="hs-identifier">sendFilePart</span></a></a><span> </span><a name="local-6989586621679219732"><a href="#local-6989586621679219732"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621679219733"><a href="#local-6989586621679219733"><span class="hs-identifier">fp</span></a></a><span> </span><a name="local-6989586621679219734"><a href="#local-6989586621679219734"><span class="hs-identifier">off</span></a></a><span> </span><a name="local-6989586621679219735"><a href="#local-6989586621679219735"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-625"></a><span>    </span><a name="local-6989586621679219873"><a href="#local-6989586621679219873"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PC.getFileStatus</span><span> </span><a href="#local-6989586621679219733"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-626"></a><span>    </span><a href="Yesod.Core.Handler.html#handlerError"><span class="hs-identifier hs-var">handlerError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#HCSendFile"><span class="hs-identifier hs-var">HCSendFile</span></a><span> </span><a href="#local-6989586621679219732"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621679219733"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">W.FilePart</span><span>
</span><a name="line-627"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">W.filePartOffset</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219734"><span class="hs-identifier hs-var">off</span></a><span>
</span><a name="line-628"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">W.filePartByteCount</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219735"><span class="hs-identifier hs-var">count</span></a><span>
</span><a name="line-629"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">W.filePartFileSize</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PC.fileSize</span><span> </span><a href="#local-6989586621679219873"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-630"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span class="hs-comment">-- | Bypass remaining handler code and output the given content with a 200</span><span>
</span><a name="line-633"></a><span class="hs-comment">-- status code.</span><span>
</span><a name="line-634"></a><span class="hs-identifier">sendResponse</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219591"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Content.html#ToTypedContent"><span class="hs-identifier hs-type">ToTypedContent</span></a><span> </span><a href="#local-6989586621679219592"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219592"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219591"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219593"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-635"></a><a name="sendResponse"><a href="Yesod.Core.Handler.html#sendResponse"><span class="hs-identifier">sendResponse</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#handlerError"><span class="hs-identifier hs-var">handlerError</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Types.html#HCContent"><span class="hs-identifier hs-var">HCContent</span></a><span> </span><span class="hs-identifier hs-var">H.status200</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Content.html#toTypedContent"><span class="hs-identifier hs-var">toTypedContent</span></a><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span class="hs-comment">-- | Bypass remaining handler code and output the given content with the given</span><span>
</span><a name="line-638"></a><span class="hs-comment">-- status code.</span><span>
</span><a name="line-639"></a><span class="hs-identifier">sendResponseStatus</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219588"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Content.html#ToTypedContent"><span class="hs-identifier hs-type">ToTypedContent</span></a><span> </span><a href="#local-6989586621679219589"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">H.Status</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219589"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219588"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219590"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-640"></a><a name="sendResponseStatus"><a href="Yesod.Core.Handler.html#sendResponseStatus"><span class="hs-identifier">sendResponseStatus</span></a></a><span> </span><a name="local-6989586621679220280"><a href="#local-6989586621679220280"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#handlerError"><span class="hs-identifier hs-var">handlerError</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Types.html#HCContent"><span class="hs-identifier hs-var">HCContent</span></a><span> </span><a href="#local-6989586621679220280"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Content.html#toTypedContent"><span class="hs-identifier hs-var">toTypedContent</span></a><span>
</span><a name="line-641"></a><span>
</span><a name="line-642"></a><span class="hs-comment">-- | Bypass remaining handler code and output the given JSON with the given</span><span>
</span><a name="line-643"></a><span class="hs-comment">-- status code.</span><span>
</span><a name="line-644"></a><span class="hs-comment">--</span><span>
</span><a name="line-645"></a><span class="hs-comment">-- @since 1.4.18</span><span>
</span><a name="line-646"></a><span class="hs-identifier">sendStatusJSON</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219585"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ToJSON</span><span> </span><a href="#local-6989586621679219586"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">H.Status</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219586"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219585"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219587"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-647"></a><a name="sendStatusJSON"><a href="Yesod.Core.Handler.html#sendStatusJSON"><span class="hs-identifier">sendStatusJSON</span></a></a><span> </span><a name="local-6989586621679220281"><a href="#local-6989586621679220281"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679220282"><a href="#local-6989586621679220282"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#sendResponseStatus"><span class="hs-identifier hs-var">sendResponseStatus</span></a><span> </span><a href="#local-6989586621679220281"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toEncoding</span><span> </span><a href="#local-6989586621679220282"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-648"></a><span>
</span><a name="line-649"></a><span class="hs-comment">-- | Send a 201 &quot;Created&quot; response with the given route as the Location</span><span>
</span><a name="line-650"></a><span class="hs-comment">-- response header.</span><span>
</span><a name="line-651"></a><span class="hs-identifier">sendResponseCreated</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219583"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219583"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219583"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219584"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-652"></a><a name="sendResponseCreated"><a href="Yesod.Core.Handler.html#sendResponseCreated"><span class="hs-identifier">sendResponseCreated</span></a></a><span> </span><a name="local-6989586621679220283"><a href="#local-6989586621679220283"><span class="hs-identifier">url</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-653"></a><span>    </span><a name="local-6989586621679220284"><a href="#local-6989586621679220284"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#getUrlRender"><span class="hs-identifier hs-var">getUrlRender</span></a><span>
</span><a name="line-654"></a><span>    </span><a href="Yesod.Core.Handler.html#handlerError"><span class="hs-identifier hs-var">handlerError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#HCCreated"><span class="hs-identifier hs-var">HCCreated</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679220284"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679220283"><span class="hs-identifier hs-var">url</span></a><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span class="hs-comment">-- | Bypass remaining handler code and output no content with a 204 status code.</span><span>
</span><a name="line-657"></a><span class="hs-comment">--</span><span>
</span><a name="line-658"></a><span class="hs-comment">-- @since 1.6.9</span><span>
</span><a name="line-659"></a><span class="hs-identifier">sendResponseNoContent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219581"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219581"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219582"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-660"></a><a name="sendResponseNoContent"><a href="Yesod.Core.Handler.html#sendResponseNoContent"><span class="hs-identifier">sendResponseNoContent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#sendWaiResponse"><span class="hs-identifier hs-var">sendWaiResponse</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">W.responseBuilder</span><span> </span><span class="hs-identifier hs-var">H.status204</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span class="hs-comment">-- | Send a 'W.Response'. Please note: this function is rarely</span><span>
</span><a name="line-663"></a><span class="hs-comment">-- necessary, and will /disregard/ any changes to response headers and session</span><span>
</span><a name="line-664"></a><span class="hs-comment">-- that you have already specified. This function short-circuits. It should be</span><span>
</span><a name="line-665"></a><span class="hs-comment">-- considered only for very specific needs. If you are not sure if you need it,</span><span>
</span><a name="line-666"></a><span class="hs-comment">-- you don't.</span><span>
</span><a name="line-667"></a><span class="hs-identifier">sendWaiResponse</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219579"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">W.Response</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219579"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219580"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-668"></a><a name="sendWaiResponse"><a href="Yesod.Core.Handler.html#sendWaiResponse"><span class="hs-identifier">sendWaiResponse</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#handlerError"><span class="hs-identifier hs-var">handlerError</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Types.html#HCWai"><span class="hs-identifier hs-var">HCWai</span></a><span>
</span><a name="line-669"></a><span>
</span><a name="line-670"></a><span class="hs-comment">-- | Switch over to handling the current request with a WAI @Application@.</span><span>
</span><a name="line-671"></a><span class="hs-comment">--</span><span>
</span><a name="line-672"></a><span class="hs-comment">-- @since 1.2.17</span><span>
</span><a name="line-673"></a><span class="hs-identifier">sendWaiApplication</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219577"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">W.Application</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219577"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219578"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-674"></a><a name="sendWaiApplication"><a href="Yesod.Core.Handler.html#sendWaiApplication"><span class="hs-identifier">sendWaiApplication</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#handlerError"><span class="hs-identifier hs-var">handlerError</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Types.html#HCWaiApp"><span class="hs-identifier hs-var">HCWaiApp</span></a><span>
</span><a name="line-675"></a><span>
</span><a name="line-676"></a><span class="hs-comment">-- | Send a raw response without conduit. This is used for cases such as</span><span>
</span><a name="line-677"></a><span class="hs-comment">-- WebSockets. Requires WAI 3.0 or later, and a web server which supports raw</span><span>
</span><a name="line-678"></a><span class="hs-comment">-- responses (e.g., Warp).</span><span>
</span><a name="line-679"></a><span class="hs-comment">--</span><span>
</span><a name="line-680"></a><span class="hs-comment">-- @since 1.2.16</span><span>
</span><a name="line-681"></a><span class="hs-identifier">sendRawResponseNoConduit</span><span>
</span><a name="line-682"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219575"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679219575"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-683"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S8.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219575"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-684"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219575"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219576"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-685"></a><a name="sendRawResponseNoConduit"><a href="Yesod.Core.Handler.html#sendRawResponseNoConduit"><span class="hs-identifier">sendRawResponseNoConduit</span></a></a><span> </span><a name="local-6989586621679220285"><a href="#local-6989586621679220285"><span class="hs-identifier">raw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679220287"><a href="#local-6989586621679220287"><span class="hs-identifier">runInIO</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-686"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#HCWai"><span class="hs-identifier hs-var">HCWai</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">W.responseRaw</span><span> </span><a href="#local-6989586621679220286"><span class="hs-identifier hs-var">fallback</span></a><span>
</span><a name="line-687"></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679220288"><a href="#local-6989586621679220288"><span class="hs-identifier">src</span></a></a><span> </span><a name="local-6989586621679220289"><a href="#local-6989586621679220289"><span class="hs-identifier">sink</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679220287"><span class="hs-identifier hs-var">runInIO</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679220285"><span class="hs-identifier hs-var">raw</span></a><span> </span><a href="#local-6989586621679220288"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-6989586621679220289"><span class="hs-identifier hs-var">sink</span></a><span class="hs-special">)</span><span>
</span><a name="line-688"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-689"></a><span>    </span><a name="local-6989586621679220286"><a href="#local-6989586621679220286"><span class="hs-identifier">fallback</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">W.responseLBS</span><span> </span><span class="hs-identifier hs-var">H.status500</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-string">&quot;Content-Type&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;text/plain&quot;</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-690"></a><span>        </span><span class="hs-string">&quot;sendRawResponse: backend does not support raw responses&quot;</span><span>
</span><a name="line-691"></a><span>
</span><a name="line-692"></a><span class="hs-comment">-- | Send a raw response. This is used for cases such as WebSockets. Requires</span><span>
</span><a name="line-693"></a><span class="hs-comment">-- WAI 2.1 or later, and a web server which supports raw responses (e.g.,</span><span>
</span><a name="line-694"></a><span class="hs-comment">-- Warp).</span><span>
</span><a name="line-695"></a><span class="hs-comment">--</span><span>
</span><a name="line-696"></a><span class="hs-comment">-- @since 1.2.7</span><span>
</span><a name="line-697"></a><span class="hs-identifier">sendRawResponse</span><span>
</span><a name="line-698"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219573"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679219573"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-699"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ConduitT</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span> </span><span class="hs-identifier hs-type">Void</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219573"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-700"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219573"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219574"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-701"></a><a name="sendRawResponse"><a href="Yesod.Core.Handler.html#sendRawResponse"><span class="hs-identifier">sendRawResponse</span></a></a><span> </span><a name="local-6989586621679220290"><a href="#local-6989586621679220290"><span class="hs-identifier">raw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679220295"><a href="#local-6989586621679220295"><span class="hs-identifier">runInIO</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-702"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#HCWai"><span class="hs-identifier hs-var">HCWai</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">W.responseRaw</span><span> </span><a href="#local-6989586621679220291"><span class="hs-identifier hs-var">fallback</span></a><span>
</span><a name="line-703"></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679220296"><a href="#local-6989586621679220296"><span class="hs-identifier">src</span></a></a><span> </span><a name="local-6989586621679220297"><a href="#local-6989586621679220297"><span class="hs-identifier">sink</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679220295"><span class="hs-identifier hs-var">runInIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679220290"><span class="hs-identifier hs-var">raw</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679220292"><span class="hs-identifier hs-var">src'</span></a><span> </span><a href="#local-6989586621679220296"><span class="hs-identifier hs-var">src</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CL.mapM_</span><span> </span><a href="#local-6989586621679220297"><span class="hs-identifier hs-var">sink</span></a><span class="hs-special">)</span><span>
</span><a name="line-704"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-705"></a><span>    </span><a name="local-6989586621679220291"><a href="#local-6989586621679220291"><span class="hs-identifier">fallback</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">W.responseLBS</span><span> </span><span class="hs-identifier hs-var">H.status500</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-string">&quot;Content-Type&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;text/plain&quot;</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-706"></a><span>        </span><span class="hs-string">&quot;sendRawResponse: backend does not support raw responses&quot;</span><span>
</span><a name="line-707"></a><span>    </span><a name="local-6989586621679220292"><a href="#local-6989586621679220292"><span class="hs-identifier">src'</span></a></a><span> </span><a name="local-6989586621679220293"><a href="#local-6989586621679220293"><span class="hs-identifier">src</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-708"></a><span>        </span><a name="local-6989586621679220294"><a href="#local-6989586621679220294"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><a href="#local-6989586621679220293"><span class="hs-identifier hs-var">src</span></a><span>
</span><a name="line-709"></a><span>        </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S.null</span><span> </span><a href="#local-6989586621679220294"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-710"></a><span>            </span><span class="hs-identifier hs-var">yield</span><span> </span><a href="#local-6989586621679220294"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-711"></a><span>            </span><a href="#local-6989586621679220292"><span class="hs-identifier hs-var">src'</span></a><span> </span><a href="#local-6989586621679220293"><span class="hs-identifier hs-var">src</span></a><span>
</span><a name="line-712"></a><span>
</span><a name="line-713"></a><span class="hs-comment">-- | Send a 304 not modified response immediately. This is a short-circuiting</span><span>
</span><a name="line-714"></a><span class="hs-comment">-- action.</span><span>
</span><a name="line-715"></a><span class="hs-comment">--</span><span>
</span><a name="line-716"></a><span class="hs-comment">-- @since 1.4.4</span><span>
</span><a name="line-717"></a><span class="hs-identifier">notModified</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219571"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219571"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219572"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-718"></a><a name="notModified"><a href="Yesod.Core.Handler.html#notModified"><span class="hs-identifier">notModified</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#sendWaiResponse"><span class="hs-identifier hs-var">sendWaiResponse</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">W.responseBuilder</span><span> </span><span class="hs-identifier hs-var">H.status304</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-719"></a><span>
</span><a name="line-720"></a><span class="hs-comment">-- | Return a 404 not found page. Also denotes no handler available.</span><span>
</span><a name="line-721"></a><span class="hs-identifier">notFound</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219569"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219569"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219570"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-722"></a><a name="notFound"><a href="Yesod.Core.Handler.html#notFound"><span class="hs-identifier">notFound</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#hcError"><span class="hs-identifier hs-var">hcError</span></a><span> </span><a href="Yesod.Core.Types.html#NotFound"><span class="hs-identifier hs-var">NotFound</span></a><span>
</span><a name="line-723"></a><span>
</span><a name="line-724"></a><span class="hs-comment">-- | Return a 405 method not supported page.</span><span>
</span><a name="line-725"></a><span class="hs-identifier">badMethod</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219567"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219567"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219568"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-726"></a><a name="badMethod"><a href="Yesod.Core.Handler.html#badMethod"><span class="hs-identifier">badMethod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-727"></a><span>    </span><a name="local-6989586621679220298"><a href="#local-6989586621679220298"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#waiRequest"><span class="hs-identifier hs-var">waiRequest</span></a><span>
</span><a name="line-728"></a><span>    </span><a href="Yesod.Core.Handler.html#hcError"><span class="hs-identifier hs-var">hcError</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#BadMethod"><span class="hs-identifier hs-var">BadMethod</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">W.requestMethod</span><span> </span><a href="#local-6989586621679220298"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-729"></a><span>
</span><a name="line-730"></a><span class="hs-comment">-- | Return a 401 status code</span><span>
</span><a name="line-731"></a><span class="hs-identifier">notAuthenticated</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219565"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219565"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219566"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-732"></a><a name="notAuthenticated"><a href="Yesod.Core.Handler.html#notAuthenticated"><span class="hs-identifier">notAuthenticated</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#hcError"><span class="hs-identifier hs-var">hcError</span></a><span> </span><a href="Yesod.Core.Types.html#NotAuthenticated"><span class="hs-identifier hs-var">NotAuthenticated</span></a><span>
</span><a name="line-733"></a><span>
</span><a name="line-734"></a><span class="hs-comment">-- | Return a 403 permission denied page.</span><span>
</span><a name="line-735"></a><span class="hs-identifier">permissionDenied</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219563"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219563"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219564"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-736"></a><a name="permissionDenied"><a href="Yesod.Core.Handler.html#permissionDenied"><span class="hs-identifier">permissionDenied</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#hcError"><span class="hs-identifier hs-var">hcError</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Types.html#PermissionDenied"><span class="hs-identifier hs-var">PermissionDenied</span></a><span>
</span><a name="line-737"></a><span>
</span><a name="line-738"></a><span class="hs-comment">-- | Return a 403 permission denied page.</span><span>
</span><a name="line-739"></a><span class="hs-identifier">permissionDeniedI</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RenderMessage</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219560"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219561"><span class="hs-identifier hs-type">msg</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219560"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-740"></a><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219561"><span class="hs-identifier hs-type">msg</span></a><span>
</span><a name="line-741"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219560"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219562"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-742"></a><a name="permissionDeniedI"><a href="Yesod.Core.Handler.html#permissionDeniedI"><span class="hs-identifier">permissionDeniedI</span></a></a><span> </span><a name="local-6989586621679220299"><a href="#local-6989586621679220299"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-743"></a><span>    </span><a name="local-6989586621679220300"><a href="#local-6989586621679220300"><span class="hs-identifier">mr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#getMessageRender"><span class="hs-identifier hs-var">getMessageRender</span></a><span>
</span><a name="line-744"></a><span>    </span><a href="Yesod.Core.Handler.html#permissionDenied"><span class="hs-identifier hs-var">permissionDenied</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679220300"><span class="hs-identifier hs-var">mr</span></a><span> </span><a href="#local-6989586621679220299"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span class="hs-comment">-- | Return a 400 invalid arguments page.</span><span>
</span><a name="line-747"></a><span class="hs-identifier">invalidArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219558"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219558"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219559"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-748"></a><a name="invalidArgs"><a href="Yesod.Core.Handler.html#invalidArgs"><span class="hs-identifier">invalidArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#hcError"><span class="hs-identifier hs-var">hcError</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Types.html#InvalidArgs"><span class="hs-identifier hs-var">InvalidArgs</span></a><span>
</span><a name="line-749"></a><span>
</span><a name="line-750"></a><span class="hs-comment">-- | Return a 400 invalid arguments page.</span><span>
</span><a name="line-751"></a><span class="hs-identifier">invalidArgsI</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219555"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RenderMessage</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219555"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219556"><span class="hs-identifier hs-type">msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679219556"><span class="hs-identifier hs-type">msg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219555"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219557"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-752"></a><a name="invalidArgsI"><a href="Yesod.Core.Handler.html#invalidArgsI"><span class="hs-identifier">invalidArgsI</span></a></a><span> </span><a name="local-6989586621679220301"><a href="#local-6989586621679220301"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-753"></a><span>    </span><a name="local-6989586621679220302"><a href="#local-6989586621679220302"><span class="hs-identifier">mr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#getMessageRender"><span class="hs-identifier hs-var">getMessageRender</span></a><span>
</span><a name="line-754"></a><span>    </span><a href="Yesod.Core.Handler.html#invalidArgs"><span class="hs-identifier hs-var">invalidArgs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679220302"><span class="hs-identifier hs-var">mr</span></a><span> </span><a href="#local-6989586621679220301"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-755"></a><span>
</span><a name="line-756"></a><span class="hs-comment">------- Headers</span><span>
</span><a name="line-757"></a><span class="hs-comment">-- | Set the cookie on the client.</span><span>
</span><a name="line-758"></a><span>
</span><a name="line-759"></a><span class="hs-identifier">setCookie</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219554"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">SetCookie</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219554"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-760"></a><a name="setCookie"><a href="Yesod.Core.Handler.html#setCookie"><span class="hs-identifier">setCookie</span></a></a><span> </span><a name="local-6989586621679220303"><a href="#local-6989586621679220303"><span class="hs-identifier">sc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-761"></a><span>  </span><a href="Yesod.Core.Handler.html#addHeaderInternal"><span class="hs-identifier hs-var">addHeaderInternal</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Types.html#DeleteCookie"><span class="hs-identifier hs-var">DeleteCookie</span></a><span> </span><a href="#local-6989586621679220304"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679220305"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">)</span><span>
</span><a name="line-762"></a><span>  </span><a href="Yesod.Core.Handler.html#addHeaderInternal"><span class="hs-identifier hs-var">addHeaderInternal</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Types.html#AddCookie"><span class="hs-identifier hs-var">AddCookie</span></a><span> </span><a href="#local-6989586621679220303"><span class="hs-identifier hs-var">sc</span></a><span class="hs-special">)</span><span>
</span><a name="line-763"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679220304"><a href="#local-6989586621679220304"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">setCookieName</span><span> </span><a href="#local-6989586621679220303"><span class="hs-identifier hs-var">sc</span></a><span>
</span><a name="line-764"></a><span>        </span><a name="local-6989586621679220305"><a href="#local-6989586621679220305"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">setCookiePath</span><span> </span><a href="#local-6989586621679220303"><span class="hs-identifier hs-var">sc</span></a><span class="hs-special">)</span><span>
</span><a name="line-765"></a><span>
</span><a name="line-766"></a><span class="hs-comment">-- | Helper function for setCookieExpires value</span><span>
</span><a name="line-767"></a><span class="hs-identifier">getExpires</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679219553"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-768"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ minutes</span><span>
</span><a name="line-769"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219553"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">UTCTime</span><span>
</span><a name="line-770"></a><a name="getExpires"><a href="Yesod.Core.Handler.html#getExpires"><span class="hs-identifier">getExpires</span></a></a><span> </span><a name="local-6989586621679220306"><a href="#local-6989586621679220306"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-771"></a><span>    </span><a name="local-6989586621679220307"><a href="#local-6989586621679220307"><span class="hs-identifier">now</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-identifier hs-var">getCurrentTime</span><span>
</span><a name="line-772"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679220306"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">60</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addUTCTime</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679220307"><span class="hs-identifier hs-var">now</span></a><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><span>
</span><a name="line-775"></a><span class="hs-comment">-- | Unset the cookie on the client.</span><span>
</span><a name="line-776"></a><span class="hs-comment">--</span><span>
</span><a name="line-777"></a><span class="hs-comment">-- Note: although the value used for key and path is 'Text', you should only</span><span>
</span><a name="line-778"></a><span class="hs-comment">-- use ASCII values to be HTTP compliant.</span><span>
</span><a name="line-779"></a><span class="hs-identifier">deleteCookie</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219552"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-780"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-comment">-- ^ key</span><span>
</span><a name="line-781"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-comment">-- ^ path</span><span>
</span><a name="line-782"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219552"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-783"></a><a name="deleteCookie"><a href="Yesod.Core.Handler.html#deleteCookie"><span class="hs-identifier">deleteCookie</span></a></a><span> </span><a name="local-6989586621679220308"><a href="#local-6989586621679220308"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#addHeaderInternal"><span class="hs-identifier hs-var">addHeaderInternal</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Types.html#DeleteCookie"><span class="hs-identifier hs-var">DeleteCookie</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><a href="#local-6989586621679220308"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">encodeUtf8</span><span>
</span><a name="line-784"></a><span>
</span><a name="line-785"></a><span>
</span><a name="line-786"></a><span class="hs-comment">-- | Set the language in the user session. Will show up in 'languages' on the</span><span>
</span><a name="line-787"></a><span class="hs-comment">-- next request.</span><span>
</span><a name="line-788"></a><span class="hs-identifier">setLanguage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219551"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219551"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-789"></a><a name="setLanguage"><a href="Yesod.Core.Handler.html#setLanguage"><span class="hs-identifier">setLanguage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#setSession"><span class="hs-identifier hs-var">setSession</span></a><span> </span><a href="Yesod.Core.Internal.Request.html#langKey"><span class="hs-identifier hs-var">langKey</span></a><span>
</span><a name="line-790"></a><span>
</span><a name="line-791"></a><span class="hs-comment">-- | Set attachment file name.</span><span>
</span><a name="line-792"></a><span class="hs-comment">--</span><span>
</span><a name="line-793"></a><span class="hs-comment">-- Allows Unicode characters by encoding to UTF-8.</span><span>
</span><a name="line-794"></a><span class="hs-comment">-- Some modurn browser parse UTF-8 characters with out encoding setting.</span><span>
</span><a name="line-795"></a><span class="hs-comment">-- But, for example IE9 can't parse UTF-8 characters.</span><span>
</span><a name="line-796"></a><span class="hs-comment">-- This function use</span><span>
</span><a name="line-797"></a><span class="hs-comment">-- &lt;https://tools.ietf.org/html/rfc6266 RFC 6266&gt;(&lt;https://tools.ietf.org/html/rfc5987 RFC 5987&gt;)</span><span>
</span><a name="line-798"></a><span class="hs-comment">--</span><span>
</span><a name="line-799"></a><span class="hs-comment">-- @since 1.6.4</span><span>
</span><a name="line-800"></a><span class="hs-identifier">addContentDispositionFileName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219550"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219550"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-801"></a><a name="addContentDispositionFileName"><a href="Yesod.Core.Handler.html#addContentDispositionFileName"><span class="hs-identifier">addContentDispositionFileName</span></a></a><span> </span><a name="local-6989586621679220309"><a href="#local-6989586621679220309"><span class="hs-identifier">fileName</span></a></a><span>
</span><a name="line-802"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#addHeader"><span class="hs-identifier hs-var">addHeader</span></a><span> </span><span class="hs-string">&quot;Content-Disposition&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Handler.html#rfc6266Utf8FileName"><span class="hs-identifier hs-var">rfc6266Utf8FileName</span></a><span> </span><a href="#local-6989586621679220309"><span class="hs-identifier hs-var">fileName</span></a><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span class="hs-comment">-- | &lt;https://tools.ietf.org/html/rfc6266 RFC 6266&gt; Unicode attachment filename.</span><span>
</span><a name="line-805"></a><span class="hs-comment">--</span><span>
</span><a name="line-806"></a><span class="hs-comment">-- &gt; rfc6266Utf8FileName (Data.Text.pack &quot;&#8364;&quot;)</span><span>
</span><a name="line-807"></a><span class="hs-comment">-- &quot;attachment; filename*=UTF-8''%E2%82%AC&quot;</span><span>
</span><a name="line-808"></a><span class="hs-identifier">rfc6266Utf8FileName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span>
</span><a name="line-809"></a><a name="rfc6266Utf8FileName"><a href="Yesod.Core.Handler.html#rfc6266Utf8FileName"><span class="hs-identifier">rfc6266Utf8FileName</span></a></a><span> </span><a name="local-6989586621679220310"><a href="#local-6989586621679220310"><span class="hs-identifier">fileName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;attachment; filename*=UTF-8''&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">decodeUtf8</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">H.urlEncode</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><a href="#local-6989586621679220310"><span class="hs-identifier hs-var">fileName</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-810"></a><span>
</span><a name="line-811"></a><span class="hs-comment">-- | Set an arbitrary response header.</span><span>
</span><a name="line-812"></a><span class="hs-comment">--</span><span>
</span><a name="line-813"></a><span class="hs-comment">-- Note that, while the data type used here is 'Text', you must provide only</span><span>
</span><a name="line-814"></a><span class="hs-comment">-- ASCII value to be HTTP compliant.</span><span>
</span><a name="line-815"></a><span class="hs-comment">--</span><span>
</span><a name="line-816"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-817"></a><span class="hs-identifier">addHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219549"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219549"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-818"></a><a name="addHeader"><a href="Yesod.Core.Handler.html#addHeader"><span class="hs-identifier">addHeader</span></a></a><span> </span><a name="local-6989586621679220311"><a href="#local-6989586621679220311"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#addHeaderInternal"><span class="hs-identifier hs-var">addHeaderInternal</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-var">Header</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CI.mk</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><a href="#local-6989586621679220311"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">encodeUtf8</span><span>
</span><a name="line-819"></a><span>
</span><a name="line-820"></a><span class="hs-comment">-- | Deprecated synonym for addHeader.</span><span>
</span><a name="line-821"></a><span class="hs-identifier">setHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219548"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219548"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-822"></a><a name="setHeader"><a href="Yesod.Core.Handler.html#setHeader"><span class="hs-identifier">setHeader</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#addHeader"><span class="hs-identifier hs-var">addHeader</span></a><span>
</span><a name="line-823"></a><span class="hs-pragma">{-# DEPRECATED</span><span> </span><span class="hs-pragma">setHeader</span><span> </span><span class="hs-pragma">&quot;Please use addHeader instead&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-824"></a><span>
</span><a name="line-825"></a><span class="hs-comment">-- | Replace an existing header with a new value or add a new header</span><span>
</span><a name="line-826"></a><span class="hs-comment">-- if not present.</span><span>
</span><a name="line-827"></a><span class="hs-comment">--</span><span>
</span><a name="line-828"></a><span class="hs-comment">-- Note that, while the data type used here is 'Text', you must provide only</span><span>
</span><a name="line-829"></a><span class="hs-comment">-- ASCII value to be HTTP compliant.</span><span>
</span><a name="line-830"></a><span class="hs-comment">--</span><span>
</span><a name="line-831"></a><span class="hs-comment">-- @since 1.4.36</span><span>
</span><a name="line-832"></a><span class="hs-identifier">replaceOrAddHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219547"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219547"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-833"></a><a name="replaceOrAddHeader"><a href="Yesod.Core.Handler.html#replaceOrAddHeader"><span class="hs-identifier">replaceOrAddHeader</span></a></a><span> </span><a name="local-6989586621679220312"><a href="#local-6989586621679220312"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679220313"><a href="#local-6989586621679220313"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-834"></a><span>  </span><a href="Yesod.Core.Handler.html#modify"><span class="hs-identifier hs-var">modify</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679220330"><a href="#local-6989586621679220330"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679220330"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ghsHeaders</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679220317"><span class="hs-identifier hs-var">replaceHeader</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ghsHeaders</span><span> </span><a href="#local-6989586621679220330"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-835"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-836"></a><span>    </span><a name="local-6989586621679220314"><a href="#local-6989586621679220314"><span class="hs-identifier">repHeader</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-var">Header</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CI.mk</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><a href="#local-6989586621679220312"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><a href="#local-6989586621679220313"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-837"></a><span>
</span><a name="line-838"></a><span>    </span><span class="hs-identifier">sameHeaderName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-type">Header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-type">Header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-839"></a><span>    </span><a name="local-6989586621679220315"><a href="#local-6989586621679220315"><span class="hs-identifier">sameHeaderName</span></a></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-var">Header</span></a><span> </span><a name="local-6989586621679220318"><a href="#local-6989586621679220318"><span class="hs-identifier">n1</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-var">Header</span></a><span> </span><a name="local-6989586621679220319"><a href="#local-6989586621679220319"><span class="hs-identifier">n2</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679220318"><span class="hs-identifier hs-var">n1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679220319"><span class="hs-identifier hs-var">n2</span></a><span>
</span><a name="line-840"></a><span>    </span><span class="hs-identifier">sameHeaderName</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-841"></a><span>
</span><a name="line-842"></a><span>    </span><span class="hs-identifier">replaceIndividualHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-type">Header</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-type">Header</span></a><span class="hs-special">]</span><span>
</span><a name="line-843"></a><span>    </span><a name="local-6989586621679220316"><a href="#local-6989586621679220316"><span class="hs-identifier">replaceIndividualHeader</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679220314"><span class="hs-identifier hs-var">repHeader</span></a><span class="hs-special">]</span><span>
</span><a name="line-844"></a><span>    </span><span class="hs-identifier">replaceIndividualHeader</span><span> </span><a name="local-6989586621679220320"><a href="#local-6989586621679220320"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679220321"><span class="hs-identifier hs-var">aux</span></a><span> </span><a href="#local-6989586621679220320"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-845"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-846"></a><span>        </span><a name="local-6989586621679220321"><a href="#local-6989586621679220321"><span class="hs-identifier">aux</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621679220322"><a href="#local-6989586621679220322"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679220322"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679220314"><span class="hs-identifier hs-var">repHeader</span></a><span class="hs-special">]</span><span>
</span><a name="line-847"></a><span>        </span><span class="hs-identifier">aux</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679220323"><a href="#local-6989586621679220323"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679220324"><a href="#local-6989586621679220324"><span class="hs-identifier">xs'</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679220325"><a href="#local-6989586621679220325"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-848"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679220315"><span class="hs-identifier hs-var">sameHeaderName</span></a><span> </span><a href="#local-6989586621679220314"><span class="hs-identifier hs-var">repHeader</span></a><span> </span><a href="#local-6989586621679220323"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-849"></a><span>            </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679220325"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-850"></a><span>                 </span><span class="hs-special">[</span><a href="#local-6989586621679220314"><span class="hs-identifier hs-var">repHeader</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-851"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679220326"><a href="#local-6989586621679220326"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679220315"><span class="hs-identifier hs-var">sameHeaderName</span></a><span> </span><a href="#local-6989586621679220326"><span class="hs-identifier hs-var">header</span></a><span> </span><a href="#local-6989586621679220314"><span class="hs-identifier hs-var">repHeader</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679220324"><span class="hs-identifier hs-var">xs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-852"></a><span>            </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679220321"><span class="hs-identifier hs-var">aux</span></a><span> </span><a href="#local-6989586621679220324"><span class="hs-identifier hs-var">xs'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679220325"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679220323"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-853"></a><span>
</span><a name="line-854"></a><span>    </span><span class="hs-identifier">replaceHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Endo</span><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-type">Header</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Endo</span><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-type">Header</span></a><span class="hs-special">]</span><span>
</span><a name="line-855"></a><span>    </span><a name="local-6989586621679220317"><a href="#local-6989586621679220317"><span class="hs-identifier">replaceHeader</span></a></a><span> </span><a name="local-6989586621679220327"><a href="#local-6989586621679220327"><span class="hs-identifier">endo</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-856"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679220328"><a href="#local-6989586621679220328"><span class="hs-identifier">allHeaders</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-type">Header</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">appEndo</span><span> </span><a href="#local-6989586621679220327"><span class="hs-identifier hs-var">endo</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-857"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">Endo</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679220329"><a href="#local-6989586621679220329"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679220316"><span class="hs-identifier hs-var">replaceIndividualHeader</span></a><span> </span><a href="#local-6989586621679220328"><span class="hs-identifier hs-var">allHeaders</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679220329"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-858"></a><span>
</span><a name="line-859"></a><span class="hs-comment">-- | Set the Cache-Control header to indicate this response should be cached</span><span>
</span><a name="line-860"></a><span class="hs-comment">-- for the given number of seconds.</span><span>
</span><a name="line-861"></a><span class="hs-identifier">cacheSeconds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219546"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219546"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-862"></a><a name="cacheSeconds"><a href="Yesod.Core.Handler.html#cacheSeconds"><span class="hs-identifier">cacheSeconds</span></a></a><span> </span><a name="local-6989586621679220331"><a href="#local-6989586621679220331"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#setHeader"><span class="hs-identifier hs-var">setHeader</span></a><span> </span><span class="hs-string">&quot;Cache-Control&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">T.concat</span><span>
</span><a name="line-863"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;max-age=&quot;</span><span>
</span><a name="line-864"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679220331"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-865"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;, public&quot;</span><span>
</span><a name="line-866"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-867"></a><span>
</span><a name="line-868"></a><span class="hs-comment">-- | Set the Expires header to some date in 2037. In other words, this content</span><span>
</span><a name="line-869"></a><span class="hs-comment">-- is never (realistically) expired.</span><span>
</span><a name="line-870"></a><span class="hs-identifier">neverExpires</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219545"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219545"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-871"></a><a name="neverExpires"><a href="Yesod.Core.Handler.html#neverExpires"><span class="hs-identifier">neverExpires</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-872"></a><span>    </span><a href="Yesod.Core.Handler.html#setHeader"><span class="hs-identifier hs-var">setHeader</span></a><span> </span><span class="hs-string">&quot;Expires&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">rheMaxExpires</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="Yesod.Core.Handler.html#askHandlerEnv"><span class="hs-identifier hs-var">askHandlerEnv</span></a><span>
</span><a name="line-873"></a><span>    </span><a href="Yesod.Core.Handler.html#cacheSeconds"><span class="hs-identifier hs-var">cacheSeconds</span></a><span> </span><a href="#local-6989586621679220332"><span class="hs-identifier hs-var">oneYear</span></a><span>
</span><a name="line-874"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-875"></a><span>    </span><span class="hs-identifier">oneYear</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-876"></a><span>    </span><a name="local-6989586621679220332"><a href="#local-6989586621679220332"><span class="hs-identifier">oneYear</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">60</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">60</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">24</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">365</span><span>
</span><a name="line-877"></a><span>
</span><a name="line-878"></a><span class="hs-comment">-- | Set an Expires header in the past, meaning this content should not be</span><span>
</span><a name="line-879"></a><span class="hs-comment">-- cached.</span><span>
</span><a name="line-880"></a><span class="hs-identifier">alreadyExpired</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219544"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219544"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-881"></a><a name="alreadyExpired"><a href="Yesod.Core.Handler.html#alreadyExpired"><span class="hs-identifier">alreadyExpired</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#setHeader"><span class="hs-identifier hs-var">setHeader</span></a><span> </span><span class="hs-string">&quot;Expires&quot;</span><span> </span><span class="hs-string">&quot;Thu, 01 Jan 1970 05:05:05 GMT&quot;</span><span>
</span><a name="line-882"></a><span>
</span><a name="line-883"></a><span class="hs-comment">-- | Set an Expires header to the given date.</span><span>
</span><a name="line-884"></a><span class="hs-identifier">expiresAt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219543"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">UTCTime</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219543"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-885"></a><a name="expiresAt"><a href="Yesod.Core.Handler.html#expiresAt"><span class="hs-identifier">expiresAt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#setHeader"><span class="hs-identifier hs-var">setHeader</span></a><span> </span><span class="hs-string">&quot;Expires&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Internal.Util.html#formatRFC1123"><span class="hs-identifier hs-var">formatRFC1123</span></a><span>
</span><a name="line-886"></a><span>
</span><a name="line-887"></a><span class="hs-keyword">data</span><span> </span><a name="Etag"><a href="Yesod.Core.Handler.html#Etag"><span class="hs-identifier">Etag</span></a></a><span>
</span><a name="line-888"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="WeakEtag"><a href="Yesod.Core.Handler.html#WeakEtag"><span class="hs-identifier">WeakEtag</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">S.ByteString</span><span>
</span><a name="line-889"></a><span>  </span><span class="hs-comment">-- ^ Prefixed by W/ and surrounded in quotes. Signifies that contents are</span><span>
</span><a name="line-890"></a><span>  </span><span class="hs-comment">-- semantically identical but make no guarantees about being bytewise identical.</span><span>
</span><a name="line-891"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="StrongEtag"><a href="Yesod.Core.Handler.html#StrongEtag"><span class="hs-identifier">StrongEtag</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">S.ByteString</span><span>
</span><a name="line-892"></a><span>  </span><span class="hs-comment">-- ^ Signifies that contents should be byte-for-byte identical if they match</span><span>
</span><a name="line-893"></a><span>  </span><span class="hs-comment">-- the provided ETag</span><span>
</span><a name="line-894"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="InvalidEtag"><a href="Yesod.Core.Handler.html#InvalidEtag"><span class="hs-identifier">InvalidEtag</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">S.ByteString</span><span>
</span><a name="line-895"></a><span>  </span><span class="hs-comment">-- ^ Anything else that ends up in a header that expects an ETag but doesn't</span><span>
</span><a name="line-896"></a><span>  </span><span class="hs-comment">-- properly follow the ETag format specified in RFC 7232, section 2.3</span><span>
</span><a name="line-897"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-898"></a><span>
</span><a name="line-899"></a><span class="hs-comment">-- | Check the if-none-match header and, if it matches the given value, return</span><span>
</span><a name="line-900"></a><span class="hs-comment">-- a 304 not modified response. Otherwise, set the etag header to the given</span><span>
</span><a name="line-901"></a><span class="hs-comment">-- value.</span><span>
</span><a name="line-902"></a><span class="hs-comment">--</span><span>
</span><a name="line-903"></a><span class="hs-comment">-- Note that it is the responsibility of the caller to ensure that the provided</span><span>
</span><a name="line-904"></a><span class="hs-comment">-- value is a valid etag value, no sanity checking is performed by this</span><span>
</span><a name="line-905"></a><span class="hs-comment">-- function.</span><span>
</span><a name="line-906"></a><span class="hs-comment">--</span><span>
</span><a name="line-907"></a><span class="hs-comment">-- @since 1.4.4</span><span>
</span><a name="line-908"></a><span class="hs-identifier">setEtag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219542"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219542"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-909"></a><a name="setEtag"><a href="Yesod.Core.Handler.html#setEtag"><span class="hs-identifier">setEtag</span></a></a><span> </span><a name="local-6989586621679220333"><a href="#local-6989586621679220333"><span class="hs-identifier">etag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-910"></a><span>    </span><a name="local-6989586621679220334"><a href="#local-6989586621679220334"><span class="hs-identifier">mmatch</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#lookupHeader"><span class="hs-identifier hs-var">lookupHeader</span></a><span> </span><span class="hs-string">&quot;if-none-match&quot;</span><span>
</span><a name="line-911"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679220335"><a href="#local-6989586621679220335"><span class="hs-identifier">matches</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="Yesod.Core.Handler.html#parseMatch"><span class="hs-identifier hs-var">parseMatch</span></a><span> </span><a href="#local-6989586621679220334"><span class="hs-identifier hs-var">mmatch</span></a><span>
</span><a name="line-912"></a><span>        </span><a name="local-6989586621679220336"><a href="#local-6989586621679220336"><span class="hs-identifier">baseTag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><a href="#local-6989586621679220333"><span class="hs-identifier hs-var">etag</span></a><span>
</span><a name="line-913"></a><span>        </span><a name="local-6989586621679220337"><a href="#local-6989586621679220337"><span class="hs-identifier">strongTag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#StrongEtag"><span class="hs-identifier hs-var">StrongEtag</span></a><span> </span><a href="#local-6989586621679220336"><span class="hs-identifier hs-var">baseTag</span></a><span>
</span><a name="line-914"></a><span>        </span><a name="local-6989586621679220338"><a href="#local-6989586621679220338"><span class="hs-identifier">badTag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#InvalidEtag"><span class="hs-identifier hs-var">InvalidEtag</span></a><span> </span><a href="#local-6989586621679220336"><span class="hs-identifier hs-var">baseTag</span></a><span>
</span><a name="line-915"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679220339"><a href="#local-6989586621679220339"><span class="hs-identifier">tag</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679220339"><span class="hs-identifier hs-var">tag</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679220337"><span class="hs-identifier hs-var">strongTag</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679220339"><span class="hs-identifier hs-var">tag</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679220338"><span class="hs-identifier hs-var">badTag</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679220335"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-916"></a><span>        </span><span class="hs-keyword">then</span><span> </span><a href="Yesod.Core.Handler.html#notModified"><span class="hs-identifier hs-var">notModified</span></a><span>
</span><a name="line-917"></a><span>        </span><span class="hs-keyword">else</span><span> </span><a href="Yesod.Core.Handler.html#addHeader"><span class="hs-identifier hs-var">addHeader</span></a><span> </span><span class="hs-string">&quot;etag&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">T.concat</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;\&quot;&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679220333"><span class="hs-identifier hs-var">etag</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-918"></a><span>
</span><a name="line-919"></a><span>
</span><a name="line-920"></a><span class="hs-comment">-- | Parse an if-none-match field according to the spec.</span><span>
</span><a name="line-921"></a><span class="hs-identifier">parseMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Handler.html#Etag"><span class="hs-identifier hs-type">Etag</span></a><span class="hs-special">]</span><span>
</span><a name="line-922"></a><a name="parseMatch"><a href="Yesod.Core.Handler.html#parseMatch"><span class="hs-identifier">parseMatch</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-923"></a><span>    </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679220340"><span class="hs-identifier hs-var">clean</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S.split</span><span> </span><span class="hs-identifier hs-var">W8._comma</span><span>
</span><a name="line-924"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-925"></a><span>    </span><a name="local-6989586621679220340"><a href="#local-6989586621679220340"><span class="hs-identifier">clean</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679220341"><span class="hs-identifier hs-var">classify</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S.spanEnd</span><span> </span><span class="hs-identifier hs-var">W8.isSpace</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">S.dropWhile</span><span> </span><span class="hs-identifier hs-var">W8.isSpace</span><span>
</span><a name="line-926"></a><span>
</span><a name="line-927"></a><span>    </span><a name="local-6989586621679220341"><a href="#local-6989586621679220341"><span class="hs-identifier">classify</span></a></a><span> </span><a name="local-6989586621679220342"><a href="#local-6989586621679220342"><span class="hs-identifier">bs</span></a></a><span>
</span><a name="line-928"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">S.length</span><span> </span><a href="#local-6989586621679220342"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">S.head</span><span> </span><a href="#local-6989586621679220342"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">W8._quotedbl</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">S.last</span><span> </span><a href="#local-6989586621679220342"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">W8._quotedbl</span><span>
</span><a name="line-929"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#StrongEtag"><span class="hs-identifier hs-var">StrongEtag</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">S.init</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">S.tail</span><span> </span><a href="#local-6989586621679220342"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-930"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">S.length</span><span> </span><a href="#local-6989586621679220342"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-931"></a><span>          </span><span class="hs-identifier hs-var">S.head</span><span> </span><a href="#local-6989586621679220342"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">W8._W</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-932"></a><span>          </span><span class="hs-identifier hs-var">S.index</span><span> </span><a href="#local-6989586621679220342"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">W8._slash</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-933"></a><span>          </span><span class="hs-identifier hs-var">S.index</span><span> </span><a href="#local-6989586621679220342"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">W8._quotedbl</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-934"></a><span>          </span><span class="hs-identifier hs-var">S.last</span><span> </span><a href="#local-6989586621679220342"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">W8._quotedbl</span><span>
</span><a name="line-935"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#WeakEtag"><span class="hs-identifier hs-var">WeakEtag</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">S.init</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">S.drop</span><span> </span><span class="hs-number">3</span><span> </span><a href="#local-6989586621679220342"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-936"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#InvalidEtag"><span class="hs-identifier hs-var">InvalidEtag</span></a><span> </span><a href="#local-6989586621679220342"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-937"></a><span>
</span><a name="line-938"></a><span class="hs-comment">-- | Check the if-none-match header and, if it matches the given value, return</span><span>
</span><a name="line-939"></a><span class="hs-comment">-- a 304 not modified response. Otherwise, set the etag header to the given</span><span>
</span><a name="line-940"></a><span class="hs-comment">-- value.</span><span>
</span><a name="line-941"></a><span class="hs-comment">--</span><span>
</span><a name="line-942"></a><span class="hs-comment">-- A weak etag is only expected to be semantically identical to the prior content,</span><span>
</span><a name="line-943"></a><span class="hs-comment">-- but doesn't have to be byte-for-byte identical. Therefore it can be useful for</span><span>
</span><a name="line-944"></a><span class="hs-comment">-- dynamically generated content that may be difficult to perform bytewise hashing</span><span>
</span><a name="line-945"></a><span class="hs-comment">-- upon.</span><span>
</span><a name="line-946"></a><span class="hs-comment">--</span><span>
</span><a name="line-947"></a><span class="hs-comment">-- Note that it is the responsibility of the caller to ensure that the provided</span><span>
</span><a name="line-948"></a><span class="hs-comment">-- value is a valid etag value, no sanity checking is performed by this</span><span>
</span><a name="line-949"></a><span class="hs-comment">-- function.</span><span>
</span><a name="line-950"></a><span class="hs-comment">--</span><span>
</span><a name="line-951"></a><span class="hs-comment">-- @since 1.4.37</span><span>
</span><a name="line-952"></a><span class="hs-identifier">setWeakEtag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219541"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219541"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-953"></a><a name="setWeakEtag"><a href="Yesod.Core.Handler.html#setWeakEtag"><span class="hs-identifier">setWeakEtag</span></a></a><span> </span><a name="local-6989586621679220343"><a href="#local-6989586621679220343"><span class="hs-identifier">etag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-954"></a><span>    </span><a name="local-6989586621679220344"><a href="#local-6989586621679220344"><span class="hs-identifier">mmatch</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#lookupHeader"><span class="hs-identifier hs-var">lookupHeader</span></a><span> </span><span class="hs-string">&quot;if-none-match&quot;</span><span>
</span><a name="line-955"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679220345"><a href="#local-6989586621679220345"><span class="hs-identifier">matches</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="Yesod.Core.Handler.html#parseMatch"><span class="hs-identifier hs-var">parseMatch</span></a><span> </span><a href="#local-6989586621679220344"><span class="hs-identifier hs-var">mmatch</span></a><span>
</span><a name="line-956"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="Yesod.Core.Handler.html#WeakEtag"><span class="hs-identifier hs-var">WeakEtag</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><a href="#local-6989586621679220343"><span class="hs-identifier hs-var">etag</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679220345"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-957"></a><span>        </span><span class="hs-keyword">then</span><span> </span><a href="Yesod.Core.Handler.html#notModified"><span class="hs-identifier hs-var">notModified</span></a><span>
</span><a name="line-958"></a><span>        </span><span class="hs-keyword">else</span><span> </span><a href="Yesod.Core.Handler.html#addHeader"><span class="hs-identifier hs-var">addHeader</span></a><span> </span><span class="hs-string">&quot;etag&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">T.concat</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;W/\&quot;&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679220343"><span class="hs-identifier hs-var">etag</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-959"></a><span>
</span><a name="line-960"></a><span class="hs-comment">-- | Set a variable in the user's session.</span><span>
</span><a name="line-961"></a><span class="hs-comment">--</span><span>
</span><a name="line-962"></a><span class="hs-comment">-- The session is handled by the clientsession package: it sets an encrypted</span><span>
</span><a name="line-963"></a><span class="hs-comment">-- and hashed cookie on the client. This ensures that all data is secure and</span><span>
</span><a name="line-964"></a><span class="hs-comment">-- not tampered with.</span><span>
</span><a name="line-965"></a><span class="hs-identifier">setSession</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219540"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-966"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-comment">-- ^ key</span><span>
</span><a name="line-967"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-comment">-- ^ value</span><span>
</span><a name="line-968"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219540"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-969"></a><a name="setSession"><a href="Yesod.Core.Handler.html#setSession"><span class="hs-identifier">setSession</span></a></a><span> </span><a name="local-6989586621679220346"><a href="#local-6989586621679220346"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#setSessionBS"><span class="hs-identifier hs-var">setSessionBS</span></a><span> </span><a href="#local-6989586621679220346"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">encodeUtf8</span><span>
</span><a name="line-970"></a><span>
</span><a name="line-971"></a><span class="hs-comment">-- | Same as 'setSession', but uses binary data for the value.</span><span>
</span><a name="line-972"></a><span class="hs-identifier">setSessionBS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219539"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-973"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-974"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">S.ByteString</span><span>
</span><a name="line-975"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219539"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-976"></a><a name="setSessionBS"><a href="Yesod.Core.Handler.html#setSessionBS"><span class="hs-identifier">setSessionBS</span></a></a><span> </span><a name="local-6989586621679220347"><a href="#local-6989586621679220347"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#modify"><span class="hs-identifier hs-var">modify</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Handler.html#modSession"><span class="hs-identifier hs-var">modSession</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621679220347"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-977"></a><span>
</span><a name="line-978"></a><span class="hs-comment">-- | Unsets a session variable. See 'setSession'.</span><span>
</span><a name="line-979"></a><span class="hs-identifier">deleteSession</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219538"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219538"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-980"></a><a name="deleteSession"><a href="Yesod.Core.Handler.html#deleteSession"><span class="hs-identifier">deleteSession</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#modify"><span class="hs-identifier hs-var">modify</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Handler.html#modSession"><span class="hs-identifier hs-var">modSession</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Map.delete</span><span>
</span><a name="line-981"></a><span>
</span><a name="line-982"></a><span class="hs-comment">-- | Clear all session variables.</span><span>
</span><a name="line-983"></a><span class="hs-comment">--</span><span>
</span><a name="line-984"></a><span class="hs-comment">-- @since: 1.0.1</span><span>
</span><a name="line-985"></a><span class="hs-identifier">clearSession</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219537"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219537"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-986"></a><a name="clearSession"><a href="Yesod.Core.Handler.html#clearSession"><span class="hs-identifier">clearSession</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#modify"><span class="hs-identifier hs-var">modify</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679220348"><a href="#local-6989586621679220348"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679220348"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ghsSession</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-987"></a><span>
</span><a name="line-988"></a><span class="hs-identifier">modSession</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Types.html#SessionMap"><span class="hs-identifier hs-type">SessionMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Types.html#SessionMap"><span class="hs-identifier hs-type">SessionMap</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Types.html#GHState"><span class="hs-identifier hs-type">GHState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Types.html#GHState"><span class="hs-identifier hs-type">GHState</span></a><span>
</span><a name="line-989"></a><a name="modSession"><a href="Yesod.Core.Handler.html#modSession"><span class="hs-identifier">modSession</span></a></a><span> </span><a name="local-6989586621679220349"><a href="#local-6989586621679220349"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679220350"><a href="#local-6989586621679220350"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679220350"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ghsSession</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679220349"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ghsSession</span><span> </span><a href="#local-6989586621679220350"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-990"></a><span>
</span><a name="line-991"></a><span class="hs-comment">-- | Internal use only, not to be confused with 'setHeader'.</span><span>
</span><a name="line-992"></a><span class="hs-identifier">addHeaderInternal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219536"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Types.html#Header"><span class="hs-identifier hs-type">Header</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219536"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-993"></a><a name="addHeaderInternal"><a href="Yesod.Core.Handler.html#addHeaderInternal"><span class="hs-identifier">addHeaderInternal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#tell"><span class="hs-identifier hs-var">tell</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Endo</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-994"></a><span>
</span><a name="line-995"></a><span class="hs-comment">-- | Some value which can be turned into a URL for redirects.</span><span>
</span><a name="line-996"></a><span class="hs-keyword">class</span><span> </span><a name="RedirectUrl"><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier">RedirectUrl</span></a></a><span> </span><a name="local-6989586621679219428"><a href="#local-6989586621679219428"><span class="hs-identifier">master</span></a></a><span> </span><a name="local-6989586621679219429"><a href="#local-6989586621679219429"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-997"></a><span>    </span><span class="hs-comment">-- | Converts the value to the URL and a list of query-string parameters.</span><span>
</span><a name="line-998"></a><span>    </span><a name="toTextUrl"><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier">toTextUrl</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219430"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HandlerSite</span><span> </span><a href="#local-6989586621679219430"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">~</span><span> </span><a href="#local-6989586621679219428"><span class="hs-identifier hs-type">master</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219429"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219430"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-999"></a><span>
</span><a name="line-1000"></a><span class="hs-keyword">instance</span><span> </span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><a href="#local-6989586621679219454"><span class="hs-identifier hs-type">master</span></a><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1001"></a><span>    </span><a name="local-8214565720323994193"><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier">toTextUrl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-1002"></a><span>
</span><a name="line-1003"></a><span class="hs-keyword">instance</span><span> </span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><a href="#local-6989586621679219453"><span class="hs-identifier hs-type">master</span></a><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1004"></a><span>    </span><a name="local-8214565720323994193"><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier">toTextUrl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier hs-var">toTextUrl</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span>
</span><a name="line-1005"></a><span>
</span><a name="line-1006"></a><span class="hs-keyword">instance</span><span> </span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><a href="#local-6989586621679219450"><span class="hs-identifier hs-type">master</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><a href="#local-6989586621679219450"><span class="hs-identifier hs-type">master</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1007"></a><span>    </span><a name="local-8214565720323994193"><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier">toTextUrl</span></a></a><span> </span><a name="local-6989586621679219451"><a href="#local-6989586621679219451"><span class="hs-identifier">url</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1008"></a><span>        </span><a name="local-6989586621679219452"><a href="#local-6989586621679219452"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#getUrlRender"><span class="hs-identifier hs-var">getUrlRender</span></a><span>
</span><a name="line-1009"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679219452"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679219451"><span class="hs-identifier hs-var">url</span></a><span>
</span><a name="line-1010"></a><span>
</span><a name="line-1011"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">key</span><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">val</span><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><a href="#local-6989586621679219446"><span class="hs-identifier hs-type">master</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><a href="#local-6989586621679219446"><span class="hs-identifier hs-type">master</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679219444"><span class="hs-identifier hs-type">key</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679219445"><span class="hs-identifier hs-type">val</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1012"></a><span>    </span><a name="local-8214565720323994193"><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier">toTextUrl</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679219447"><a href="#local-6989586621679219447"><span class="hs-identifier">url</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679219448"><a href="#local-6989586621679219448"><span class="hs-identifier">params</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1013"></a><span>        </span><a name="local-6989586621679219449"><a href="#local-6989586621679219449"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#getUrlRenderParams"><span class="hs-identifier hs-var">getUrlRenderParams</span></a><span>
</span><a name="line-1014"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679219449"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679219447"><span class="hs-identifier hs-var">url</span></a><span> </span><a href="#local-6989586621679219448"><span class="hs-identifier hs-var">params</span></a><span>
</span><a name="line-1015"></a><span>
</span><a name="line-1016"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">key</span><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">val</span><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><a href="#local-6989586621679219441"><span class="hs-identifier hs-type">master</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><a href="#local-6989586621679219441"><span class="hs-identifier hs-type">master</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Map.Map</span><span> </span><a href="#local-6989586621679219439"><span class="hs-identifier hs-type">key</span></a><span> </span><a href="#local-6989586621679219440"><span class="hs-identifier hs-type">val</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1017"></a><span>    </span><a name="local-8214565720323994193"><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier">toTextUrl</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679219442"><a href="#local-6989586621679219442"><span class="hs-identifier">url</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679219443"><a href="#local-6989586621679219443"><span class="hs-identifier">params</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier hs-var">toTextUrl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219442"><span class="hs-identifier hs-var">url</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679219443"><span class="hs-identifier hs-var">params</span></a><span class="hs-special">)</span><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span class="hs-comment">-- | Add a fragment identifier to a route to be used when</span><span>
</span><a name="line-1020"></a><span class="hs-comment">-- redirecting.  For example:</span><span>
</span><a name="line-1021"></a><span class="hs-comment">--</span><span>
</span><a name="line-1022"></a><span class="hs-comment">-- &gt; redirect (NewsfeedR :#: storyId)</span><span>
</span><a name="line-1023"></a><span class="hs-comment">--</span><span>
</span><a name="line-1024"></a><span class="hs-comment">-- @since 1.2.9.</span><span>
</span><a name="line-1025"></a><span class="hs-keyword">data</span><span> </span><a name="Fragment"><a href="Yesod.Core.Handler.html#Fragment"><span class="hs-identifier">Fragment</span></a></a><span> </span><a name="local-6989586621679219426"><a href="#local-6989586621679219426"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679219427"><a href="#local-6989586621679219427"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679219426"><span class="hs-identifier hs-type">a</span></a><span> </span><a name="%3A%23%3A"><a href="Yesod.Core.Handler.html#%3A%23%3A"><span class="hs-operator">:#:</span></a></a><span> </span><a href="#local-6989586621679219427"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-1026"></a><span>
</span><a name="line-1027"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><a href="#local-6989586621679219433"><span class="hs-identifier hs-type">master</span></a><span> </span><a href="#local-6989586621679219434"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PathPiece</span><span> </span><a href="#local-6989586621679219435"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><a href="#local-6989586621679219433"><span class="hs-identifier hs-type">master</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#Fragment"><span class="hs-identifier hs-type">Fragment</span></a><span> </span><a href="#local-6989586621679219434"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679219435"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1028"></a><span>  </span><a name="local-8214565720323994193"><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier">toTextUrl</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679219436"><a href="#local-6989586621679219436"><span class="hs-identifier">a</span></a></a><span> </span><a href="Yesod.Core.Handler.html#%3A%23%3A"><span class="hs-operator hs-var">:#:</span></a><span> </span><a name="local-6989586621679219437"><a href="#local-6989586621679219437"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679219438"><a href="#local-6989586621679219438"><span class="hs-identifier">ua</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">T.concat</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679219438"><span class="hs-identifier hs-var">ua</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;#&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toPathPiece</span><span> </span><a href="#local-6989586621679219437"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier hs-var">toTextUrl</span></a><span> </span><a href="#local-6989586621679219436"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1029"></a><span>
</span><a name="line-1030"></a><span>
</span><a name="line-1031"></a><span class="hs-comment">-- | Lookup for session data.</span><span>
</span><a name="line-1032"></a><span class="hs-identifier">lookupSession</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219535"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219535"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-1033"></a><a name="lookupSession"><a href="Yesod.Core.Handler.html#lookupSession"><span class="hs-identifier">lookupSession</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decodeUtf8With</span><span> </span><span class="hs-identifier hs-var">lenientDecode</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Handler.html#lookupSessionBS"><span class="hs-identifier hs-var">lookupSessionBS</span></a><span>
</span><a name="line-1034"></a><span>
</span><a name="line-1035"></a><span class="hs-comment">-- | Lookup for session data in binary format.</span><span>
</span><a name="line-1036"></a><span class="hs-identifier">lookupSessionBS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219534"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219534"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">S.ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-1037"></a><a name="lookupSessionBS"><a href="Yesod.Core.Handler.html#lookupSessionBS"><span class="hs-identifier">lookupSessionBS</span></a></a><span> </span><a name="local-6989586621679220351"><a href="#local-6989586621679220351"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1038"></a><span>    </span><a name="local-6989586621679220352"><a href="#local-6989586621679220352"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">ghsSession</span><span> </span><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-1039"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679220351"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679220352"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1040"></a><span>
</span><a name="line-1041"></a><span class="hs-comment">-- | Get all session variables.</span><span>
</span><a name="line-1042"></a><span class="hs-identifier">getSession</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219533"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219533"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Yesod.Core.Types.html#SessionMap"><span class="hs-identifier hs-type">SessionMap</span></a><span>
</span><a name="line-1043"></a><a name="getSession"><a href="Yesod.Core.Handler.html#getSession"><span class="hs-identifier">getSession</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">ghsSession</span><span> </span><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-1044"></a><span>
</span><a name="line-1045"></a><span class="hs-comment">-- | Get a unique identifier.</span><span>
</span><a name="line-1046"></a><span class="hs-identifier">newIdent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219532"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219532"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-1047"></a><a name="newIdent"><a href="Yesod.Core.Handler.html#newIdent"><span class="hs-identifier">newIdent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1048"></a><span>    </span><a name="local-6989586621679220353"><a href="#local-6989586621679220353"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-1049"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679220354"><a href="#local-6989586621679220354"><span class="hs-identifier">i'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ghsIdent</span><span> </span><a href="#local-6989586621679220353"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1050"></a><span>    </span><a href="Yesod.Core.Handler.html#put"><span class="hs-identifier hs-var">put</span></a><span> </span><a href="#local-6989586621679220353"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ghsIdent</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679220354"><span class="hs-identifier hs-var">i'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1051"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;hident&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679220354"><span class="hs-identifier hs-var">i'</span></a><span>
</span><a name="line-1052"></a><span>
</span><a name="line-1053"></a><span class="hs-comment">-- | Redirect to a POST resource.</span><span>
</span><a name="line-1054"></a><span class="hs-comment">--</span><span>
</span><a name="line-1055"></a><span class="hs-comment">-- This is not technically a redirect; instead, it returns an HTML page with a</span><span>
</span><a name="line-1056"></a><span class="hs-comment">-- POST form, and some Javascript to automatically submit the form. This can be</span><span>
</span><a name="line-1057"></a><span class="hs-comment">-- useful when you need to post a plain link somewhere that needs to cause</span><span>
</span><a name="line-1058"></a><span class="hs-comment">-- changes on the server.</span><span>
</span><a name="line-1059"></a><span class="hs-identifier">redirectToPost</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219529"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#RedirectUrl"><span class="hs-identifier hs-type">RedirectUrl</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219529"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219530"><span class="hs-identifier hs-type">url</span></a><span class="hs-special">)</span><span>
</span><a name="line-1060"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219530"><span class="hs-identifier hs-type">url</span></a><span>
</span><a name="line-1061"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219529"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219531"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1062"></a><a name="redirectToPost"><a href="Yesod.Core.Handler.html#redirectToPost"><span class="hs-identifier">redirectToPost</span></a></a><span> </span><a name="local-6989586621679220355"><a href="#local-6989586621679220355"><span class="hs-identifier">url</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1063"></a><span>    </span><a name="local-6989586621679220356"><a href="#local-6989586621679220356"><span class="hs-identifier">urlText</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#toTextUrl"><span class="hs-identifier hs-var">toTextUrl</span></a><span> </span><a href="#local-6989586621679220355"><span class="hs-identifier hs-var">url</span></a><span>
</span><a name="line-1064"></a><span>    </span><a name="local-6989586621679220357"><a href="#local-6989586621679220357"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#getRequest"><span class="hs-identifier hs-var">getRequest</span></a><span>
</span><a name="line-1065"></a><span>    </span><a href="Yesod.Core.Handler.html#withUrlRenderer"><span class="hs-identifier hs-var">withUrlRenderer</span></a><span> </span><span class="">[hamlet|
$newline never
$doctype 5

&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Redirecting...
    &lt;body&gt;
        &lt;form id=&quot;form&quot; method=&quot;post&quot; action=#{urlText}&gt;
            $maybe token &lt;- reqToken req
                &lt;input type=hidden name=#{defaultCsrfParamName} value=#{token}&gt;
            &lt;noscript&gt;
                &lt;p&gt;Javascript has been disabled; please click on the button below to be redirected.
            &lt;input type=&quot;submit&quot; value=&quot;Continue&quot;&gt;
        &lt;script&gt;
          window.onload = function() { document.getElementById('form').submit(); };
|]</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Yesod.Core.Handler.html#sendResponse"><span class="hs-identifier hs-var">sendResponse</span></a><span>
</span><a name="line-1082"></a><span>
</span><a name="line-1083"></a><span class="hs-comment">-- | Wraps the 'Content' generated by 'hamletToContent' in a 'RepHtml'.</span><span>
</span><a name="line-1084"></a><span class="hs-identifier">hamletToRepHtml</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219528"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HtmlUrl</span><span> </span><span class="hs-special">(</span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219528"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219528"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Html</span><span>
</span><a name="line-1085"></a><a name="hamletToRepHtml"><a href="Yesod.Core.Handler.html#hamletToRepHtml"><span class="hs-identifier">hamletToRepHtml</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#withUrlRenderer"><span class="hs-identifier hs-var">withUrlRenderer</span></a><span>
</span><a name="line-1086"></a><span class="hs-pragma">{-# DEPRECATED</span><span> </span><span class="hs-pragma">hamletToRepHtml</span><span> </span><span class="hs-pragma">&quot;Use withUrlRenderer instead&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1087"></a><span>
</span><a name="line-1088"></a><span class="hs-comment">-- | Deprecated synonym for 'withUrlRenderer'.</span><span>
</span><a name="line-1089"></a><span class="hs-comment">--</span><span>
</span><a name="line-1090"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1091"></a><span class="hs-identifier">giveUrlRenderer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219526"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1092"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219526"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219527"><span class="hs-identifier hs-type">output</span></a><span class="hs-special">)</span><span>
</span><a name="line-1093"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219526"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219527"><span class="hs-identifier hs-type">output</span></a><span>
</span><a name="line-1094"></a><a name="giveUrlRenderer"><a href="Yesod.Core.Handler.html#giveUrlRenderer"><span class="hs-identifier">giveUrlRenderer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#withUrlRenderer"><span class="hs-identifier hs-var">withUrlRenderer</span></a><span>
</span><a name="line-1095"></a><span class="hs-pragma">{-# DEPRECATED</span><span> </span><span class="hs-pragma">giveUrlRenderer</span><span> </span><span class="hs-pragma">&quot;Use withUrlRenderer instead&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1096"></a><span>
</span><a name="line-1097"></a><span class="hs-comment">-- | Provide a URL rendering function to the given function and return the</span><span>
</span><a name="line-1098"></a><span class="hs-comment">-- result. Useful for processing Shakespearean templates.</span><span>
</span><a name="line-1099"></a><span class="hs-comment">--</span><span>
</span><a name="line-1100"></a><span class="hs-comment">-- @since 1.2.20</span><span>
</span><a name="line-1101"></a><span class="hs-identifier">withUrlRenderer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219524"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1102"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219524"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219525"><span class="hs-identifier hs-type">output</span></a><span class="hs-special">)</span><span>
</span><a name="line-1103"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219524"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219525"><span class="hs-identifier hs-type">output</span></a><span>
</span><a name="line-1104"></a><a name="withUrlRenderer"><a href="Yesod.Core.Handler.html#withUrlRenderer"><span class="hs-identifier">withUrlRenderer</span></a></a><span> </span><a name="local-6989586621679221025"><a href="#local-6989586621679221025"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1105"></a><span>    </span><a name="local-6989586621679221026"><a href="#local-6989586621679221026"><span class="hs-identifier">render</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#getUrlRenderParams"><span class="hs-identifier hs-var">getUrlRenderParams</span></a><span>
</span><a name="line-1106"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679221025"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679221026"><span class="hs-identifier hs-var">render</span></a><span>
</span><a name="line-1107"></a><span>
</span><a name="line-1108"></a><span class="hs-comment">-- | Get the request\'s 'W.Request' value.</span><span>
</span><a name="line-1109"></a><span class="hs-identifier">waiRequest</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219523"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219523"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">W.Request</span><span>
</span><a name="line-1110"></a><a name="waiRequest"><a href="Yesod.Core.Handler.html#waiRequest"><span class="hs-identifier">waiRequest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">reqWaiRequest</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#getRequest"><span class="hs-identifier hs-var">getRequest</span></a><span>
</span><a name="line-1111"></a><span>
</span><a name="line-1112"></a><span class="hs-identifier">getMessageRender</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219521"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RenderMessage</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219521"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219522"><span class="hs-identifier hs-type">message</span></a><span class="hs-special">)</span><span>
</span><a name="line-1113"></a><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219521"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679219522"><span class="hs-identifier hs-type">message</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-1114"></a><a name="getMessageRender"><a href="Yesod.Core.Handler.html#getMessageRender"><span class="hs-identifier">getMessageRender</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1115"></a><span>    </span><a name="local-6989586621679221027"><a href="#local-6989586621679221027"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#askHandlerEnv"><span class="hs-identifier hs-var">askHandlerEnv</span></a><span>
</span><a name="line-1116"></a><span>    </span><a name="local-6989586621679221028"><a href="#local-6989586621679221028"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#languages"><span class="hs-identifier hs-var">languages</span></a><span>
</span><a name="line-1117"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">renderMessage</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rheSite</span><span> </span><a href="#local-6989586621679221027"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679221028"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1118"></a><span>
</span><a name="line-1119"></a><span class="hs-comment">-- | Use a per-request cache to avoid performing the same action multiple times.</span><span>
</span><a name="line-1120"></a><span class="hs-comment">-- Values are stored by their type, the result of typeOf from Typeable.</span><span>
</span><a name="line-1121"></a><span class="hs-comment">-- Therefore, you should use different newtype wrappers at each cache site.</span><span>
</span><a name="line-1122"></a><span class="hs-comment">--</span><span>
</span><a name="line-1123"></a><span class="hs-comment">-- For example, yesod-auth uses an un-exported newtype, CachedMaybeAuth and exports functions that utilize it such as maybeAuth.</span><span>
</span><a name="line-1124"></a><span class="hs-comment">-- This means that another module can create its own newtype wrapper to cache the same type from a different action without any cache conflicts.</span><span>
</span><a name="line-1125"></a><span class="hs-comment">--</span><span>
</span><a name="line-1126"></a><span class="hs-comment">-- See the original announcement: &lt;http://www.yesodweb.com/blog/2013/03/yesod-1-2-cleaner-internals&gt;</span><span>
</span><a name="line-1127"></a><span class="hs-comment">--</span><span>
</span><a name="line-1128"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1129"></a><span class="hs-identifier">cached</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219519"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679219520"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1130"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219519"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219520"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1131"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219519"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219520"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1132"></a><a name="cached"><a href="Yesod.Core.Handler.html#cached"><span class="hs-identifier">cached</span></a></a><span> </span><a name="local-6989586621679221029"><a href="#local-6989586621679221029"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1133"></a><span>    </span><a name="local-6989586621679221030"><a href="#local-6989586621679221030"><span class="hs-identifier">cache</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ghsCache</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-1134"></a><span>    </span><a name="local-6989586621679221031"><a href="#local-6989586621679221031"><span class="hs-identifier">eres</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.TypeCache.html#cached"><span class="hs-identifier hs-var">Cache.cached</span></a><span> </span><a href="#local-6989586621679221030"><span class="hs-identifier hs-var">cache</span></a><span> </span><a href="#local-6989586621679221029"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-1135"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679221031"><span class="hs-identifier hs-var">eres</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1136"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679221032"><a href="#local-6989586621679221032"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679221032"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1137"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679221033"><a href="#local-6989586621679221033"><span class="hs-identifier">newCache</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679221034"><a href="#local-6989586621679221034"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1138"></a><span>          </span><a name="local-6989586621679221035"><a href="#local-6989586621679221035"><span class="hs-identifier">gs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-1139"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679221036"><a href="#local-6989586621679221036"><span class="hs-identifier">merged</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679221033"><span class="hs-identifier hs-var">newCache</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">HM.union</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ghsCache</span><span> </span><a href="#local-6989586621679221035"><span class="hs-identifier hs-var">gs</span></a><span>
</span><a name="line-1140"></a><span>          </span><a href="Yesod.Core.Handler.html#put"><span class="hs-identifier hs-var">put</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679221035"><span class="hs-identifier hs-var">gs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ghsCache</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679221036"><span class="hs-identifier hs-var">merged</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1141"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679221034"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1142"></a><span>
</span><a name="line-1143"></a><span class="hs-comment">-- | Retrieves a value from the cache used by 'cached'.</span><span>
</span><a name="line-1144"></a><span class="hs-comment">--</span><span>
</span><a name="line-1145"></a><span class="hs-comment">-- @since 1.6.10</span><span>
</span><a name="line-1146"></a><span class="hs-identifier">cacheGet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219517"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679219518"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1147"></a><span>         </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219517"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679219518"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1148"></a><a name="cacheGet"><a href="Yesod.Core.Handler.html#cacheGet"><span class="hs-identifier">cacheGet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1149"></a><span>  </span><a name="local-6989586621679221037"><a href="#local-6989586621679221037"><span class="hs-identifier">cache</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ghsCache</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-1150"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.TypeCache.html#cacheGet"><span class="hs-identifier hs-var">Cache.cacheGet</span></a><span> </span><a href="#local-6989586621679221037"><span class="hs-identifier hs-var">cache</span></a><span>
</span><a name="line-1151"></a><span>
</span><a name="line-1152"></a><span class="hs-comment">-- | Sets a value in the cache used by 'cached'.</span><span>
</span><a name="line-1153"></a><span class="hs-comment">--</span><span>
</span><a name="line-1154"></a><span class="hs-comment">-- @since 1.6.10</span><span>
</span><a name="line-1155"></a><span class="hs-identifier">cacheSet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219515"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679219516"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1156"></a><span>         </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219516"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1157"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219515"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1158"></a><a name="cacheSet"><a href="Yesod.Core.Handler.html#cacheSet"><span class="hs-identifier">cacheSet</span></a></a><span> </span><a name="local-6989586621679221038"><a href="#local-6989586621679221038"><span class="hs-identifier">value</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1159"></a><span>  </span><a name="local-6989586621679221039"><a href="#local-6989586621679221039"><span class="hs-identifier">gs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-1160"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679221040"><a href="#local-6989586621679221040"><span class="hs-identifier">cache</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ghsCache</span><span> </span><a href="#local-6989586621679221039"><span class="hs-identifier hs-var">gs</span></a><span>
</span><a name="line-1161"></a><span>      </span><a name="local-6989586621679221041"><a href="#local-6989586621679221041"><span class="hs-identifier">newCache</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.TypeCache.html#cacheSet"><span class="hs-identifier hs-var">Cache.cacheSet</span></a><span> </span><a href="#local-6989586621679221038"><span class="hs-identifier hs-var">value</span></a><span> </span><a href="#local-6989586621679221040"><span class="hs-identifier hs-var">cache</span></a><span>
</span><a name="line-1162"></a><span>  </span><a href="Yesod.Core.Handler.html#put"><span class="hs-identifier hs-var">put</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679221039"><span class="hs-identifier hs-var">gs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ghsCache</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679221041"><span class="hs-identifier hs-var">newCache</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1163"></a><span>
</span><a name="line-1164"></a><span class="hs-comment">-- | a per-request cache. just like 'cached'.</span><span>
</span><a name="line-1165"></a><span class="hs-comment">-- 'cached' can only cache a single value per type.</span><span>
</span><a name="line-1166"></a><span class="hs-comment">-- 'cachedBy' stores multiple values per type by usage of a ByteString key</span><span>
</span><a name="line-1167"></a><span class="hs-comment">--</span><span>
</span><a name="line-1168"></a><span class="hs-comment">-- 'cached' is ideal to cache an action that has only one value of a type, such as the session's current user</span><span>
</span><a name="line-1169"></a><span class="hs-comment">-- 'cachedBy' is required if the action has parameters and can return multiple values per type.</span><span>
</span><a name="line-1170"></a><span class="hs-comment">-- You can turn those parameters into a ByteString cache key.</span><span>
</span><a name="line-1171"></a><span class="hs-comment">-- For example, caching a lookup of a Link by a token where multiple token lookups might be performed.</span><span>
</span><a name="line-1172"></a><span class="hs-comment">--</span><span>
</span><a name="line-1173"></a><span class="hs-comment">-- @since 1.4.0</span><span>
</span><a name="line-1174"></a><span class="hs-identifier">cachedBy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219513"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679219514"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">S.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219513"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219514"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219513"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219514"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1175"></a><a name="cachedBy"><a href="Yesod.Core.Handler.html#cachedBy"><span class="hs-identifier">cachedBy</span></a></a><span> </span><a name="local-6989586621679221042"><a href="#local-6989586621679221042"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679221043"><a href="#local-6989586621679221043"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1176"></a><span>    </span><a name="local-6989586621679221044"><a href="#local-6989586621679221044"><span class="hs-identifier">cache</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ghsCacheBy</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-1177"></a><span>    </span><a name="local-6989586621679221045"><a href="#local-6989586621679221045"><span class="hs-identifier">eres</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.TypeCache.html#cachedBy"><span class="hs-identifier hs-var">Cache.cachedBy</span></a><span> </span><a href="#local-6989586621679221044"><span class="hs-identifier hs-var">cache</span></a><span> </span><a href="#local-6989586621679221042"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679221043"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-1178"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679221045"><span class="hs-identifier hs-var">eres</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1179"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679221046"><a href="#local-6989586621679221046"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679221046"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1180"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679221047"><a href="#local-6989586621679221047"><span class="hs-identifier">newCache</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679221048"><a href="#local-6989586621679221048"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1181"></a><span>          </span><a name="local-6989586621679221049"><a href="#local-6989586621679221049"><span class="hs-identifier">gs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-1182"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679221050"><a href="#local-6989586621679221050"><span class="hs-identifier">merged</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679221047"><span class="hs-identifier hs-var">newCache</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">HM.union</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ghsCacheBy</span><span> </span><a href="#local-6989586621679221049"><span class="hs-identifier hs-var">gs</span></a><span>
</span><a name="line-1183"></a><span>          </span><a href="Yesod.Core.Handler.html#put"><span class="hs-identifier hs-var">put</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679221049"><span class="hs-identifier hs-var">gs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ghsCacheBy</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679221050"><span class="hs-identifier hs-var">merged</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1184"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679221048"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1185"></a><span>
</span><a name="line-1186"></a><span class="hs-comment">-- | Retrieves a value from the cache used by 'cachedBy'.</span><span>
</span><a name="line-1187"></a><span class="hs-comment">--</span><span>
</span><a name="line-1188"></a><span class="hs-comment">-- @since 1.6.10</span><span>
</span><a name="line-1189"></a><span class="hs-identifier">cacheByGet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219511"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679219512"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1190"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">S.ByteString</span><span>
</span><a name="line-1191"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219511"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679219512"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1192"></a><a name="cacheByGet"><a href="Yesod.Core.Handler.html#cacheByGet"><span class="hs-identifier">cacheByGet</span></a></a><span> </span><a name="local-6989586621679221051"><a href="#local-6989586621679221051"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1193"></a><span>  </span><a name="local-6989586621679221052"><a href="#local-6989586621679221052"><span class="hs-identifier">cache</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ghsCacheBy</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-1194"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.TypeCache.html#cacheByGet"><span class="hs-identifier hs-var">Cache.cacheByGet</span></a><span> </span><a href="#local-6989586621679221051"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621679221052"><span class="hs-identifier hs-var">cache</span></a><span>
</span><a name="line-1195"></a><span>
</span><a name="line-1196"></a><span class="hs-comment">-- | Sets a value in the cache used by 'cachedBy'.</span><span>
</span><a name="line-1197"></a><span class="hs-comment">--</span><span>
</span><a name="line-1198"></a><span class="hs-comment">-- @since 1.6.10</span><span>
</span><a name="line-1199"></a><span class="hs-identifier">cacheBySet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219509"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679219510"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1200"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">S.ByteString</span><span>
</span><a name="line-1201"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219510"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1202"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219509"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1203"></a><a name="cacheBySet"><a href="Yesod.Core.Handler.html#cacheBySet"><span class="hs-identifier">cacheBySet</span></a></a><span> </span><a name="local-6989586621679221053"><a href="#local-6989586621679221053"><span class="hs-identifier">key</span></a></a><span> </span><a name="local-6989586621679221054"><a href="#local-6989586621679221054"><span class="hs-identifier">value</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1204"></a><span>  </span><a name="local-6989586621679221055"><a href="#local-6989586621679221055"><span class="hs-identifier">gs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-1205"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679221056"><a href="#local-6989586621679221056"><span class="hs-identifier">cache</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ghsCacheBy</span><span> </span><a href="#local-6989586621679221055"><span class="hs-identifier hs-var">gs</span></a><span>
</span><a name="line-1206"></a><span>      </span><a name="local-6989586621679221057"><a href="#local-6989586621679221057"><span class="hs-identifier">newCache</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.TypeCache.html#cacheBySet"><span class="hs-identifier hs-var">Cache.cacheBySet</span></a><span> </span><a href="#local-6989586621679221053"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621679221054"><span class="hs-identifier hs-var">value</span></a><span> </span><a href="#local-6989586621679221056"><span class="hs-identifier hs-var">cache</span></a><span>
</span><a name="line-1207"></a><span>  </span><a href="Yesod.Core.Handler.html#put"><span class="hs-identifier hs-var">put</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679221055"><span class="hs-identifier hs-var">gs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ghsCacheBy</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679221057"><span class="hs-identifier hs-var">newCache</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1208"></a><span>
</span><a name="line-1209"></a><span class="hs-comment">-- | Get the list of supported languages supplied by the user.</span><span>
</span><a name="line-1210"></a><span class="hs-comment">--</span><span>
</span><a name="line-1211"></a><span class="hs-comment">-- Languages are determined based on the following (in descending order</span><span>
</span><a name="line-1212"></a><span class="hs-comment">-- of preference):</span><span>
</span><a name="line-1213"></a><span class="hs-comment">--</span><span>
</span><a name="line-1214"></a><span class="hs-comment">-- * The _LANG user session variable.</span><span>
</span><a name="line-1215"></a><span class="hs-comment">--</span><span>
</span><a name="line-1216"></a><span class="hs-comment">-- * The _LANG get parameter.</span><span>
</span><a name="line-1217"></a><span class="hs-comment">--</span><span>
</span><a name="line-1218"></a><span class="hs-comment">-- * The _LANG cookie.</span><span>
</span><a name="line-1219"></a><span class="hs-comment">--</span><span>
</span><a name="line-1220"></a><span class="hs-comment">-- * Accept-Language HTTP header.</span><span>
</span><a name="line-1221"></a><span class="hs-comment">--</span><span>
</span><a name="line-1222"></a><span class="hs-comment">-- Yesod will seek the first language from the returned list matched with languages supporting by your application. This language will be used to render i18n templates.</span><span>
</span><a name="line-1223"></a><span class="hs-comment">-- If a matching language is not found the default language will be used.</span><span>
</span><a name="line-1224"></a><span class="hs-comment">--</span><span>
</span><a name="line-1225"></a><span class="hs-comment">-- This is handled by parseWaiRequest (not exposed).</span><span>
</span><a name="line-1226"></a><span class="hs-identifier">languages</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219508"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219508"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">]</span><span>
</span><a name="line-1227"></a><a name="languages"><a href="Yesod.Core.Handler.html#languages"><span class="hs-identifier">languages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1228"></a><span>    </span><a name="local-6989586621679221058"><a href="#local-6989586621679221058"><span class="hs-identifier">mlang</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#lookupSession"><span class="hs-identifier hs-var">lookupSession</span></a><span> </span><a href="Yesod.Core.Internal.Request.html#langKey"><span class="hs-identifier hs-var">langKey</span></a><span>
</span><a name="line-1229"></a><span>    </span><a name="local-6989586621679221059"><a href="#local-6989586621679221059"><span class="hs-identifier">langs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">reqLangs</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#getRequest"><span class="hs-identifier hs-var">getRequest</span></a><span>
</span><a name="line-1230"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679221058"><span class="hs-identifier hs-var">mlang</span></a><span> </span><a href="#local-6989586621679221059"><span class="hs-identifier hs-var">langs</span></a><span>
</span><a name="line-1231"></a><span>
</span><a name="line-1232"></a><span class="hs-identifier">lookup'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621679219506"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219506"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679219506"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679219507"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679219507"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-1233"></a><a name="lookup%27"><a href="Yesod.Core.Handler.html#lookup%27"><span class="hs-identifier">lookup'</span></a></a><span> </span><a name="local-6989586621679221060"><a href="#local-6989586621679221060"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679221061"><a href="#local-6989586621679221061"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679221060"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679221061"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-1234"></a><span>
</span><a name="line-1235"></a><span class="hs-comment">-- | Lookup a request header.</span><span>
</span><a name="line-1236"></a><span class="hs-comment">--</span><span>
</span><a name="line-1237"></a><span class="hs-comment">-- @since 1.2.2</span><span>
</span><a name="line-1238"></a><span class="hs-identifier">lookupHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219505"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CI</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219505"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-1239"></a><a name="lookupHeader"><a href="Yesod.Core.Handler.html#lookupHeader"><span class="hs-identifier">lookupHeader</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Handler.html#lookupHeaders"><span class="hs-identifier hs-var">lookupHeaders</span></a><span>
</span><a name="line-1240"></a><span>
</span><a name="line-1241"></a><span class="hs-comment">-- | Lookup a request header.</span><span>
</span><a name="line-1242"></a><span class="hs-comment">--</span><span>
</span><a name="line-1243"></a><span class="hs-comment">-- @since 1.2.2</span><span>
</span><a name="line-1244"></a><span class="hs-identifier">lookupHeaders</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219504"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CI</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219504"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">S8.ByteString</span><span class="hs-special">]</span><span>
</span><a name="line-1245"></a><a name="lookupHeaders"><a href="Yesod.Core.Handler.html#lookupHeaders"><span class="hs-identifier">lookupHeaders</span></a></a><span> </span><a name="local-6989586621679221062"><a href="#local-6989586621679221062"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1246"></a><span>    </span><a name="local-6989586621679221063"><a href="#local-6989586621679221063"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#waiRequest"><span class="hs-identifier hs-var">waiRequest</span></a><span>
</span><a name="line-1247"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Handler.html#lookup%27"><span class="hs-identifier hs-var">lookup'</span></a><span> </span><a href="#local-6989586621679221062"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">W.requestHeaders</span><span> </span><a href="#local-6989586621679221063"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-1248"></a><span>
</span><a name="line-1249"></a><span class="hs-comment">-- | Lookup basic authentication data from __Authorization__ header of</span><span>
</span><a name="line-1250"></a><span class="hs-comment">-- request. Returns user name and password</span><span>
</span><a name="line-1251"></a><span class="hs-comment">--</span><span>
</span><a name="line-1252"></a><span class="hs-comment">-- @since 1.4.9</span><span>
</span><a name="line-1253"></a><span class="hs-identifier">lookupBasicAuth</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219503"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219503"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1254"></a><a name="lookupBasicAuth"><a href="Yesod.Core.Handler.html#lookupBasicAuth"><span class="hs-identifier">lookupBasicAuth</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679221064"><span class="hs-identifier hs-var">getBA</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#lookupHeader"><span class="hs-identifier hs-var">lookupHeader</span></a><span> </span><span class="hs-string">&quot;Authorization&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1255"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1256"></a><span>    </span><a name="local-6989586621679221064"><a href="#local-6989586621679221064"><span class="hs-identifier">getBA</span></a></a><span> </span><a name="local-6989586621679221065"><a href="#local-6989586621679221065"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decodeUtf8With</span><span> </span><span class="hs-identifier hs-var">lenientDecode</span><span> </span><span class="hs-operator hs-var">***</span><span> </span><span class="hs-identifier hs-var">decodeUtf8With</span><span> </span><span class="hs-identifier hs-var">lenientDecode</span><span class="hs-special">)</span><span>
</span><a name="line-1257"></a><span>               </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">extractBasicAuth</span><span> </span><a href="#local-6989586621679221065"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1258"></a><span>
</span><a name="line-1259"></a><span class="hs-comment">-- | Lookup bearer authentication datafrom __Authorization__ header of</span><span>
</span><a name="line-1260"></a><span class="hs-comment">-- request. Returns bearer token value</span><span>
</span><a name="line-1261"></a><span class="hs-comment">--</span><span>
</span><a name="line-1262"></a><span class="hs-comment">-- @since 1.4.9</span><span>
</span><a name="line-1263"></a><span class="hs-identifier">lookupBearerAuth</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219502"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219502"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-1264"></a><a name="lookupBearerAuth"><a href="Yesod.Core.Handler.html#lookupBearerAuth"><span class="hs-identifier">lookupBearerAuth</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679221066"><span class="hs-identifier hs-var">getBR</span></a><span class="hs-special">)</span><span>
</span><a name="line-1265"></a><span>                   </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#lookupHeader"><span class="hs-identifier hs-var">lookupHeader</span></a><span> </span><span class="hs-string">&quot;Authorization&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1266"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1267"></a><span>    </span><a name="local-6989586621679221066"><a href="#local-6989586621679221066"><span class="hs-identifier">getBR</span></a></a><span> </span><a name="local-6989586621679221067"><a href="#local-6989586621679221067"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">decodeUtf8With</span><span> </span><span class="hs-identifier hs-var">lenientDecode</span><span>
</span><a name="line-1268"></a><span>               </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">extractBearerAuth</span><span> </span><a href="#local-6989586621679221067"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1269"></a><span>
</span><a name="line-1270"></a><span>
</span><a name="line-1271"></a><span class="hs-comment">-- | Lookup for GET parameters.</span><span>
</span><a name="line-1272"></a><span class="hs-identifier">lookupGetParams</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219501"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219501"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">]</span><span>
</span><a name="line-1273"></a><a name="lookupGetParams"><a href="Yesod.Core.Handler.html#lookupGetParams"><span class="hs-identifier">lookupGetParams</span></a></a><span> </span><a name="local-6989586621679221068"><a href="#local-6989586621679221068"><span class="hs-identifier">pn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1274"></a><span>    </span><a name="local-6989586621679221069"><a href="#local-6989586621679221069"><span class="hs-identifier">rr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#getRequest"><span class="hs-identifier hs-var">getRequest</span></a><span>
</span><a name="line-1275"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Handler.html#lookup%27"><span class="hs-identifier hs-var">lookup'</span></a><span> </span><a href="#local-6989586621679221068"><span class="hs-identifier hs-var">pn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">reqGetParams</span><span> </span><a href="#local-6989586621679221069"><span class="hs-identifier hs-var">rr</span></a><span>
</span><a name="line-1276"></a><span>
</span><a name="line-1277"></a><span class="hs-comment">-- | Lookup for GET parameters.</span><span>
</span><a name="line-1278"></a><span class="hs-identifier">lookupGetParam</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219500"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219500"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-1279"></a><a name="lookupGetParam"><a href="Yesod.Core.Handler.html#lookupGetParam"><span class="hs-identifier">lookupGetParam</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Handler.html#lookupGetParams"><span class="hs-identifier hs-var">lookupGetParams</span></a><span>
</span><a name="line-1280"></a><span>
</span><a name="line-1281"></a><span class="hs-comment">-- | Lookup for POST parameters.</span><span>
</span><a name="line-1282"></a><span class="hs-identifier">lookupPostParams</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadResource</span><span> </span><a href="#local-6989586621679219499"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219499"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219499"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">]</span><span>
</span><a name="line-1283"></a><a name="lookupPostParams"><a href="Yesod.Core.Handler.html#lookupPostParams"><span class="hs-identifier">lookupPostParams</span></a></a><span> </span><a name="local-6989586621679221070"><a href="#local-6989586621679221070"><span class="hs-identifier">pn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1284"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679221071"><a href="#local-6989586621679221071"><span class="hs-identifier">pp</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#runRequestBody"><span class="hs-identifier hs-var">runRequestBody</span></a><span>
</span><a name="line-1285"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Handler.html#lookup%27"><span class="hs-identifier hs-var">lookup'</span></a><span> </span><a href="#local-6989586621679221070"><span class="hs-identifier hs-var">pn</span></a><span> </span><a href="#local-6989586621679221071"><span class="hs-identifier hs-var">pp</span></a><span>
</span><a name="line-1286"></a><span>
</span><a name="line-1287"></a><span class="hs-identifier">lookupPostParam</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadResource</span><span> </span><a href="#local-6989586621679219498"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219498"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1288"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-1289"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219498"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-1290"></a><a name="lookupPostParam"><a href="Yesod.Core.Handler.html#lookupPostParam"><span class="hs-identifier">lookupPostParam</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Handler.html#lookupPostParams"><span class="hs-identifier hs-var">lookupPostParams</span></a><span>
</span><a name="line-1291"></a><span>
</span><a name="line-1292"></a><span class="hs-comment">-- | Lookup for POSTed files.</span><span>
</span><a name="line-1293"></a><span class="hs-identifier">lookupFile</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219497"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1294"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-1295"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219497"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Yesod.Core.Types.html#FileInfo"><span class="hs-identifier hs-type">FileInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-1296"></a><a name="lookupFile"><a href="Yesod.Core.Handler.html#lookupFile"><span class="hs-identifier">lookupFile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Handler.html#lookupFiles"><span class="hs-identifier hs-var">lookupFiles</span></a><span>
</span><a name="line-1297"></a><span>
</span><a name="line-1298"></a><span class="hs-comment">-- | Lookup for POSTed files.</span><span>
</span><a name="line-1299"></a><span class="hs-identifier">lookupFiles</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219496"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1300"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-1301"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219496"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Types.html#FileInfo"><span class="hs-identifier hs-type">FileInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-1302"></a><a name="lookupFiles"><a href="Yesod.Core.Handler.html#lookupFiles"><span class="hs-identifier">lookupFiles</span></a></a><span> </span><a name="local-6989586621679221072"><a href="#local-6989586621679221072"><span class="hs-identifier">pn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1303"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679221073"><a href="#local-6989586621679221073"><span class="hs-identifier">files</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#runRequestBody"><span class="hs-identifier hs-var">runRequestBody</span></a><span>
</span><a name="line-1304"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Handler.html#lookup%27"><span class="hs-identifier hs-var">lookup'</span></a><span> </span><a href="#local-6989586621679221072"><span class="hs-identifier hs-var">pn</span></a><span> </span><a href="#local-6989586621679221073"><span class="hs-identifier hs-var">files</span></a><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span class="hs-comment">-- | Lookup for cookie data.</span><span>
</span><a name="line-1307"></a><span class="hs-identifier">lookupCookie</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219495"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219495"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-1308"></a><a name="lookupCookie"><a href="Yesod.Core.Handler.html#lookupCookie"><span class="hs-identifier">lookupCookie</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Handler.html#lookupCookies"><span class="hs-identifier hs-var">lookupCookies</span></a><span>
</span><a name="line-1309"></a><span>
</span><a name="line-1310"></a><span class="hs-comment">-- | Lookup for cookie data.</span><span>
</span><a name="line-1311"></a><span class="hs-identifier">lookupCookies</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219494"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219494"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">]</span><span>
</span><a name="line-1312"></a><a name="lookupCookies"><a href="Yesod.Core.Handler.html#lookupCookies"><span class="hs-identifier">lookupCookies</span></a></a><span> </span><a name="local-6989586621679221074"><a href="#local-6989586621679221074"><span class="hs-identifier">pn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1313"></a><span>    </span><a name="local-6989586621679221075"><a href="#local-6989586621679221075"><span class="hs-identifier">rr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#getRequest"><span class="hs-identifier hs-var">getRequest</span></a><span>
</span><a name="line-1314"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Handler.html#lookup%27"><span class="hs-identifier hs-var">lookup'</span></a><span> </span><a href="#local-6989586621679221074"><span class="hs-identifier hs-var">pn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">reqCookies</span><span> </span><a href="#local-6989586621679221075"><span class="hs-identifier hs-var">rr</span></a><span>
</span><a name="line-1315"></a><span>
</span><a name="line-1316"></a><span class="hs-comment">-- $representations</span><span>
</span><a name="line-1317"></a><span class="hs-comment">--</span><span>
</span><a name="line-1318"></a><span class="hs-comment">-- HTTP allows content negotation to determine what /representation/ of data</span><span>
</span><a name="line-1319"></a><span class="hs-comment">-- you would like to use. The most common example of this is providing both a</span><span>
</span><a name="line-1320"></a><span class="hs-comment">-- user-facing HTML page and an API facing JSON response from the same URL. The</span><span>
</span><a name="line-1321"></a><span class="hs-comment">-- means of achieving this is the Accept HTTP header, which provides a list of</span><span>
</span><a name="line-1322"></a><span class="hs-comment">-- content types the client will accept, sorted by preference.</span><span>
</span><a name="line-1323"></a><span class="hs-comment">--</span><span>
</span><a name="line-1324"></a><span class="hs-comment">-- By using 'selectRep' and 'provideRep', you can provide a number of different</span><span>
</span><a name="line-1325"></a><span class="hs-comment">-- representations, e.g.:</span><span>
</span><a name="line-1326"></a><span class="hs-comment">--</span><span>
</span><a name="line-1327"></a><span class="hs-comment">-- &gt; selectRep $ do</span><span>
</span><a name="line-1328"></a><span class="hs-comment">-- &gt;   provideRep produceHtmlOutput</span><span>
</span><a name="line-1329"></a><span class="hs-comment">-- &gt;   provideRep produceJsonOutput</span><span>
</span><a name="line-1330"></a><span class="hs-comment">--</span><span>
</span><a name="line-1331"></a><span class="hs-comment">-- The first provided representation will be used if no matches are found.</span><span>
</span><a name="line-1332"></a><span>
</span><a name="line-1333"></a><span class="hs-comment">-- | Select a representation to send to the client based on the representations</span><span>
</span><a name="line-1334"></a><span class="hs-comment">-- provided inside this do-block. Should be used together with 'provideRep'.</span><span>
</span><a name="line-1335"></a><span class="hs-comment">--</span><span>
</span><a name="line-1336"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1337"></a><span class="hs-identifier">selectRep</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219493"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1338"></a><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Writer.Writer</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Endo</span><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Handler.html#ProvidedRep"><span class="hs-identifier hs-type">ProvidedRep</span></a><span> </span><a href="#local-6989586621679219493"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1339"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219493"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Yesod.Core.Types.html#TypedContent"><span class="hs-identifier hs-type">TypedContent</span></a><span>
</span><a name="line-1340"></a><a name="selectRep"><a href="Yesod.Core.Handler.html#selectRep"><span class="hs-identifier">selectRep</span></a></a><span> </span><a name="local-6989586621679221076"><a href="#local-6989586621679221076"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1341"></a><span>    </span><span class="hs-comment">-- the content types are already sorted by q values</span><span>
</span><a name="line-1342"></a><span>    </span><span class="hs-comment">-- which have been stripped</span><span>
</span><a name="line-1343"></a><span>    </span><a name="local-6989586621679221094"><a href="#local-6989586621679221094"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">reqAccept</span><span> </span><a href="Yesod.Core.Handler.html#getRequest"><span class="hs-identifier hs-var">getRequest</span></a><span>
</span><a name="line-1344"></a><span>
</span><a name="line-1345"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="#local-6989586621679221081"><span class="hs-identifier hs-var">tryAccept</span></a><span> </span><a href="#local-6989586621679221094"><span class="hs-identifier hs-var">cts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1346"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1347"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679221078"><span class="hs-identifier hs-var">reps</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1348"></a><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Handler.html#sendResponseStatus"><span class="hs-identifier hs-var">sendResponseStatus</span></a><span> </span><span class="hs-identifier hs-var">H.status500</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;No reps provided to selectRep&quot;</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-1349"></a><span>                </span><a name="local-6989586621679221095"><a href="#local-6989586621679221095"><span class="hs-identifier">rep</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679221077"><span class="hs-identifier hs-var">returnRep</span></a><span> </span><a href="#local-6989586621679221095"><span class="hs-identifier hs-var">rep</span></a><span>
</span><a name="line-1350"></a><span>        </span><a name="local-6989586621679221096"><a href="#local-6989586621679221096"><span class="hs-identifier">rep</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679221077"><span class="hs-identifier hs-var">returnRep</span></a><span> </span><a href="#local-6989586621679221096"><span class="hs-identifier hs-var">rep</span></a><span>
</span><a name="line-1351"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1352"></a><span>    </span><a name="local-6989586621679221077"><a href="#local-6989586621679221077"><span class="hs-identifier">returnRep</span></a></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#ProvidedRep"><span class="hs-identifier hs-var">ProvidedRep</span></a><span> </span><a name="local-6989586621679221084"><a href="#local-6989586621679221084"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621679221085"><a href="#local-6989586621679221085"><span class="hs-identifier">mcontent</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Types.html#TypedContent"><span class="hs-identifier hs-var">TypedContent</span></a><span> </span><a href="#local-6989586621679221084"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679221085"><span class="hs-identifier hs-var">mcontent</span></a><span>
</span><a name="line-1353"></a><span>
</span><a name="line-1354"></a><span>    </span><a name="local-6989586621679221078"><a href="#local-6989586621679221078"><span class="hs-identifier">reps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">appEndo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Writer.execWriter</span><span> </span><a href="#local-6989586621679221076"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1355"></a><span>
</span><a name="line-1356"></a><span>    </span><a name="local-6989586621679221079"><a href="#local-6989586621679221079"><span class="hs-identifier">repMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.unions</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679221086"><a href="#local-6989586621679221086"><span class="hs-identifier">v</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#ProvidedRep"><span class="hs-identifier hs-var">ProvidedRep</span></a><span> </span><a name="local-6989586621679221087"><a href="#local-6989586621679221087"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span>
</span><a name="line-1357"></a><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679221087"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679221086"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1358"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679221083"><span class="hs-identifier hs-var">noSpace</span></a><span> </span><a href="#local-6989586621679221087"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679221086"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1359"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Content.html#simpleContentType"><span class="hs-identifier hs-var">simpleContentType</span></a><span> </span><a href="#local-6989586621679221087"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679221086"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1360"></a><span>        </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679221078"><span class="hs-identifier hs-var">reps</span></a><span>
</span><a name="line-1361"></a><span>
</span><a name="line-1362"></a><span>    </span><span class="hs-comment">-- match on the type for sub-type wildcards.</span><span>
</span><a name="line-1363"></a><span>    </span><span class="hs-comment">-- If the accept is text/ * it should match a provided text/html</span><span>
</span><a name="line-1364"></a><span>    </span><a name="local-6989586621679221080"><a href="#local-6989586621679221080"><span class="hs-identifier">mainTypeMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span>
</span><a name="line-1365"></a><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679221088"><a href="#local-6989586621679221088"><span class="hs-identifier">v</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#ProvidedRep"><span class="hs-identifier hs-var">ProvidedRep</span></a><span> </span><a name="local-6989586621679221089"><a href="#local-6989586621679221089"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Content.html#contentTypeTypes"><span class="hs-identifier hs-var">contentTypeTypes</span></a><span> </span><a href="#local-6989586621679221089"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679221088"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679221078"><span class="hs-identifier hs-var">reps</span></a><span>
</span><a name="line-1366"></a><span>
</span><a name="line-1367"></a><span>    </span><a name="local-6989586621679221081"><a href="#local-6989586621679221081"><span class="hs-identifier">tryAccept</span></a></a><span> </span><a name="local-6989586621679221090"><a href="#local-6989586621679221090"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1368"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679221092"><span class="hs-identifier hs-var">subType</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;*&quot;</span><span>
</span><a name="line-1369"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679221091"><span class="hs-identifier hs-var">mainType</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;*&quot;</span><span>
</span><a name="line-1370"></a><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><a href="#local-6989586621679221078"><span class="hs-identifier hs-var">reps</span></a><span>
</span><a name="line-1371"></a><span>                 </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679221091"><span class="hs-identifier hs-var">mainType</span></a><span> </span><a href="#local-6989586621679221080"><span class="hs-identifier hs-var">mainTypeMap</span></a><span>
</span><a name="line-1372"></a><span>          </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679221082"><span class="hs-identifier hs-var">lookupAccept</span></a><span> </span><a href="#local-6989586621679221090"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1373"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-1374"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679221091"><a href="#local-6989586621679221091"><span class="hs-identifier">mainType</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679221092"><a href="#local-6989586621679221092"><span class="hs-identifier">subType</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Content.html#contentTypeTypes"><span class="hs-identifier hs-var">contentTypeTypes</span></a><span> </span><a href="#local-6989586621679221090"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1375"></a><span>
</span><a name="line-1376"></a><span>    </span><a name="local-6989586621679221082"><a href="#local-6989586621679221082"><span class="hs-identifier">lookupAccept</span></a></a><span> </span><a name="local-6989586621679221093"><a href="#local-6989586621679221093"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679221093"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621679221079"><span class="hs-identifier hs-var">repMap</span></a><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span>
</span><a name="line-1377"></a><span>                      </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679221083"><span class="hs-identifier hs-var">noSpace</span></a><span> </span><a href="#local-6989586621679221093"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679221079"><span class="hs-identifier hs-var">repMap</span></a><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span>
</span><a name="line-1378"></a><span>                      </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Content.html#simpleContentType"><span class="hs-identifier hs-var">simpleContentType</span></a><span> </span><a href="#local-6989586621679221093"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679221079"><span class="hs-identifier hs-var">repMap</span></a><span>
</span><a name="line-1379"></a><span>
</span><a name="line-1380"></a><span>    </span><span class="hs-comment">-- Mime types such as &quot;text/html; charset=foo&quot; get converted to</span><span>
</span><a name="line-1381"></a><span>    </span><span class="hs-comment">-- &quot;text/html;charset=foo&quot;</span><span>
</span><a name="line-1382"></a><span>    </span><a name="local-6989586621679221083"><a href="#local-6989586621679221083"><span class="hs-identifier">noSpace</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S8.filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">' '</span><span class="hs-special">)</span><span>
</span><a name="line-1383"></a><span>
</span><a name="line-1384"></a><span class="hs-comment">-- | Internal representation of a single provided representation.</span><span>
</span><a name="line-1385"></a><span class="hs-comment">--</span><span>
</span><a name="line-1386"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1387"></a><span class="hs-keyword">data</span><span> </span><a name="ProvidedRep"><a href="Yesod.Core.Handler.html#ProvidedRep"><span class="hs-identifier">ProvidedRep</span></a></a><span> </span><a name="local-6989586621679219425"><a href="#local-6989586621679219425"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ProvidedRep"><a href="Yesod.Core.Handler.html#ProvidedRep"><span class="hs-identifier">ProvidedRep</span></a></a><span> </span><span class="hs-glyph">!</span><a href="Yesod.Core.Types.html#ContentType"><span class="hs-identifier hs-type">ContentType</span></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="#local-6989586621679219425"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Yesod.Core.Types.html#Content"><span class="hs-identifier hs-type">Content</span></a><span class="hs-special">)</span><span>
</span><a name="line-1388"></a><span>
</span><a name="line-1389"></a><span class="hs-comment">-- | Provide a single representation to be used, based on the request of the</span><span>
</span><a name="line-1390"></a><span class="hs-comment">-- client. Should be used together with 'selectRep'.</span><span>
</span><a name="line-1391"></a><span class="hs-comment">--</span><span>
</span><a name="line-1392"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1393"></a><span class="hs-identifier">provideRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679219491"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Content.html#HasContentType"><span class="hs-identifier hs-type">HasContentType</span></a><span> </span><a href="#local-6989586621679219492"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1394"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219491"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219492"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1395"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Writer.Writer</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Endo</span><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Handler.html#ProvidedRep"><span class="hs-identifier hs-type">ProvidedRep</span></a><span> </span><a href="#local-6989586621679219491"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1396"></a><a name="provideRep"><a href="Yesod.Core.Handler.html#provideRep"><span class="hs-identifier">provideRep</span></a></a><span> </span><a name="local-6989586621679221097"><a href="#local-6989586621679221097"><span class="hs-identifier">handler</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#provideRepType"><span class="hs-identifier hs-var">provideRepType</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Content.html#getContentType"><span class="hs-identifier hs-var">getContentType</span></a><span> </span><a href="#local-6989586621679221097"><span class="hs-identifier hs-var">handler</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679221097"><span class="hs-identifier hs-var">handler</span></a><span>
</span><a name="line-1397"></a><span>
</span><a name="line-1398"></a><span class="hs-comment">-- | Same as 'provideRep', but instead of determining the content type from the</span><span>
</span><a name="line-1399"></a><span class="hs-comment">-- type of the value itself, you provide the content type separately. This can</span><span>
</span><a name="line-1400"></a><span class="hs-comment">-- be a convenience instead of creating newtype wrappers for uncommonly used</span><span>
</span><a name="line-1401"></a><span class="hs-comment">-- content types.</span><span>
</span><a name="line-1402"></a><span class="hs-comment">--</span><span>
</span><a name="line-1403"></a><span class="hs-comment">-- &gt; provideRepType &quot;application/x-special-format&quot; &quot;This is the content&quot;</span><span>
</span><a name="line-1404"></a><span class="hs-comment">--</span><span>
</span><a name="line-1405"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1406"></a><span class="hs-identifier">provideRepType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679219489"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Content.html#ToContent"><span class="hs-identifier hs-type">ToContent</span></a><span> </span><a href="#local-6989586621679219490"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1407"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Types.html#ContentType"><span class="hs-identifier hs-type">ContentType</span></a><span>
</span><a name="line-1408"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219489"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679219490"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1409"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Writer.Writer</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Endo</span><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Handler.html#ProvidedRep"><span class="hs-identifier hs-type">ProvidedRep</span></a><span> </span><a href="#local-6989586621679219489"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1410"></a><a name="provideRepType"><a href="Yesod.Core.Handler.html#provideRepType"><span class="hs-identifier">provideRepType</span></a></a><span> </span><a name="local-6989586621679221098"><a href="#local-6989586621679221098"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621679221099"><a href="#local-6989586621679221099"><span class="hs-identifier">handler</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1411"></a><span>    </span><span class="hs-identifier hs-var">Writer.tell</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Endo</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#ProvidedRep"><span class="hs-identifier hs-var">ProvidedRep</span></a><span> </span><a href="#local-6989586621679221098"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftM</span><span> </span><a href="Yesod.Core.Content.html#toContent"><span class="hs-identifier hs-var">toContent</span></a><span> </span><a href="#local-6989586621679221099"><span class="hs-identifier hs-var">handler</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-1412"></a><span>
</span><a name="line-1413"></a><span class="hs-comment">-- | Stream in the raw request body without any parsing.</span><span>
</span><a name="line-1414"></a><span class="hs-comment">--</span><span>
</span><a name="line-1415"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1416"></a><span class="hs-identifier">rawRequestBody</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219487"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><a href="#local-6989586621679219488"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-identifier hs-type">S.ByteString</span><span> </span><a href="#local-6989586621679219487"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1417"></a><a name="rawRequestBody"><a href="Yesod.Core.Handler.html#rawRequestBody"><span class="hs-identifier">rawRequestBody</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1418"></a><span>    </span><a name="local-6989586621679221100"><a href="#local-6989586621679221100"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><a href="Yesod.Core.Handler.html#waiRequest"><span class="hs-identifier hs-var">waiRequest</span></a><span>
</span><a name="line-1419"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679221101"><a href="#local-6989586621679221101"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1420"></a><span>            </span><a name="local-6989586621679221102"><a href="#local-6989586621679221102"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">W.requestBody</span><span> </span><a href="#local-6989586621679221100"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-1421"></a><span>            </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S.null</span><span> </span><a href="#local-6989586621679221102"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1422"></a><span>                </span><span class="hs-identifier hs-var">yield</span><span> </span><a href="#local-6989586621679221102"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1423"></a><span>                </span><a href="#local-6989586621679221101"><span class="hs-identifier hs-var">loop</span></a><span>
</span><a name="line-1424"></a><span>    </span><a href="#local-6989586621679221101"><span class="hs-identifier hs-var">loop</span></a><span>
</span><a name="line-1425"></a><span>
</span><a name="line-1426"></a><span class="hs-comment">-- | Stream the data from the file. Since Yesod 1.2, this has been generalized</span><span>
</span><a name="line-1427"></a><span class="hs-comment">-- to work in any @MonadResource@.</span><span>
</span><a name="line-1428"></a><span class="hs-identifier">fileSource</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadResource</span><span> </span><a href="#local-6989586621679219486"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Types.html#FileInfo"><span class="hs-identifier hs-type">FileInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">S.ByteString</span><span> </span><a href="#local-6989586621679219486"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1429"></a><a name="fileSource"><a href="Yesod.Core.Handler.html#fileSource"><span class="hs-identifier">fileSource</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">transPipe</span><span> </span><span class="hs-identifier hs-var">liftResourceT</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">fileSourceRaw</span><span>
</span><a name="line-1430"></a><span>
</span><a name="line-1431"></a><span class="hs-comment">-- | Extract a strict `ByteString` body from a `FileInfo`.</span><span>
</span><a name="line-1432"></a><span class="hs-comment">--</span><span>
</span><a name="line-1433"></a><span class="hs-comment">-- This function will block while reading the file.</span><span>
</span><a name="line-1434"></a><span class="hs-comment">--</span><span>
</span><a name="line-1435"></a><span class="hs-comment">-- &gt; do</span><span>
</span><a name="line-1436"></a><span class="hs-comment">-- &gt;     fileByteString &lt;- fileSourceByteString fileInfo</span><span>
</span><a name="line-1437"></a><span class="hs-comment">--</span><span>
</span><a name="line-1438"></a><span class="hs-comment">-- @since 1.6.5</span><span>
</span><a name="line-1439"></a><span class="hs-identifier">fileSourceByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadResource</span><span> </span><a href="#local-6989586621679219485"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Types.html#FileInfo"><span class="hs-identifier hs-type">FileInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219485"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">S.ByteString</span><span>
</span><a name="line-1440"></a><a name="fileSourceByteString"><a href="Yesod.Core.Handler.html#fileSourceByteString"><span class="hs-identifier">fileSourceByteString</span></a></a><span> </span><a name="local-6989586621679221103"><a href="#local-6989586621679221103"><span class="hs-identifier">fileInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runConduit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L.toStrict</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#fileSource"><span class="hs-identifier hs-var">fileSource</span></a><span> </span><a href="#local-6989586621679221103"><span class="hs-identifier hs-var">fileInfo</span></a><span> </span><span class="hs-operator hs-var">.|</span><span> </span><span class="hs-identifier hs-var">sinkLazy</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1441"></a><span>
</span><a name="line-1442"></a><span class="hs-comment">-- | Provide a pure value for the response body.</span><span>
</span><a name="line-1443"></a><span class="hs-comment">--</span><span>
</span><a name="line-1444"></a><span class="hs-comment">-- &gt; respond ct = return . TypedContent ct . toContent</span><span>
</span><a name="line-1445"></a><span class="hs-comment">--</span><span>
</span><a name="line-1446"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1447"></a><span class="hs-identifier">respond</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679219483"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Content.html#ToContent"><span class="hs-identifier hs-type">ToContent</span></a><span> </span><a href="#local-6989586621679219484"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Types.html#ContentType"><span class="hs-identifier hs-type">ContentType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219484"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219483"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Yesod.Core.Types.html#TypedContent"><span class="hs-identifier hs-type">TypedContent</span></a><span>
</span><a name="line-1448"></a><a name="respond"><a href="Yesod.Core.Handler.html#respond"><span class="hs-identifier">respond</span></a></a><span> </span><a name="local-6989586621679221104"><a href="#local-6989586621679221104"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Types.html#TypedContent"><span class="hs-identifier hs-var">TypedContent</span></a><span> </span><a href="#local-6989586621679221104"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Content.html#toContent"><span class="hs-identifier hs-var">toContent</span></a><span>
</span><a name="line-1449"></a><span>
</span><a name="line-1450"></a><span class="hs-comment">-- | Use a @Source@ for the response body.</span><span>
</span><a name="line-1451"></a><span class="hs-comment">--</span><span>
</span><a name="line-1452"></a><span class="hs-comment">-- Note that, for ease of use, the underlying monad is a @HandlerT@. This</span><span>
</span><a name="line-1453"></a><span class="hs-comment">-- implies that you can run any @HandlerT@ action. However, since a streaming</span><span>
</span><a name="line-1454"></a><span class="hs-comment">-- response occurs after the response headers have already been sent, some</span><span>
</span><a name="line-1455"></a><span class="hs-comment">-- actions make no sense here. For example: short-circuit responses, setting</span><span>
</span><a name="line-1456"></a><span class="hs-comment">-- headers, changing status codes, etc.</span><span>
</span><a name="line-1457"></a><span class="hs-comment">--</span><span>
</span><a name="line-1458"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1459"></a><span class="hs-identifier">respondSource</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Types.html#ContentType"><span class="hs-identifier hs-type">ContentType</span></a><span>
</span><a name="line-1460"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Flush</span><span> </span><span class="hs-identifier hs-type">Builder</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-type">HandlerFor</span></a><span> </span><a href="#local-6989586621679219482"><span class="hs-identifier hs-type">site</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1461"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-type">HandlerFor</span></a><span> </span><a href="#local-6989586621679219482"><span class="hs-identifier hs-type">site</span></a><span> </span><a href="Yesod.Core.Types.html#TypedContent"><span class="hs-identifier hs-type">TypedContent</span></a><span>
</span><a name="line-1462"></a><a name="respondSource"><a href="Yesod.Core.Handler.html#respondSource"><span class="hs-identifier">respondSource</span></a></a><span> </span><a name="local-6989586621679221105"><a href="#local-6989586621679221105"><span class="hs-identifier">ctype</span></a></a><span> </span><a name="local-6989586621679221106"><a href="#local-6989586621679221106"><span class="hs-identifier">src</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Types.html#HandlerFor"><span class="hs-identifier hs-var">HandlerFor</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679221107"><a href="#local-6989586621679221107"><span class="hs-identifier">hd</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1463"></a><span>    </span><span class="hs-comment">-- Note that this implementation relies on the fact that the ResourceT</span><span>
</span><a name="line-1464"></a><span>    </span><span class="hs-comment">-- environment provided by the server is the same one used in HandlerT.</span><span>
</span><a name="line-1465"></a><span>    </span><span class="hs-comment">-- This is a safe assumption assuming the HandlerT is run correctly.</span><span>
</span><a name="line-1466"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#TypedContent"><span class="hs-identifier hs-var">TypedContent</span></a><span> </span><a href="#local-6989586621679221105"><span class="hs-identifier hs-var">ctype</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#ContentSource"><span class="hs-identifier hs-var">ContentSource</span></a><span>
</span><a name="line-1467"></a><span>           </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">transPipe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">unHandlerFor</span><span> </span><a href="#local-6989586621679221107"><span class="hs-identifier hs-var">hd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679221106"><span class="hs-identifier hs-var">src</span></a><span>
</span><a name="line-1468"></a><span>
</span><a name="line-1469"></a><span class="hs-comment">-- | In a streaming response, send a single chunk of data. This function works</span><span>
</span><a name="line-1470"></a><span class="hs-comment">-- on most datatypes, such as @ByteString@ and @Html@.</span><span>
</span><a name="line-1471"></a><span class="hs-comment">--</span><span>
</span><a name="line-1472"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1473"></a><span class="hs-identifier">sendChunk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679219479"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Yesod.Core.Content.html#ToFlushBuilder"><span class="hs-identifier hs-type">ToFlushBuilder</span></a><span> </span><a href="#local-6989586621679219480"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219480"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><a href="#local-6989586621679219481"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Flush</span><span> </span><span class="hs-identifier hs-type">Builder</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219479"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1474"></a><a name="sendChunk"><a href="Yesod.Core.Handler.html#sendChunk"><span class="hs-identifier">sendChunk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">yield</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Yesod.Core.Content.html#toFlushBuilder"><span class="hs-identifier hs-var">toFlushBuilder</span></a><span>
</span><a name="line-1475"></a><span>
</span><a name="line-1476"></a><span class="hs-comment">-- | In a streaming response, send a flush command, causing all buffered data</span><span>
</span><a name="line-1477"></a><span class="hs-comment">-- to be immediately sent to the client.</span><span>
</span><a name="line-1478"></a><span class="hs-comment">--</span><span>
</span><a name="line-1479"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1480"></a><span class="hs-identifier">sendFlush</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679219477"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><a href="#local-6989586621679219478"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Flush</span><span> </span><span class="hs-identifier hs-type">Builder</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219477"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1481"></a><a name="sendFlush"><a href="Yesod.Core.Handler.html#sendFlush"><span class="hs-identifier">sendFlush</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">yield</span><span> </span><span class="hs-identifier hs-var">Flush</span><span>
</span><a name="line-1482"></a><span>
</span><a name="line-1483"></a><span class="hs-comment">-- | Type-specialized version of 'sendChunk' for strict @ByteString@s.</span><span>
</span><a name="line-1484"></a><span class="hs-comment">--</span><span>
</span><a name="line-1485"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1486"></a><span class="hs-identifier">sendChunkBS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679219475"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">S.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><a href="#local-6989586621679219476"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Flush</span><span> </span><span class="hs-identifier hs-type">Builder</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219475"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1487"></a><a name="sendChunkBS"><a href="Yesod.Core.Handler.html#sendChunkBS"><span class="hs-identifier">sendChunkBS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#sendChunk"><span class="hs-identifier hs-var">sendChunk</span></a><span>
</span><a name="line-1488"></a><span>
</span><a name="line-1489"></a><span class="hs-comment">-- | Type-specialized version of 'sendChunk' for lazy @ByteString@s.</span><span>
</span><a name="line-1490"></a><span class="hs-comment">--</span><span>
</span><a name="line-1491"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1492"></a><span class="hs-identifier">sendChunkLBS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679219473"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">L.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><a href="#local-6989586621679219474"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Flush</span><span> </span><span class="hs-identifier hs-type">Builder</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219473"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1493"></a><a name="sendChunkLBS"><a href="Yesod.Core.Handler.html#sendChunkLBS"><span class="hs-identifier">sendChunkLBS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#sendChunk"><span class="hs-identifier hs-var">sendChunk</span></a><span>
</span><a name="line-1494"></a><span>
</span><a name="line-1495"></a><span class="hs-comment">-- | Type-specialized version of 'sendChunk' for strict @Text@s.</span><span>
</span><a name="line-1496"></a><span class="hs-comment">--</span><span>
</span><a name="line-1497"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1498"></a><span class="hs-identifier">sendChunkText</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679219471"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">T.Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><a href="#local-6989586621679219472"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Flush</span><span> </span><span class="hs-identifier hs-type">Builder</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219471"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1499"></a><a name="sendChunkText"><a href="Yesod.Core.Handler.html#sendChunkText"><span class="hs-identifier">sendChunkText</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#sendChunk"><span class="hs-identifier hs-var">sendChunk</span></a><span>
</span><a name="line-1500"></a><span>
</span><a name="line-1501"></a><span class="hs-comment">-- | Type-specialized version of 'sendChunk' for lazy @Text@s.</span><span>
</span><a name="line-1502"></a><span class="hs-comment">--</span><span>
</span><a name="line-1503"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1504"></a><span class="hs-identifier">sendChunkLazyText</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679219469"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TL.Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><a href="#local-6989586621679219470"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Flush</span><span> </span><span class="hs-identifier hs-type">Builder</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219469"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1505"></a><a name="sendChunkLazyText"><a href="Yesod.Core.Handler.html#sendChunkLazyText"><span class="hs-identifier">sendChunkLazyText</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#sendChunk"><span class="hs-identifier hs-var">sendChunk</span></a><span>
</span><a name="line-1506"></a><span>
</span><a name="line-1507"></a><span class="hs-comment">-- | Type-specialized version of 'sendChunk' for @Html@s.</span><span>
</span><a name="line-1508"></a><span class="hs-comment">--</span><span>
</span><a name="line-1509"></a><span class="hs-comment">-- @since 1.2.0</span><span>
</span><a name="line-1510"></a><span class="hs-identifier">sendChunkHtml</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679219467"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Html</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><a href="#local-6989586621679219468"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Flush</span><span> </span><span class="hs-identifier hs-type">Builder</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679219467"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1511"></a><a name="sendChunkHtml"><a href="Yesod.Core.Handler.html#sendChunkHtml"><span class="hs-identifier">sendChunkHtml</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#sendChunk"><span class="hs-identifier hs-var">sendChunk</span></a><span>
</span><a name="line-1512"></a><span>
</span><a name="line-1513"></a><span class="hs-comment">-- $ajaxCSRFOverview</span><span>
</span><a name="line-1514"></a><span class="hs-comment">-- When a user has authenticated with your site, all requests made from the browser to your server will include the session information that you use to verify that the user is logged in.</span><span>
</span><a name="line-1515"></a><span class="hs-comment">-- Unfortunately, this allows attackers to make unwanted requests on behalf of the user by e.g. submitting an HTTP request to your site when the user visits theirs.</span><span>
</span><a name="line-1516"></a><span class="hs-comment">-- This is known as a &lt;https://en.wikipedia.org/wiki/Cross-site_request_forgery Cross Site Request Forgery&gt; (CSRF) attack.</span><span>
</span><a name="line-1517"></a><span class="hs-comment">--</span><span>
</span><a name="line-1518"></a><span class="hs-comment">-- To combat this attack, you need a way to verify that the request is valid.</span><span>
</span><a name="line-1519"></a><span class="hs-comment">-- This is achieved by generating a random string (&quot;token&quot;), storing it in your encrypted session so that the server can look it up (see 'reqToken'), and adding the token to HTTP requests made to your server.</span><span>
</span><a name="line-1520"></a><span class="hs-comment">-- When a request comes in, the token in the request is compared to the one from the encrypted session. If they match, you can be sure the request is valid.</span><span>
</span><a name="line-1521"></a><span class="hs-comment">--</span><span>
</span><a name="line-1522"></a><span class="hs-comment">-- Yesod implements this behavior in two ways:</span><span>
</span><a name="line-1523"></a><span class="hs-comment">--</span><span>
</span><a name="line-1524"></a><span class="hs-comment">-- (1) The yesod-form package &lt;http://www.yesodweb.com/book/forms#forms_running_forms stores the CSRF token in a hidden field&gt; in the form, then validates it with functions like 'Yesod.Form.Functions.runFormPost'.</span><span>
</span><a name="line-1525"></a><span class="hs-comment">--</span><span>
</span><a name="line-1526"></a><span class="hs-comment">-- (2) Yesod can store the CSRF token in a cookie which is accessible by Javascript. Requests made by Javascript can lookup this cookie and add it as a header to requests. The server then checks the token in the header against the one in the encrypted session.</span><span>
</span><a name="line-1527"></a><span class="hs-comment">--</span><span>
</span><a name="line-1528"></a><span class="hs-comment">-- The form-based approach has the advantage of working for users with Javascript disabled, while adding the token to the headers with Javascript allows things like submitting JSON or binary data in AJAX requests. Yesod supports checking for a CSRF token in either the POST parameters of the form ('checkCsrfParamNamed'), the headers ('checkCsrfHeaderNamed'), or both options ('checkCsrfHeaderOrParam').</span><span>
</span><a name="line-1529"></a><span class="hs-comment">--</span><span>
</span><a name="line-1530"></a><span class="hs-comment">-- The easiest way to check both sources is to add the 'Yesod.Core.defaultCsrfMiddleware' to your Yesod Middleware.</span><span>
</span><a name="line-1531"></a><span class="hs-comment">--</span><span>
</span><a name="line-1532"></a><span class="hs-comment">-- === Opting-out of CSRF checking for specific routes</span><span>
</span><a name="line-1533"></a><span class="hs-comment">--</span><span>
</span><a name="line-1534"></a><span class="hs-comment">-- (Note: this code is generic to opting out of any Yesod middleware)</span><span>
</span><a name="line-1535"></a><span class="hs-comment">--</span><span>
</span><a name="line-1536"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-1537"></a><span class="hs-comment">-- 'yesodMiddleware' app = do</span><span>
</span><a name="line-1538"></a><span class="hs-comment">--   maybeRoute &lt;- 'getCurrentRoute'</span><span>
</span><a name="line-1539"></a><span class="hs-comment">--   let dontCheckCsrf = case maybeRoute of</span><span>
</span><a name="line-1540"></a><span class="hs-comment">--                         Just HomeR                     -&gt; True  -- Don't check HomeR</span><span>
</span><a name="line-1541"></a><span class="hs-comment">--                         Nothing                        -&gt; True  -- Don't check for 404s</span><span>
</span><a name="line-1542"></a><span class="hs-comment">--                         _                              -&gt; False -- Check other routes</span><span>
</span><a name="line-1543"></a><span class="hs-comment">--</span><span>
</span><a name="line-1544"></a><span class="hs-comment">--   'defaultYesodMiddleware' $ 'defaultCsrfSetCookieMiddleware' $ (if dontCheckCsrf then 'id' else 'defaultCsrfCheckMiddleware') $ app</span><span>
</span><a name="line-1545"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-1546"></a><span class="hs-comment">--</span><span>
</span><a name="line-1547"></a><span class="hs-comment">-- This can also be implemented using the 'csrfCheckMiddleware' function.</span><span>
</span><a name="line-1548"></a><span>
</span><a name="line-1549"></a><span class="hs-comment">-- | The default cookie name for the CSRF token (&quot;XSRF-TOKEN&quot;).</span><span>
</span><a name="line-1550"></a><span class="hs-comment">--</span><span>
</span><a name="line-1551"></a><span class="hs-comment">-- @since 1.4.14</span><span>
</span><a name="line-1552"></a><span class="hs-identifier">defaultCsrfCookieName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span>
</span><a name="line-1553"></a><a name="defaultCsrfCookieName"><a href="Yesod.Core.Handler.html#defaultCsrfCookieName"><span class="hs-identifier">defaultCsrfCookieName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;XSRF-TOKEN&quot;</span><span>
</span><a name="line-1554"></a><span>
</span><a name="line-1555"></a><span class="hs-comment">-- | Sets a cookie with a CSRF token, using 'defaultCsrfCookieName' for the cookie name.</span><span>
</span><a name="line-1556"></a><span class="hs-comment">--</span><span>
</span><a name="line-1557"></a><span class="hs-comment">-- The cookie's path is set to @/@, making it valid for your whole website.</span><span>
</span><a name="line-1558"></a><span class="hs-comment">--</span><span>
</span><a name="line-1559"></a><span class="hs-comment">-- @since 1.4.14</span><span>
</span><a name="line-1560"></a><span class="hs-identifier">setCsrfCookie</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219466"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219466"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1561"></a><a name="setCsrfCookie"><a href="Yesod.Core.Handler.html#setCsrfCookie"><span class="hs-identifier">setCsrfCookie</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#setCsrfCookieWithCookie"><span class="hs-identifier hs-var">setCsrfCookieWithCookie</span></a><span> </span><span class="hs-identifier hs-var">defaultSetCookie</span><span>
</span><a name="line-1562"></a><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">setCookieName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#defaultCsrfCookieName"><span class="hs-identifier hs-var">defaultCsrfCookieName</span></a><span>
</span><a name="line-1563"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">setCookiePath</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;/&quot;</span><span>
</span><a name="line-1564"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-1565"></a><span>
</span><a name="line-1566"></a><span class="hs-comment">-- | Takes a 'SetCookie' and overrides its value with a CSRF token, then sets the cookie.</span><span>
</span><a name="line-1567"></a><span class="hs-comment">--</span><span>
</span><a name="line-1568"></a><span class="hs-comment">-- Make sure to set the 'setCookiePath' to the root path of your application, otherwise you'll generate a new CSRF token for every path of your app. If your app is run from from e.g. www.example.com\/app1, use @app1@. The vast majority of sites will just use @/@.</span><span>
</span><a name="line-1569"></a><span class="hs-comment">--</span><span>
</span><a name="line-1570"></a><span class="hs-comment">-- @since 1.4.14</span><span>
</span><a name="line-1571"></a><span class="hs-identifier">setCsrfCookieWithCookie</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219465"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">SetCookie</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219465"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1572"></a><a name="setCsrfCookieWithCookie"><a href="Yesod.Core.Handler.html#setCsrfCookieWithCookie"><span class="hs-identifier">setCsrfCookieWithCookie</span></a></a><span> </span><a name="local-6989586621679221108"><a href="#local-6989586621679221108"><span class="hs-identifier">cookie</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1573"></a><span>    </span><a name="local-6989586621679221109"><a href="#local-6989586621679221109"><span class="hs-identifier">mCsrfToken</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">reqToken</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#getRequest"><span class="hs-identifier hs-var">getRequest</span></a><span>
</span><a name="line-1574"></a><span>    </span><span class="hs-identifier hs-var">Fold.forM_</span><span> </span><a href="#local-6989586621679221109"><span class="hs-identifier hs-var">mCsrfToken</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679221110"><a href="#local-6989586621679221110"><span class="hs-identifier">token</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Core.Handler.html#setCookie"><span class="hs-identifier hs-var">setCookie</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679221108"><span class="hs-identifier hs-var">cookie</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">setCookieValue</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><a href="#local-6989586621679221110"><span class="hs-identifier hs-var">token</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1575"></a><span>
</span><a name="line-1576"></a><span class="hs-comment">-- | The default header name for the CSRF token (&quot;X-XSRF-TOKEN&quot;).</span><span>
</span><a name="line-1577"></a><span class="hs-comment">--</span><span>
</span><a name="line-1578"></a><span class="hs-comment">-- @since 1.4.14</span><span>
</span><a name="line-1579"></a><span class="hs-identifier">defaultCsrfHeaderName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CI</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span>
</span><a name="line-1580"></a><a name="defaultCsrfHeaderName"><a href="Yesod.Core.Handler.html#defaultCsrfHeaderName"><span class="hs-identifier">defaultCsrfHeaderName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;X-XSRF-TOKEN&quot;</span><span>
</span><a name="line-1581"></a><span>
</span><a name="line-1582"></a><span class="hs-comment">-- | Takes a header name to lookup a CSRF token. If the value doesn't match the token stored in the session,</span><span>
</span><a name="line-1583"></a><span class="hs-comment">-- this function throws a 'PermissionDenied' error.</span><span>
</span><a name="line-1584"></a><span class="hs-comment">--</span><span>
</span><a name="line-1585"></a><span class="hs-comment">-- @since 1.4.14</span><span>
</span><a name="line-1586"></a><span class="hs-identifier">checkCsrfHeaderNamed</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219464"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CI</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219464"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1587"></a><a name="checkCsrfHeaderNamed"><a href="Yesod.Core.Handler.html#checkCsrfHeaderNamed"><span class="hs-identifier">checkCsrfHeaderNamed</span></a></a><span> </span><a name="local-6989586621679221111"><a href="#local-6989586621679221111"><span class="hs-identifier">headerName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1588"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679221112"><a href="#local-6989586621679221112"><span class="hs-identifier">valid</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679221113"><a href="#local-6989586621679221113"><span class="hs-identifier">mHeader</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#hasValidCsrfHeaderNamed%27"><span class="hs-identifier hs-var">hasValidCsrfHeaderNamed'</span></a><span> </span><a href="#local-6989586621679221111"><span class="hs-identifier hs-var">headerName</span></a><span>
</span><a name="line-1589"></a><span>  </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621679221112"><span class="hs-identifier hs-var">valid</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#permissionDenied"><span class="hs-identifier hs-var">permissionDenied</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Handler.html#csrfErrorMessage"><span class="hs-identifier hs-var">csrfErrorMessage</span></a><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Handler.html#CSRFHeader"><span class="hs-identifier hs-var">CSRFHeader</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decodeUtf8</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">original</span><span> </span><a href="#local-6989586621679221111"><span class="hs-identifier hs-var">headerName</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679221113"><span class="hs-identifier hs-var">mHeader</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1590"></a><span>
</span><a name="line-1591"></a><span class="hs-comment">-- | Takes a header name to lookup a CSRF token, and returns whether the value matches the token stored in the session.</span><span>
</span><a name="line-1592"></a><span class="hs-comment">--</span><span>
</span><a name="line-1593"></a><span class="hs-comment">-- @since 1.4.14</span><span>
</span><a name="line-1594"></a><span class="hs-identifier">hasValidCsrfHeaderNamed</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219463"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CI</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219463"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1595"></a><a name="hasValidCsrfHeaderNamed"><a href="Yesod.Core.Handler.html#hasValidCsrfHeaderNamed"><span class="hs-identifier">hasValidCsrfHeaderNamed</span></a></a><span> </span><a name="local-6989586621679221114"><a href="#local-6989586621679221114"><span class="hs-identifier">headerName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#hasValidCsrfHeaderNamed%27"><span class="hs-identifier hs-var">hasValidCsrfHeaderNamed'</span></a><span> </span><a href="#local-6989586621679221114"><span class="hs-identifier hs-var">headerName</span></a><span>
</span><a name="line-1596"></a><span>
</span><a name="line-1597"></a><span class="hs-comment">-- | Like 'hasValidCsrfHeaderNamed', but also returns the header value to be used in error messages.</span><span>
</span><a name="line-1598"></a><span class="hs-identifier">hasValidCsrfHeaderNamed'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219462"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CI</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219462"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-1599"></a><a name="hasValidCsrfHeaderNamed%27"><a href="Yesod.Core.Handler.html#hasValidCsrfHeaderNamed%27"><span class="hs-identifier">hasValidCsrfHeaderNamed'</span></a></a><span> </span><a name="local-6989586621679221115"><a href="#local-6989586621679221115"><span class="hs-identifier">headerName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1600"></a><span>  </span><a name="local-6989586621679221116"><a href="#local-6989586621679221116"><span class="hs-identifier">mCsrfToken</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">reqToken</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#getRequest"><span class="hs-identifier hs-var">getRequest</span></a><span>
</span><a name="line-1601"></a><span>  </span><a name="local-6989586621679221117"><a href="#local-6989586621679221117"><span class="hs-identifier">mXsrfHeader</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#lookupHeader"><span class="hs-identifier hs-var">lookupHeader</span></a><span> </span><a href="#local-6989586621679221115"><span class="hs-identifier hs-var">headerName</span></a><span>
</span><a name="line-1602"></a><span>
</span><a name="line-1603"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#validCsrf"><span class="hs-identifier hs-var">validCsrf</span></a><span> </span><a href="#local-6989586621679221116"><span class="hs-identifier hs-var">mCsrfToken</span></a><span> </span><a href="#local-6989586621679221117"><span class="hs-identifier hs-var">mXsrfHeader</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">decodeUtf8</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679221117"><span class="hs-identifier hs-var">mXsrfHeader</span></a><span class="hs-special">)</span><span>
</span><a name="line-1604"></a><span>
</span><a name="line-1605"></a><span class="hs-comment">-- CSRF Parameter checking</span><span>
</span><a name="line-1606"></a><span>
</span><a name="line-1607"></a><span class="hs-comment">-- | The default parameter name for the CSRF token (&quot;_token&quot;)</span><span>
</span><a name="line-1608"></a><span class="hs-comment">--</span><span>
</span><a name="line-1609"></a><span class="hs-comment">-- @since 1.4.14</span><span>
</span><a name="line-1610"></a><span class="hs-identifier">defaultCsrfParamName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-1611"></a><a name="defaultCsrfParamName"><a href="Yesod.Core.Handler.html#defaultCsrfParamName"><span class="hs-identifier">defaultCsrfParamName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;_token&quot;</span><span>
</span><a name="line-1612"></a><span>
</span><a name="line-1613"></a><span class="hs-comment">-- | Takes a POST parameter name to lookup a CSRF token. If the value doesn't match the token stored in the session,</span><span>
</span><a name="line-1614"></a><span class="hs-comment">-- this function throws a 'PermissionDenied' error.</span><span>
</span><a name="line-1615"></a><span class="hs-comment">--</span><span>
</span><a name="line-1616"></a><span class="hs-comment">-- @since 1.4.14</span><span>
</span><a name="line-1617"></a><span class="hs-identifier">checkCsrfParamNamed</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219461"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219461"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1618"></a><a name="checkCsrfParamNamed"><a href="Yesod.Core.Handler.html#checkCsrfParamNamed"><span class="hs-identifier">checkCsrfParamNamed</span></a></a><span> </span><a name="local-6989586621679221118"><a href="#local-6989586621679221118"><span class="hs-identifier">paramName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1619"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679221119"><a href="#local-6989586621679221119"><span class="hs-identifier">valid</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679221120"><a href="#local-6989586621679221120"><span class="hs-identifier">mParam</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#hasValidCsrfParamNamed%27"><span class="hs-identifier hs-var">hasValidCsrfParamNamed'</span></a><span> </span><a href="#local-6989586621679221118"><span class="hs-identifier hs-var">paramName</span></a><span>
</span><a name="line-1620"></a><span>  </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621679221119"><span class="hs-identifier hs-var">valid</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#permissionDenied"><span class="hs-identifier hs-var">permissionDenied</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Handler.html#csrfErrorMessage"><span class="hs-identifier hs-var">csrfErrorMessage</span></a><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Handler.html#CSRFParam"><span class="hs-identifier hs-var">CSRFParam</span></a><span> </span><a href="#local-6989586621679221118"><span class="hs-identifier hs-var">paramName</span></a><span> </span><a href="#local-6989586621679221120"><span class="hs-identifier hs-var">mParam</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1621"></a><span>
</span><a name="line-1622"></a><span class="hs-comment">-- | Takes a POST parameter name to lookup a CSRF token, and returns whether the value matches the token stored in the session.</span><span>
</span><a name="line-1623"></a><span class="hs-comment">--</span><span>
</span><a name="line-1624"></a><span class="hs-comment">-- @since 1.4.14</span><span>
</span><a name="line-1625"></a><span class="hs-identifier">hasValidCsrfParamNamed</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219460"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219460"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1626"></a><a name="hasValidCsrfParamNamed"><a href="Yesod.Core.Handler.html#hasValidCsrfParamNamed"><span class="hs-identifier">hasValidCsrfParamNamed</span></a></a><span> </span><a name="local-6989586621679221121"><a href="#local-6989586621679221121"><span class="hs-identifier">paramName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#hasValidCsrfParamNamed%27"><span class="hs-identifier hs-var">hasValidCsrfParamNamed'</span></a><span> </span><a href="#local-6989586621679221121"><span class="hs-identifier hs-var">paramName</span></a><span>
</span><a name="line-1627"></a><span>
</span><a name="line-1628"></a><span class="hs-comment">-- | Like 'hasValidCsrfParamNamed', but also returns the param value to be used in error messages.</span><span>
</span><a name="line-1629"></a><span class="hs-identifier">hasValidCsrfParamNamed'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219459"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219459"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-1630"></a><a name="hasValidCsrfParamNamed%27"><a href="Yesod.Core.Handler.html#hasValidCsrfParamNamed%27"><span class="hs-identifier">hasValidCsrfParamNamed'</span></a></a><span> </span><a name="local-6989586621679221122"><a href="#local-6989586621679221122"><span class="hs-identifier">paramName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1631"></a><span>  </span><a name="local-6989586621679221123"><a href="#local-6989586621679221123"><span class="hs-identifier">mCsrfToken</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">reqToken</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Yesod.Core.Handler.html#getRequest"><span class="hs-identifier hs-var">getRequest</span></a><span>
</span><a name="line-1632"></a><span>  </span><a name="local-6989586621679221124"><a href="#local-6989586621679221124"><span class="hs-identifier">mCsrfParam</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#lookupPostParam"><span class="hs-identifier hs-var">lookupPostParam</span></a><span> </span><a href="#local-6989586621679221122"><span class="hs-identifier hs-var">paramName</span></a><span>
</span><a name="line-1633"></a><span>
</span><a name="line-1634"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Handler.html#validCsrf"><span class="hs-identifier hs-var">validCsrf</span></a><span> </span><a href="#local-6989586621679221123"><span class="hs-identifier hs-var">mCsrfToken</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679221124"><span class="hs-identifier hs-var">mCsrfParam</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679221124"><span class="hs-identifier hs-var">mCsrfParam</span></a><span class="hs-special">)</span><span>
</span><a name="line-1635"></a><span>
</span><a name="line-1636"></a><span class="hs-comment">-- | Checks that a valid CSRF token is present in either the request headers or POST parameters.</span><span>
</span><a name="line-1637"></a><span class="hs-comment">-- If the value doesn't match the token stored in the session, this function throws a 'PermissionDenied' error.</span><span>
</span><a name="line-1638"></a><span class="hs-comment">--</span><span>
</span><a name="line-1639"></a><span class="hs-comment">-- @since 1.4.14</span><span>
</span><a name="line-1640"></a><span class="hs-identifier">checkCsrfHeaderOrParam</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219458"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadLogger</span><span> </span><a href="#local-6989586621679219458"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1641"></a><span>                       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CI</span><span> </span><span class="hs-identifier hs-type">S8.ByteString</span><span> </span><span class="hs-comment">-- ^ The header name to lookup the CSRF token</span><span>
</span><a name="line-1642"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-comment">-- ^ The POST parameter name to lookup the CSRF token</span><span>
</span><a name="line-1643"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679219458"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1644"></a><a name="checkCsrfHeaderOrParam"><a href="Yesod.Core.Handler.html#checkCsrfHeaderOrParam"><span class="hs-identifier">checkCsrfHeaderOrParam</span></a></a><span> </span><a name="local-6989586621679221125"><a href="#local-6989586621679221125"><span class="hs-identifier">headerName</span></a></a><span> </span><a name="local-6989586621679221126"><a href="#local-6989586621679221126"><span class="hs-identifier">paramName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1645"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679221127"><a href="#local-6989586621679221127"><span class="hs-identifier">validHeader</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679221128"><a href="#local-6989586621679221128"><span class="hs-identifier">mHeader</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#hasValidCsrfHeaderNamed%27"><span class="hs-identifier hs-var">hasValidCsrfHeaderNamed'</span></a><span> </span><a href="#local-6989586621679221125"><span class="hs-identifier hs-var">headerName</span></a><span>
</span><a name="line-1646"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679221129"><a href="#local-6989586621679221129"><span class="hs-identifier">validParam</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679221130"><a href="#local-6989586621679221130"><span class="hs-identifier">mParam</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Yesod.Core.Handler.html#hasValidCsrfParamNamed%27"><span class="hs-identifier hs-var">hasValidCsrfParamNamed'</span></a><span> </span><a href="#local-6989586621679221126"><span class="hs-identifier hs-var">paramName</span></a><span>
</span><a name="line-1647"></a><span>  </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679221127"><span class="hs-identifier hs-var">validHeader</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679221129"><span class="hs-identifier hs-var">validParam</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1648"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679221131"><a href="#local-6989586621679221131"><span class="hs-identifier">errorMessage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Handler.html#csrfErrorMessage"><span class="hs-identifier hs-var">csrfErrorMessage</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Handler.html#CSRFHeader"><span class="hs-identifier hs-var">CSRFHeader</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decodeUtf8</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">original</span><span> </span><a href="#local-6989586621679221125"><span class="hs-identifier hs-var">headerName</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679221128"><span class="hs-identifier hs-var">mHeader</span></a><span class="hs-special">,</span><span> </span><a href="Yesod.Core.Handler.html#CSRFParam"><span class="hs-identifier hs-var">CSRFParam</span></a><span> </span><a href="#local-6989586621679221126"><span class="hs-identifier hs-var">paramName</span></a><span> </span><a href="#local-6989586621679221130"><span class="hs-identifier hs-var">mParam</span></a><span class="hs-special">]</span><span>
</span><a name="line-1649"></a><span>    </span><span class="">$logWarnS</span><span> </span><span class="hs-string">&quot;yesod-core&quot;</span><span> </span><a href="#local-6989586621679221131"><span class="hs-identifier hs-var">errorMessage</span></a><span>
</span><a name="line-1650"></a><span>    </span><a href="Yesod.Core.Handler.html#permissionDenied"><span class="hs-identifier hs-var">permissionDenied</span></a><span> </span><a href="#local-6989586621679221131"><span class="hs-identifier hs-var">errorMessage</span></a><span>
</span><a name="line-1651"></a><span>
</span><a name="line-1652"></a><span class="hs-identifier">validCsrf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">S.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1653"></a><span class="hs-comment">-- It's important to use constant-time comparison (constEq) in order to avoid timing attacks.</span><span>
</span><a name="line-1654"></a><a name="validCsrf"><a href="Yesod.Core.Handler.html#validCsrf"><span class="hs-identifier">validCsrf</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679221137"><a href="#local-6989586621679221137"><span class="hs-identifier">token</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679221138"><a href="#local-6989586621679221138"><span class="hs-identifier">param</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">encodeUtf8</span><span> </span><a href="#local-6989586621679221137"><span class="hs-identifier hs-var">token</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">constEq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679221138"><span class="hs-identifier hs-var">param</span></a><span>
</span><a name="line-1655"></a><span class="hs-identifier">validCsrf</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>            </span><a name="local-6989586621679221378"><a href="#local-6989586621679221378"><span class="hs-identifier">_param</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1656"></a><span class="hs-identifier">validCsrf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679221379"><a href="#local-6989586621679221379"><span class="hs-identifier">_token</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1657"></a><span>
</span><a name="line-1658"></a><span class="hs-keyword">data</span><span> </span><a name="CSRFExpectation"><a href="Yesod.Core.Handler.html#CSRFExpectation"><span class="hs-identifier">CSRFExpectation</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CSRFHeader"><a href="Yesod.Core.Handler.html#CSRFHeader"><span class="hs-identifier">CSRFHeader</span></a></a><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Key/Value</span><span>
</span><a name="line-1659"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a name="CSRFParam"><a href="Yesod.Core.Handler.html#CSRFParam"><span class="hs-identifier">CSRFParam</span></a></a><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Key/Value</span><span>
</span><a name="line-1660"></a><span>
</span><a name="line-1661"></a><span class="hs-identifier">csrfErrorMessage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Yesod.Core.Handler.html#CSRFExpectation"><span class="hs-identifier hs-type">CSRFExpectation</span></a><span class="hs-special">]</span><span>
</span><a name="line-1662"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-comment">-- ^ Error message</span><span>
</span><a name="line-1663"></a><a name="csrfErrorMessage"><a href="Yesod.Core.Handler.html#csrfErrorMessage"><span class="hs-identifier">csrfErrorMessage</span></a></a><span> </span><a name="local-6989586621679221380"><a href="#local-6989586621679221380"><span class="hs-identifier">expectedLocations</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">T.intercalate</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span>
</span><a name="line-1664"></a><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;A valid CSRF token wasn't present. Because the request could have been forged, it's been rejected altogether.&quot;</span><span>
</span><a name="line-1665"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;If you're a developer of this site, these tips will help you debug the issue:&quot;</span><span>
</span><a name="line-1666"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;- Read the Yesod.Core.Handler docs of the yesod-core package for details on CSRF protection.&quot;</span><span>
</span><a name="line-1667"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;- Check that your HTTP client is persisting cookies between requests, like a browser does.&quot;</span><span>
</span><a name="line-1668"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;- By default, the CSRF token is sent to the client in a cookie named &quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">decodeUtf8</span><span> </span><a href="Yesod.Core.Handler.html#defaultCsrfCookieName"><span class="hs-identifier hs-var">defaultCsrfCookieName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-string">&quot;.&quot;</span><span>
</span><a name="line-1669"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;- The server is looking for the token in the following locations:\n&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">T.intercalate</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679221381"><span class="hs-identifier hs-var">csrfLocation</span></a><span> </span><a href="#local-6989586621679221380"><span class="hs-identifier hs-var">expectedLocations</span></a><span class="hs-special">)</span><span>
</span><a name="line-1670"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-1671"></a><span>
</span><a name="line-1672"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679221381"><a href="#local-6989586621679221381"><span class="hs-identifier">csrfLocation</span></a></a><span> </span><a name="local-6989586621679221383"><a href="#local-6989586621679221383"><span class="hs-identifier">expected</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679221383"><span class="hs-identifier hs-var">expected</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1673"></a><span>          </span><a href="Yesod.Core.Handler.html#CSRFHeader"><span class="hs-identifier hs-var">CSRFHeader</span></a><span> </span><a name="local-6989586621679221384"><a href="#local-6989586621679221384"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679221385"><a href="#local-6989586621679221385"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">T.intercalate</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;  - An HTTP header named&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679221384"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679221382"><span class="hs-identifier hs-var">formatValue</span></a><span> </span><a href="#local-6989586621679221385"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1674"></a><span>          </span><a href="Yesod.Core.Handler.html#CSRFParam"><span class="hs-identifier hs-var">CSRFParam</span></a><span> </span><a name="local-6989586621679221386"><a href="#local-6989586621679221386"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679221387"><a href="#local-6989586621679221387"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">T.intercalate</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;  - A POST parameter named&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679221386"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679221382"><span class="hs-identifier hs-var">formatValue</span></a><span> </span><a href="#local-6989586621679221387"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1675"></a><span>
</span><a name="line-1676"></a><span>        </span><span class="hs-identifier">formatValue</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-1677"></a><span>        </span><a name="local-6989586621679221382"><a href="#local-6989586621679221382"><span class="hs-identifier">formatValue</span></a></a><span> </span><a name="local-6989586621679221388"><a href="#local-6989586621679221388"><span class="hs-identifier">maybeText</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679221388"><span class="hs-identifier hs-var">maybeText</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1678"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;(which is not currently set)&quot;</span><span>
</span><a name="line-1679"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679221389"><a href="#local-6989586621679221389"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">T.concat</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;(which has the current, incorrect value: '&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679221389"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;')&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1680"></a><span>
</span><a name="line-1681"></a><span class="hs-identifier">getSubYesod</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219457"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219457"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#SubHandlerSite"><span class="hs-identifier hs-type">SubHandlerSite</span></a><span> </span><a href="#local-6989586621679219457"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1682"></a><a name="getSubYesod"><a href="Yesod.Core.Handler.html#getSubYesod"><span class="hs-identifier">getSubYesod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Class.Handler.html#liftSubHandler"><span class="hs-identifier hs-var">liftSubHandler</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#SubHandlerFor"><span class="hs-identifier hs-var">SubHandlerFor</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">rheChild</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">handlerEnv</span><span>
</span><a name="line-1683"></a><span>
</span><a name="line-1684"></a><span class="hs-identifier">getRouteToParent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219456"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219456"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#SubHandlerSite"><span class="hs-identifier hs-type">SubHandlerSite</span></a><span> </span><a href="#local-6989586621679219456"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#HandlerSite"><span class="hs-identifier hs-type">HandlerSite</span></a><span> </span><a href="#local-6989586621679219456"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1685"></a><a name="getRouteToParent"><a href="Yesod.Core.Handler.html#getRouteToParent"><span class="hs-identifier">getRouteToParent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Class.Handler.html#liftSubHandler"><span class="hs-identifier hs-var">liftSubHandler</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#SubHandlerFor"><span class="hs-identifier hs-var">SubHandlerFor</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">rheRouteToMaster</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">handlerEnv</span><span>
</span><a name="line-1686"></a><span>
</span><a name="line-1687"></a><span class="hs-identifier">getSubCurrentRoute</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Yesod.Core.Class.Handler.html#MonadHandler"><span class="hs-identifier hs-type">MonadHandler</span></a><span> </span><a href="#local-6989586621679219455"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679219455"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Yesod.Routes.Class.html#Route"><span class="hs-identifier hs-type">Route</span></a><span> </span><span class="hs-special">(</span><a href="Yesod.Core.Class.Handler.html#SubHandlerSite"><span class="hs-identifier hs-type">SubHandlerSite</span></a><span> </span><a href="#local-6989586621679219455"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1688"></a><a name="getSubCurrentRoute"><a href="Yesod.Core.Handler.html#getSubCurrentRoute"><span class="hs-identifier">getSubCurrentRoute</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Yesod.Core.Class.Handler.html#liftSubHandler"><span class="hs-identifier hs-var">liftSubHandler</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Yesod.Core.Types.html#SubHandlerFor"><span class="hs-identifier hs-var">SubHandlerFor</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">rheRoute</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">handlerEnv</span><span>
</span><a name="line-1689"></a></pre></body></html>